<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Spellshape - Workbench (Debug)</title>

  <script type="importmap">
    {
      "imports": {
        "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js",
        "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/"
      }
    }
  </script>

  <style>
    :root {
      --bg: #09090b;
      --panel: #18181b;
      --card: #27272a;
      --border: #3f3f46;
      --accent: #8b5cf6;
      --text: #e4e4e7;
      --text-dim: #a1a1aa;
      --danger: #ef4444;
    }

    * { box-sizing: border-box; user-select: none; }
    body { margin: 0; overflow: hidden; background: var(--bg); font-family: 'Inter', system-ui, sans-serif; color: var(--text); font-size: 12px; }
    .app { display: flex; height: 100vh; width: 100vw; }

    .toolbox { width: 180px; background: var(--panel); border-right: 1px solid var(--border); display: flex; flex-direction: column; z-index: 10; }
    .toolbox-header { padding: 12px; border-bottom: 1px solid var(--border); font-weight: 700; color: var(--text-dim); font-size: 10px; }
    .tool-list { padding: 10px; overflow-y: auto; flex: 1; }
    .tool-category { margin-bottom: 16px; }
    .tool-category-title { font-size: 9px; color: #666; margin-bottom: 6px; text-transform: uppercase; }
    .tool-item { background: var(--card); border: 1px solid var(--border); padding: 8px; margin-bottom: 6px; border-radius: 4px; cursor: grab; font-size: 11px; transition: all 0.2s; display: flex; align-items: center; gap: 6px; }
    .tool-item:hover { border-color: var(--accent); color: #fff; }
    .tool-icon { width: 6px; height: 6px; border-radius: 50%; background: var(--accent); }

    .timeline-sidebar { width: 360px; background: var(--bg); border-right: 1px solid var(--border); display: flex; flex-direction: column; }
    .timeline-header { padding: 14px; background: var(--panel); border-bottom: 1px solid var(--border); }
    .brand { font-size: 13px; font-weight: 700; color: #fff; margin-bottom: 8px; }
    .schema-select { width: 100%; padding: 6px; background: #111; color: #ccc; border: 1px solid #333; border-radius: 4px; font-size: 11px; cursor: pointer; }
    .timeline-content { flex: 1; overflow-y: auto; padding: 16px; position: relative; }
    .timeline-content::before { content: ''; position: absolute; top: 16px; bottom: 16px; left: 29px; width: 1px; background: var(--border); z-index: 0; }

    .step-card { background: var(--card); border: 1px solid var(--border); border-radius: 6px; margin-bottom: 12px; position: relative; z-index: 1; cursor: pointer; }
    .step-card:hover { border-color: var(--text-dim); }
    .step-card.selected { border-color: var(--accent); box-shadow: 0 0 0 1px var(--accent); }
    .step-num { position: absolute; left: -23px; top: 10px; width: 18px; height: 18px; background: var(--panel); border: 1px solid var(--text-dim); border-radius: 50%; font-size: 9px; font-weight: 700; display: flex; align-items: center; justify-content: center; z-index: 2; }
    .step-header { padding: 10px 12px; display: flex; justify-content: space-between; align-items: center; }
    .step-title { font-weight: 600; font-size: 11px; }
    .step-type { font-family: monospace; font-size: 9px; color: var(--accent); background: rgba(139, 92, 246, 0.1); padding: 1px 4px; border-radius: 3px; }
    .drop-zone { height: 3px; margin: 6px 0; border-radius: 2px; transition: all 0.2s; }
    .drop-zone.active { height: 18px; background: rgba(139, 92, 246, 0.1); border: 1px dashed var(--accent); }

    .viewport { flex: 1; position: relative; background: radial-gradient(circle at center, #18181b 0%, #09090b 100%); }
    canvas { display: block; width: 100%; height: 100%; }

    .debug-panel {
      position: absolute;
      bottom: 20px;
      left: 20px;
      width: 360px;
      max-height: 200px;
      background: rgba(0, 0, 0, 0.95);
      border: 1px solid #22c55e;
      border-radius: 6px;
      padding: 12px;
      font-family: 'Courier New', monospace;
      font-size: 10px;
      color: #22c55e;
      overflow-y: auto;
      z-index: 100;
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .debug-line { white-space: pre-wrap; word-break: break-all; opacity: 0.9; }
    .debug-line.error { color: #ef4444; }
    .debug-line.success { color: #22c55e; }
    .debug-line.warn { color: #f59e0b; }
    .debug-line.action { color: #60a5fa; font-weight: bold; }

    .inspector { width: 340px; background: var(--panel); border-left: 1px solid var(--border); display: flex; flex-direction: column; }
    .inspector-header { padding: 12px; border-bottom: 1px solid var(--border); font-weight: 700; font-size: 11px; }
    .inspector-content { padding: 14px; flex: 1; overflow-y: auto; }

    .prop-group { margin-bottom: 14px; }
    .prop-label { font-size: 10px; font-weight: 600; color: var(--text-dim); margin-bottom: 4px; display: block; }
    .prop-input { width: 100%; background: #111; border: 1px solid var(--border); color: #fff; padding: 6px; border-radius: 4px; font-family: monospace; font-size: 10px; }
    .prop-input:focus { border-color: var(--accent); outline: none; }
    .btn-danger { width: 100%; padding: 6px; background: rgba(239, 68, 68, 0.1); color: var(--danger); border: 1px solid var(--danger); border-radius: 4px; cursor: pointer; margin-top: 16px; font-size: 10px; }

    .json-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.95); z-index: 50; display: none; flex-direction: column; }
    .json-overlay.open { display: flex; }
    textarea.full-code { flex: 1; background: transparent; color: #0f0; border: none; padding: 16px; font-family: monospace; resize: none; font-size: 11px; }
  </style>
</head>
<body>

  <div class="app">
    <div class="toolbox">
      <div class="toolbox-header">HELPERS LIBRARY</div>
      <div class="tool-list" id="tool-list"></div>
    </div>

    <div class="timeline-sidebar">
      <div class="timeline-header">
        <div class="brand">Spellshape Workbench</div>
        <select class="schema-select" onchange="window.loadSchema(this.value)">
          <option value="schema1">Logic Tower</option>
          <option value="schema2">Noise Column</option>
        </select>
      </div>
      <div class="timeline-content" id="timeline" ondragover="dragOver(event)" ondrop="drop(event)"></div>
      <div style="padding: 10px; border-top: 1px solid #333;">
        <button onclick="window.toggleJson()" style="width: 100%; padding: 6px; background: #222; color: #888; border: 1px solid #333; border-radius: 4px; cursor: pointer; font-size: 10px;">View JSON</button>
      </div>
    </div>

    <div class="viewport">
      <canvas id="gl"></canvas>
      <div class="debug-panel" id="debug-panel"></div>
    </div>

    <div class="inspector">
      <div class="inspector-header">STEP PARAMETERS</div>
      <div class="inspector-content" id="inspector-content">
        <div style="color: #666; font-style: italic; text-align: center; margin-top: 30px;">
          Select a step to edit
        </div>
      </div>
    </div>

    <div class="json-overlay" id="json-overlay">
      <div style="padding: 10px; border-bottom: 1px solid #333; display: flex; justify-content: space-between;">
        <span style="color: #fff; font-weight: bold; font-size: 11px;">SCHEMA SOURCE</span>
        <button onclick="window.toggleJson()" style="background: #333; color: #fff; border: none; padding: 3px 8px; cursor: pointer; font-size: 10px;">Close</button>
      </div>
      <textarea id="json-input" class="full-code" spellcheck="false"></textarea>
      <button onclick="window.updateFromJSON()" style="padding: 10px; background: #6d28d9; color: #fff; border: none; font-weight: bold; cursor: pointer; font-size: 10px;">UPDATE</button>
    </div>
  </div>

  <script type="module">
    import * as THREE from 'three';
    import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
    import { ProceduralExecutor } from './src/modules/interpreter/procedural-executor.js';

    const helpers = {
      'createBox': { category: 'Basic', params: { width: 1, height: 1, depth: 1, widthSegments: 1, heightSegments: 1, depthSegments: 1 } },
      'createCylinder': { category: 'Basic', params: { radiusTop: 1, radiusBottom: 1, height: 1, radialSegments: 32, heightSegments: 1 } },
      'distributeOnGrid3d': { category: 'Distribution', params: { geometry: null, rows: 3, cols: 3, spacing: [2, 0, 2], centered: true, autoMerge: true } },
      'loop': { category: 'Logic', params: { var: 'i', from: 0, to: 10, body: [] } },
    };

    const schemas = {
      schema1: {
        "version": "4.9", "intent": "Logic Tower",
        "globalParameters": { "floors": { "value": 15, "type": "integer", "min": 3, "max": 30 } },
        "actions": [ { "thought": "Create Slab", "do": "createBox", "params": { "width": 12, "height": 0.3, "depth": 12 }, "as": "slab" } ]
      },
      schema2: {
        "version": "4.9", "intent": "Noise Column",
        "globalParameters": { "layers": { "value": 50, "type": "integer", "min": 10, "max": 100 } },
        "actions": [ { "thought": "Base Slice", "do": "createBox", "params": { "width": 4, "height": 0.2, "depth": 4 }, "as": "slice" } ]
      }
    };

    let currentSchema = schemas.schema1;
    let selectedStepIndex = -1;
    let draggedItem = null;
    let currentMesh = null;
    const executor = new ProceduralExecutor();

    function updateDebugPanel() {
      const panel = document.getElementById('debug-panel');
      const messages = executor.debugLog || [];
      const lastMessages = messages.slice(-12);
      panel.innerHTML = lastMessages.map(msg => {
        let className = '';
        if (msg.includes('‚ùå')) className = 'error';
        else if (msg.includes('‚úì') || msg.includes('üíæ')) className = 'success';
        else if (msg.includes('‚ö†Ô∏è')) className = 'warn';
        else if (msg.includes('üí≠') || msg.includes('üîÅ')) className = 'action';
        return `<div class="debug-line ${className}">${msg}</div>`;
      }).join('');
    }

    function buildToolbox() {
      const list = document.getElementById('tool-list');
      list.innerHTML = '';
      const categories = {};
      for (const [name, info] of Object.entries(helpers)) {
        if (!categories[info.category]) categories[info.category] = [];
        categories[info.category].push(name);
      }
      for (const [cat, items] of Object.entries(categories)) {
        const catDiv = document.createElement('div');
        catDiv.className = 'tool-category';
        catDiv.innerHTML = `<div class="tool-category-title">${cat}</div>`;
        for (const item of items) {
          const tool = document.createElement('div');
          tool.className = 'tool-item';
          tool.draggable = true;
          tool.ondragstart = (e) => { draggedItem = { type: 'tool', tool: item }; e.dataTransfer.effectAllowed = 'copy'; };
          tool.innerHTML = `<div class="tool-icon"></div> ${item}`;
          catDiv.appendChild(tool);
        }
        list.appendChild(catDiv);
      }
    }

    function renderTimeline() {
      const container = document.getElementById('timeline');
      container.innerHTML = '';
      currentSchema.actions.forEach((action, index) => {
        const card = document.createElement('div');
        card.className = `step-card ${selectedStepIndex === index ? 'selected' : ''}`;
        card.draggable = true;
        card.onclick = () => { selectedStepIndex = index; renderTimeline(); renderInspector(); };
        card.innerHTML = `
          <div class="step-num">${index + 1}</div>
          <div class="step-header">
            <div class="step-title">${action.thought}</div>
            <div class="step-type">${action.do}</div>
          </div>
        `;
        container.appendChild(card);
      });
    }

    window.dragOver = (e) => e.preventDefault();
    window.drop = (e) => e.preventDefault();

    function renderInspector() {
      const container = document.getElementById('inspector-content');
      container.innerHTML = '';
      if (selectedStepIndex < 0) return;
      const action = currentSchema.actions[selectedStepIndex];
      container.innerHTML = `<p>Editing: ${action.thought}</p><p>Type: ${action.do}</p>`;
    }

    window.loadSchema = (k) => { currentSchema = schemas[k]; selectedStepIndex = -1; renderTimeline(); run(); };
    window.toggleJson = () => { document.getElementById('json-overlay').classList.toggle('open'); document.getElementById('json-input').value = JSON.stringify(currentSchema, null, 2); };
    window.updateFromJSON = () => {
      try { currentSchema = JSON.parse(document.getElementById('json-input').value); window.toggleJson(); renderTimeline(); run(); }
      catch(e) { alert('Invalid JSON'); }
    };

    const canvas = document.querySelector('#gl');
    const renderer = new THREE.WebGLRenderer({ canvas, antialias: true });
    const scene = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera(45, 1, 0.1, 1000);
    const controls = new OrbitControls(camera, canvas);
    renderer.setSize(canvas.clientWidth, canvas.clientHeight);
    camera.position.set(30, 30, 30);
    scene.background = new THREE.Color(0x09090b);
    scene.add(new THREE.AmbientLight(0xffffff, 0.6));
    const dirLight = new THREE.DirectionalLight(0xffffff, 1);
    dirLight.position.set(50, 100, 50);
    scene.add(dirLight);
    scene.add(new THREE.GridHelper(100, 20, 0x27272a, 0x18181b));

    function run() {
      if (currentMesh) scene.remove(currentMesh);
      const params = {};
      for (const [k, v] of Object.entries(currentSchema.globalParameters)) params[k] = v.value;
      try {
        currentMesh = executor.execute(currentSchema, params);
        scene.add(currentMesh);
        updateDebugPanel();
      } catch(e) {
        console.error(e);
        updateDebugPanel();
      }
    }

    function animate() { requestAnimationFrame(animate); controls.update(); renderer.render(scene, camera); }
    animate();

    buildToolbox();
    renderTimeline();
    run();

    window.onresize = () => {
      renderer.setSize(canvas.clientWidth, canvas.clientHeight);
      camera.aspect = canvas.clientWidth / canvas.clientHeight;
      camera.updateProjectionMatrix();
    };
  </script>
</body>
</html>