<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Spellshape - Procedural Timeline Editor</title>

  <script type="importmap">
    {
      "imports": {
        "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js",
        "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/"
      }
    }
  </script>

  <style>
    :root {
      --bg: #121214;
      --panel: #1c1c21;
      --card: #25252b;
      --card-hover: #2d2d33;
      --border: #333;
      --accent: #646cff;
      --text: #ececec;
      --text-dim: #888;
      --success: #4ade80;
      --error: #ff6464;
    }

    * { box-sizing: border-box; }
    body { margin: 0; overflow: hidden; background: var(--bg); font-family: 'Inter', system-ui, sans-serif; color: var(--text); }
    .app { display: flex; height: 100vh; width: 100vw; }

    .sidebar {
      flex: 0 0 500px;
      width: 500px;
      background: var(--panel);
      border-right: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      z-index: 10;
    }

    .header {
      padding: 16px 20px;
      border-bottom: 1px solid var(--border);
      background: var(--bg);
    }
    .header h1 { margin: 0; font-size: 14px; font-weight: 700; }

    .tabs { display: flex; padding: 0 20px; border-bottom: 1px solid var(--border); gap: 12px; overflow-x: auto; }
    .tab {
      padding: 10px 0;
      font-size: 10px; font-weight: 600; color: var(--text-dim);
      cursor: pointer; border-bottom: 2px solid transparent;
      transition: all 0.2s; white-space: nowrap;
    }
    .tab.active { color: var(--accent); border-bottom-color: var(--accent); }
    .tab:hover { color: #fff; }

    .content { flex: 1; overflow-y: auto; padding: 16px; display: none; }
    .content.active { display: block; }

    .globals-container { display: flex; flex-direction: column; gap: 12px; }
    .global-group { background: var(--card); border: 1px solid var(--border); border-radius: 6px; padding: 12px; }
    .global-header {
      display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;
      font-size: 11px; font-weight: 700; text-transform: uppercase; color: var(--text-dim);
    }
    .btn-add-global { width: 20px; height: 20px; background: rgba(100, 108, 255, 0.2); border: none; border-radius: 3px; color: var(--accent); cursor: pointer; font-weight: bold; }
    .btn-add-global:hover { background: rgba(100, 108, 255, 0.4); }

    .global-item {
      display: flex; gap: 8px; margin-bottom: 8px; align-items: center;
    }
    .global-item:last-child { margin-bottom: 0; }

    .global-slider-group {
      display: flex; flex-direction: column; gap: 4px; margin-top: 8px;
    }
    .slider-header { display: flex; justify-content: space-between; font-size: 10px; color: var(--text-dim); }
    .slider-value { color: var(--accent); font-family: monospace; font-weight: bold; }

    input[type="text"], input[type="number"], input[type="range"] {
      background: rgba(255,255,255,0.05); border: 1px solid var(--border); border-radius: 4px;
      padding: 6px 10px; color: var(--text); font-size: 11px;
    }
    input[type="text"]:focus, input[type="number"]:focus {
      outline: none; border-color: var(--accent);
    }

    input[type="range"] {
      padding: 0; height: 4px; cursor: pointer;
    }
    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none; appearance: none; width: 14px; height: 14px;
      border-radius: 50%; background: var(--accent); cursor: pointer;
    }
    input[type="range"]::-moz-range-thumb {
      width: 14px; height: 14px; border-radius: 50%; background: var(--accent); cursor: pointer;
    }

    .timeline { display: flex; flex-direction: column; gap: 12px; }

    .step-card {
      background: var(--card); border: 1px solid var(--border); border-radius: 6px;
      padding: 12px; position: relative; transition: all 0.2s;
    }
    .step-card:hover { background: var(--card-hover); border-color: var(--accent); }

    .step-header {
      display: flex; align-items: center; gap: 10px; margin-bottom: 10px; justify-content: space-between;
    }
    .step-num { width: 16px; height: 16px; background: #333; border-radius: 50%; font-size: 9px; font-weight: bold; color: #888; display: flex; align-items: center; justify-content: center; }
    .step-title-input {
      flex: 1; background: transparent; border: 1px solid transparent; padding: 4px 8px;
      color: var(--text); font-size: 12px; font-weight: 600; border-radius: 3px;
    }
    .step-title-input:hover { border-color: var(--border); }
    .step-title-input:focus { outline: none; border-color: var(--accent); background: rgba(100, 108, 255, 0.1); }

    .step-actions { display: flex; gap: 6px; }
    .step-btn { width: 22px; height: 22px; border: none; border-radius: 3px; cursor: pointer; font-size: 11px; font-weight: 600; display: flex; align-items: center; justify-content: center; transition: all 0.2s; }
    .step-btn-add { background: rgba(100, 108, 255, 0.2); color: var(--accent); }
    .step-btn-add:hover { background: rgba(100, 108, 255, 0.4); }
    .step-btn-remove { background: rgba(255, 100, 100, 0.2); color: var(--error); }
    .step-btn-remove:hover { background: rgba(255, 100, 100, 0.4); }

    .step-body { display: flex; flex-direction: column; gap: 8px; }

    .field-group { display: flex; flex-direction: column; gap: 4px; }
    .field-label { font-size: 10px; font-weight: 600; text-transform: uppercase; color: var(--text-dim); }

    .helper-select {
      background: rgba(255,255,255,0.05); border: 1px solid var(--border); border-radius: 4px;
      padding: 6px 10px; color: var(--text); font-size: 11px; cursor: pointer;
    }
    .helper-select:hover { border-color: var(--accent); }
    .helper-select:focus { outline: none; border-color: var(--accent); }

    textarea.expr-input {
      background: rgba(255,255,255,0.03); border: 1px solid var(--border); border-radius: 4px;
      padding: 6px 10px; color: var(--text); font-size: 10px; font-family: 'Courier New', monospace;
      resize: vertical; min-height: 40px; max-height: 80px;
    }
    textarea.expr-input:focus { outline: none; border-color: var(--accent); }

    .menu-overlay {
      position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: none; z-index: 1000;
    }
    .menu-overlay.active { display: block; }

    .menu-popup {
      position: fixed; background: var(--panel); border: 1px solid var(--border); border-radius: 8px;
      min-width: 200px; max-height: 400px; overflow-y: auto; z-index: 1001;
      box-shadow: 0 10px 40px rgba(0,0,0,0.5);
    }

    .menu-item {
      padding: 10px 16px; cursor: pointer; font-size: 11px; border-bottom: 1px solid rgba(255,255,255,0.05);
      transition: all 0.2s;
    }
    .menu-item:hover { background: rgba(100, 108, 255, 0.2); color: var(--accent); }
    .menu-item:last-child { border-bottom: none; }

    /* MATERIALS TAB */
    .materials-container { display: flex; flex-direction: column; gap: 12px; }
    .material-item {
      background: var(--card); border: 1px solid var(--border); border-radius: 6px;
      padding: 12px; display: flex; flex-direction: column; gap: 8px;
    }
    .material-item:hover { background: var(--card-hover); }

    .material-header { display: flex; justify-content: space-between; align-items: center; }
    .material-name { font-weight: 600; color: var(--text); font-size: 11px; }
    .material-actions { display: flex; gap: 6px; }
    .material-btn { padding: 4px 8px; background: rgba(100, 108, 255, 0.2); border: none; border-radius: 3px; color: var(--accent); cursor: pointer; font-size: 10px; }
    .material-btn:hover { background: rgba(100, 108, 255, 0.4); }
    .material-delete { background: rgba(255, 100, 100, 0.2); color: var(--error); }
    .material-delete:hover { background: rgba(255, 100, 100, 0.4); }

    /* JSON TAB */
    .json-container { display: flex; flex-direction: column; height: 100%; gap: 10px; }
    textarea.json-input {
      flex: 1; background: #111; border: 1px solid var(--border); border-radius: 4px;
      padding: 10px; color: #0f0; font-family: monospace; font-size: 10px; resize: none;
    }
    textarea.json-input:focus { outline: none; border-color: var(--accent); }
    .json-buttons { display: flex; gap: 8px; }
    .json-btn { flex: 1; padding: 8px; background: rgba(100, 108, 255, 0.2); border: 1px solid var(--accent); border-radius: 4px; color: var(--accent); cursor: pointer; font-weight: 600; }
    .json-btn:hover { background: rgba(100, 108, 255, 0.4); }

    .viewport { flex: 1; position: relative; background: radial-gradient(circle at center, #222 0%, #111 100%); }
    canvas { display: block; width: 100%; height: 100%; outline: none; }

    .stats {
      position: absolute; bottom: 20px; right: 20px;
      font-family: monospace; font-size: 10px; color: #666;
      background: rgba(0,0,0,0.5); padding: 8px 12px; border-radius: 4px;
      pointer-events: none;
    }

    .mode-btn { 
      font-size: 9px; padding: 4px 8px;
      background: rgba(100, 108, 255, 0.2);
      border: 1px solid var(--border);
      border-radius: 3px;
      color: var(--accent);
      cursor: pointer;
      font-weight: 600;
    }
    .mode-btn:hover { background: rgba(100, 108, 255, 0.4); }

    .globals-hint {
      font-size: 9px;
      color: var(--text-dim);
      margin-top: 2px;
      padding: 4px 6px;
      background: rgba(100, 108, 255, 0.1);
      border-radius: 3px;
      border-left: 2px solid var(--accent);
    }
  </style>
</head>
<body>

  <div class="app">
    <div class="sidebar">
      <div class="header">
        <h1>Spellshape - Procedural Editor</h1>
      </div>

      <div class="tabs">
        <div class="tab active" onclick="setTab('globals')">Globals</div>
        <div class="tab" onclick="setTab('timeline')">Timeline</div>
        <div class="tab" onclick="setTab('materials')">Materials</div>
        <div class="tab" onclick="setTab('json')">JSON</div>
      </div>

      <!-- TAB 1: GLOBALS -->
      <div id="tab-globals" class="content active">
        <div class="globals-container" id="globals-container"></div>
        <button onclick="addGlobalParam()" style="width: 100%; padding: 10px; background: rgba(100, 108, 255, 0.2); border: 1px solid var(--accent); border-radius: 4px; color: var(--accent); cursor: pointer; font-weight: 600; margin-top: 12px;">+ Add Global Parameter</button>
      </div>

      <!-- TAB 2: TIMELINE -->
      <div id="tab-timeline" class="content">
        <div class="timeline" id="timeline-container"></div>
        <button onclick="addStep()" style="width: 100%; padding: 10px; background: rgba(100, 108, 255, 0.2); border: 1px solid var(--accent); border-radius: 4px; color: var(--accent); cursor: pointer; font-weight: 600; margin-top: 12px;">+ Add Step</button>
      </div>

      <!-- TAB 3: MATERIALS -->
      <div id="tab-materials" class="content">
        <div class="materials-container" id="materials-container"></div>
        <button onclick="addMaterial()" style="width: 100%; padding: 10px; background: rgba(100, 108, 255, 0.2); border: 1px solid var(--accent); border-radius: 4px; color: var(--accent); cursor: pointer; font-weight: 600; margin-top: 12px;">+ Add Material</button>
      </div>

      <!-- TAB 4: JSON -->
      <div id="tab-json" class="content">
        <div class="json-container">
          <textarea class="json-input" id="json-input" spellcheck="false"></textarea>
          <div class="json-buttons">
            <button class="json-btn" onclick="importJSON()">Import</button>
            <button class="json-btn" onclick="exportJSON()">Export</button>
          </div>
        </div>
      </div>
    </div>

    <div class="viewport">
      <canvas id="gl"></canvas>
      <div class="stats" id="stats">Ready</div>
    </div>
  </div>

  <!-- Add Step Menu -->
  <div class="menu-overlay" id="menu-overlay" onclick="closeAddMenu()"></div>
  <div class="menu-popup" id="menu-popup"></div>

  <script type="module">
    import * as THREE from 'three';
    import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
    import { ProceduralExecutor } from './src/modules/interpreter/procedural-executor.js';

    // HELPER REGISTRY
    const HELPER_REGISTRY = {
      'createBox': {
        category: 'Basic Geometry',
        params: {
          'width': { type: 'number', default: 1, min: 0.1, max: 50 },
          'height': { type: 'number', default: 1, min: 0.1, max: 50 },
          'depth': { type: 'number', default: 1, min: 0.1, max: 50 },
          'widthSegments': { type: 'integer', default: 1, min: 1, max: 32 },
          'heightSegments': { type: 'integer', default: 1, min: 1, max: 32 },
          'depthSegments': { type: 'integer', default: 1, min: 1, max: 32 }
        }
      },
      'createSphere': {
        category: 'Basic Geometry',
        params: {
          'radius': { type: 'number', default: 1, min: 0.1, max: 50 },
          'widthSegments': { type: 'integer', default: 32, min: 3, max: 128 },
          'heightSegments': { type: 'integer', default: 16, min: 2, max: 64 },
          'phiStart': { type: 'number', default: 0, min: 0, max: 6.28 },
          'phiLength': { type: 'number', default: 6.28, min: 0.1, max: 6.28 },
          'thetaStart': { type: 'number', default: 0, min: 0, max: 3.14 },
          'thetaLength': { type: 'number', default: 3.14, min: 0.1, max: 3.14 }
        }
      },
      'createCylinder': {
        category: 'Basic Geometry',
        params: {
          'radiusTop': { type: 'number', default: 1, min: 0.1, max: 50 },
          'radiusBottom': { type: 'number', default: 1, min: 0.1, max: 50 },
          'height': { type: 'number', default: 1, min: 0.1, max: 50 },
          'radialSegments': { type: 'integer', default: 32, min: 3, max: 128 },
          'heightSegments': { type: 'integer', default: 1, min: 1, max: 32 },
          'openEnded': { type: 'boolean', default: false },
          'thetaStart': { type: 'number', default: 0, min: 0, max: 6.28 },
          'thetaLength': { type: 'number', default: 6.28, min: 0.1, max: 6.28 }
        }
      },
      'createCone': {
        category: 'Basic Geometry',
        params: {
          'radius': { type: 'number', default: 1, min: 0.1, max: 50 },
          'height': { type: 'number', default: 1, min: 0.1, max: 50 },
          'radialSegments': { type: 'integer', default: 32, min: 3, max: 128 },
          'heightSegments': { type: 'integer', default: 1, min: 1, max: 32 },
          'openEnded': { type: 'boolean', default: false }
        }
      },
      'createTorus': {
        category: 'Basic Geometry',
        params: {
          'radius': { type: 'number', default: 1, min: 0.1, max: 50 },
          'tube': { type: 'number', default: 0.4, min: 0.1, max: 10 },
          'radialSegments': { type: 'integer', default: 16, min: 3, max: 64 },
          'tubularSegments': { type: 'integer', default: 100, min: 8, max: 256 },
          'arc': { type: 'number', default: 6.28, min: 0.1, max: 6.28 }
        }
      },
      'createPlane': {
        category: 'Basic Geometry',
        params: {
          'width': { type: 'number', default: 1, min: 0.1, max: 50 },
          'height': { type: 'number', default: 1, min: 0.1, max: 50 },
          'widthSegments': { type: 'integer', default: 1, min: 1, max: 32 },
          'heightSegments': { type: 'integer', default: 1, min: 1, max: 32 }
        }
      },
      'repeatLinear3d': {
        category: 'Distribution',
        params: {
          'geometry': { type: 'reference', default: null },
          'count': { type: 'integer', default: 3, min: 1, max: 50 },
          'spacing': { type: 'number', default: 1, min: 0.1, max: 50 },
          'axis': { type: 'string', default: 'x' },
          'centered': { type: 'boolean', default: false },
          'autoMerge': { type: 'boolean', default: true }
        }
      },
      'repeatRadial3d': {
        category: 'Distribution',
        params: {
          'geometry': { type: 'reference', default: null },
          'count': { type: 'integer', default: 8, min: 1, max: 50 },
          'radius': { type: 'number', default: 5, min: 0.1, max: 100 },
          'startAngle': { type: 'number', default: 0, min: 0, max: 6.28 },
          'endAngle': { type: 'number', default: 6.28, min: 0.1, max: 6.28 },
          'axis': { type: 'string', default: 'y' },
          'faceCenter': { type: 'boolean', default: true },
          'autoMerge': { type: 'boolean', default: true }
        }
      },
      'distributeOnGrid3d': {
        category: 'Distribution',
        params: {
          'geometry': { type: 'reference', default: null },
          'rows': { type: 'integer', default: 3, min: 1, max: 50 },
          'cols': { type: 'integer', default: 3, min: 1, max: 50 },
          'spacing': { type: 'array', default: [2, 0, 2] },
          'centered': { type: 'boolean', default: true },
          'autoMerge': { type: 'boolean', default: true }
        }
      },
      'twistGeometry': {
        category: 'Deformation',
        params: {
          'geometry': { type: 'reference', default: null },
          'angle': { type: 'number', default: 0.785, min: -6.28, max: 6.28 },
          'axis': { type: 'array', default: [0, 1, 0] },
          'height': { type: 'number', default: null }
        }
      },
      'taperGeometry': {
        category: 'Deformation',
        params: {
          'geometry': { type: 'reference', default: null },
          'topScale': { type: 'array', default: [0.5, 0.5] },
          'axis': { type: 'array', default: [0, 1, 0] }
        }
      },
      'bendGeometry': {
        category: 'Deformation',
        params: {
          'geometry': { type: 'reference', default: null },
          'angle': { type: 'number', default: 0.785, min: -6.28, max: 6.28 },
          'direction': { type: 'array', default: [1, 0, 0] }
        }
      },
      'deformByNoise': {
        category: 'Deformation',
        params: {
          'geometry': { type: 'reference', default: null },
          'amount': { type: 'number', default: 0.2, min: 0, max: 10 },
          'frequency': { type: 'number', default: 1.0, min: 0.1, max: 10 },
          'axis': { type: 'array', default: [0, 1, 0] }
        }
      },
      'clone': {
        category: 'Utilities',
        params: {
          'geometry': { type: 'reference', default: null }
        }
      }
    };

    function getHelperParams(helperName) {
      const helperDef = HELPER_REGISTRY[helperName];
      if (!helperDef) return {};
      const params = {};
      for (const [key, def] of Object.entries(helperDef.params)) {
        if (def.default !== null && def.default !== undefined) {
          params[key] = def.default;
        }
      }
      return params;
    }

    function getAvailableGeometries(currentIndex) {
      const available = [];
      for (let i = 0; i < currentIndex; i++) {
        const step = schema.actions[i];
        available.push({
          name: `Step ${i + 1}: ${step.thought}`,
          value: step.as
        });
      }
      return available;
    }

    function renderParameterField(paramKey, paramValue, paramDef, stepIndex) {
      const container = document.createElement('div');
      container.className = 'field-group';

      const label = document.createElement('label');
      label.className = 'field-label';
      label.innerText = paramKey;
      container.appendChild(label);

      // REFERENCE PARAMETERS (geometry selector)
      if (paramDef.type === 'reference') {
        const select = document.createElement('select');
        select.className = 'helper-select';

        const emptyOpt = document.createElement('option');
        emptyOpt.value = '';
        emptyOpt.innerText = '-- None --';
        select.appendChild(emptyOpt);

        const available = getAvailableGeometries(stepIndex);
        available.forEach(({ name, value }) => {
          const opt = document.createElement('option');
          opt.value = value;
          opt.innerText = name;
          if (paramValue === value) opt.selected = true;
          select.appendChild(opt);
        });

        select.onchange = (e) => {
          updateStepField(stepIndex, `param-${paramKey}`, e.target.value || null);
        };
        container.appendChild(select);
      }

      // BOOLEAN PARAMETERS
      else if (paramDef.type === 'boolean') {
        const checkDiv = document.createElement('div');
        checkDiv.style.display = 'flex';
        checkDiv.style.alignItems = 'center';
        checkDiv.style.gap = '8px';

        const input = document.createElement('input');
        input.type = 'checkbox';
        input.checked = paramValue === true;
        input.style.width = '16px';
        input.style.height = '16px';
        input.style.cursor = 'pointer';
        input.onchange = (e) => {
          updateStepField(stepIndex, `param-${paramKey}`, e.target.checked);
        };
        checkDiv.appendChild(input);

        const label2 = document.createElement('span');
        label2.innerText = paramValue ? 'Yes' : 'No';
        label2.style.color = 'var(--text-dim)';
        label2.style.fontSize = '11px';
        checkDiv.appendChild(label2);

        container.appendChild(checkDiv);
      }

      // ARRAY PARAMETERS
      else if (paramDef.type === 'array') {
        const textarea = document.createElement('textarea');
        textarea.className = 'expr-input';
        textarea.value = JSON.stringify(paramValue);
        textarea.onchange = (e) => {
          try {
            updateStepField(stepIndex, `param-${paramKey}`, JSON.parse(e.target.value));
          } catch (err) {
            console.error('Invalid JSON:', err);
          }
        };
        container.appendChild(textarea);
      }

      // STRING PARAMETERS
      else if (paramDef.type === 'string') {
        const input = document.createElement('input');
        input.type = 'text';
        input.className = 'helper-select';
        input.value = paramValue;
        input.onchange = (e) => {
          updateStepField(stepIndex, `param-${paramKey}`, e.target.value);
        };
        container.appendChild(input);
      }

      // NUMBER/INTEGER PARAMETERS (with expression support!)
      else if (paramDef.type === 'number' || paramDef.type === 'integer') {
        const div = document.createElement('div');
        div.style.display = 'flex';
        div.style.flexDirection = 'column';
        div.style.gap = '4px';

        // Detect if expression or number
        const isExpression = typeof paramValue === 'string' && (paramValue.includes('ctx.') || paramValue.includes('+') || paramValue.includes('-') || paramValue.includes('*') || paramValue.includes('/'));

        let useExpression = isExpression;

        // Mode toggle button
        const modeBtn = document.createElement('button');
        modeBtn.className = 'mode-btn';
        modeBtn.style.cursor = 'pointer';
        modeBtn.style.marginBottom = '4px';

        const updateModeBtn = () => {
          modeBtn.innerText = useExpression ? 'ðŸ“ Expression Mode' : '# Value Mode';
          numberInput.style.display = useExpression ? 'none' : 'block';
          exprInputDiv.style.display = useExpression ? 'block' : 'none';
        };

        modeBtn.onclick = () => {
          useExpression = !useExpression;
          updateModeBtn();
        };
        div.appendChild(modeBtn);

        // Number input
        const numberInput = document.createElement('input');
        numberInput.type = 'number';
        numberInput.className = 'helper-select';
        if (paramDef.type === 'integer') numberInput.step = '1';
        else numberInput.step = '0.01';
        if (paramDef.min !== undefined) numberInput.min = paramDef.min;
        if (paramDef.max !== undefined) numberInput.max = paramDef.max;
        numberInput.value = isExpression ? paramDef.default : paramValue;
        numberInput.onchange = (e) => {
          const val = paramDef.type === 'integer' ? parseInt(e.target.value) : parseFloat(e.target.value);
          updateStepField(stepIndex, `param-${paramKey}`, val);
        };
        div.appendChild(numberInput);

        // Expression input
        const exprInputDiv = document.createElement('div');
        exprInputDiv.style.display = 'none';
        exprInputDiv.style.display = 'flex';
        exprInputDiv.style.flexDirection = 'column';
        exprInputDiv.style.gap = '4px';

        const exprInput = document.createElement('textarea');
        exprInput.className = 'expr-input';
        exprInput.style.minHeight = '30px';
        exprInput.style.maxHeight = '60px';
        exprInput.value = isExpression ? paramValue : '';
        exprInput.placeholder = 'e.g., ctx.width * 2';
        exprInput.onchange = (e) => {
          updateStepField(stepIndex, `param-${paramKey}`, e.target.value);
        };
        exprInputDiv.appendChild(exprInput);

        // Show hint with available globals
        const globalsHint = document.createElement('div');
        globalsHint.className = 'globals-hint';
        const globalNames = Object.keys(schema.globalParameters).join(', ');
        globalsHint.innerText = 'ðŸ’¡ Available globals: ' + (globalNames || 'none yet');
        exprInputDiv.appendChild(globalsHint);

        div.appendChild(exprInputDiv);

        updateModeBtn();
        container.appendChild(div);
      }

      // DEFAULT
      else {
        const textarea = document.createElement('textarea');
        textarea.className = 'expr-input';
        textarea.value = JSON.stringify(paramValue);
        textarea.onchange = (e) => {
          try {
            updateStepField(stepIndex, `param-${paramKey}`, JSON.parse(e.target.value));
          } catch (err) {
            console.error('Invalid JSON:', err);
          }
        };
        container.appendChild(textarea);
      }

      return container;
    }

    // SCHEMA STATE
    let schema = {
      "version": "5.0",
      "type": "emergent_procedure",
      "intent": "Custom Procedure",
      "materials": {
        "default": { "color": "#888888", "roughness": 0.7, "metalness": 0.1 },
        "gold": { "color": "#FFD700", "roughness": 0.2, "metalness": 0.8 },
        "plastic": { "color": "#FF69B4", "roughness": 0.8, "metalness": 0.0 }
      },
      "globalParameters": {
        "width": { "value": 10, "type": "number", "min": 1, "max": 50, "group": "Dimensions" },
        "height": { "value": 10, "type": "number", "min": 1, "max": 50, "group": "Dimensions" },
        "scale": { "value": 1, "type": "number", "min": 0.1, "max": 5, "group": "Dimensions" }
      },
      "context": {},
      "actions": []
    };

    const HELPERS = Object.keys(HELPER_REGISTRY);

    window.setTab = (name) => {
      document.querySelectorAll('.tab').forEach(el => el.classList.remove('active'));
      document.querySelectorAll('.content').forEach(el => el.classList.remove('active'));

      document.querySelector(`.tab[onclick="setTab('${name}')"]`).classList.add('active');
      document.getElementById(`tab-${name}`).classList.add('active');

      if (name === 'json') {
        document.getElementById('json-input').value = JSON.stringify(schema, null, 2);
      }
    };

    // GLOBALS MANAGEMENT
    window.addGlobalParam = () => {
      const key = `param_${Date.now()}`;
      schema.globalParameters[key] = { value: 5, type: "number", min: 0, max: 100, group: "Custom" };
      renderGlobals();
      renderTimeline();  // Re-render to show updated hints
      run();
    };

    window.removeGlobalParam = (key) => {
      delete schema.globalParameters[key];
      renderGlobals();
      renderTimeline();
      run();
    };

    window.updateGlobalParam = (key, field, value) => {
      if (field === 'value') {
        schema.globalParameters[key].value = parseFloat(value) || 0;
        run();
      } else if (field === 'min') schema.globalParameters[key].min = parseFloat(value) || 0;
      else if (field === 'max') schema.globalParameters[key].max = parseFloat(value) || 100;
      else if (field === 'key') {
        schema.globalParameters[value] = schema.globalParameters[key];
        delete schema.globalParameters[key];
        renderGlobals();
        renderTimeline();
      }
    };

    function renderGlobals() {
      const container = document.getElementById('globals-container');
      container.innerHTML = '';

      for (const [key, param] of Object.entries(schema.globalParameters)) {
        const group = document.createElement('div');
        group.className = 'global-group';

        const headerHtml = `
          <div class="global-header">
            <span>Parameter</span>
            <button class="btn-add-global" onclick="removeGlobalParam('${key}')">Ã—</button>
          </div>
          <div class="global-item">
            <label style="font-size: 10px; min-width: 40px;">Name:</label>
            <input type="text" value="${key}" onchange="updateGlobalParam('${key}', 'key', this.value)" placeholder="param name" />
          </div>
          <div class="global-slider-group">
            <div class="slider-header">
              <span>Value</span>
              <span class="slider-value">${param.value}</span>
            </div>
            <input type="range" min="${param.min}" max="${param.max}" step="0.1" value="${param.value}" 
              oninput="updateGlobalParam('${key}', 'value', this.value); document.querySelector('[id^=val-${key}]').innerText = this.value;" />
          </div>
          <div class="global-item">
            <label style="font-size: 10px; min-width: 40px;">Min:</label>
            <input type="number" value="${param.min}" onchange="updateGlobalParam('${key}', 'min', this.value)" />
          </div>
          <div class="global-item">
            <label style="font-size: 10px; min-width: 40px;">Max:</label>
            <input type="number" value="${param.max}" onchange="updateGlobalParam('${key}', 'max', this.value)" />
          </div>
        `;
        group.innerHTML = headerHtml;
        container.appendChild(group);
      }
    }

    // MATERIALS MANAGEMENT
    window.addMaterial = () => {
      const name = `material_${Date.now()}`;
      schema.materials[name] = {
        color: '#888888',
        roughness: 0.7,
        metalness: 0.1
      };
      renderMaterials();
    };

    window.removeMaterial = (name) => {
      delete schema.materials[name];
      renderMaterials();
    };

    window.updateMaterial = (name, prop, value) => {
      schema.materials[name][prop] = value;
      renderMaterials();
    };

    function renderMaterials() {
      const container = document.getElementById('materials-container');
      container.innerHTML = '';

      for (const [name, material] of Object.entries(schema.materials)) {
        const item = document.createElement('div');
        item.className = 'material-item';

        const headerDiv = document.createElement('div');
        headerDiv.className = 'material-header';

        const nameInput = document.createElement('input');
        nameInput.type = 'text';
        nameInput.style.background = 'rgba(255,255,255,0.05)';
        nameInput.style.border = '1px solid var(--border)';
        nameInput.style.borderRadius = '4px';
        nameInput.style.padding = '6px 10px';
        nameInput.style.color = 'var(--text)';
        nameInput.style.fontSize = '11px';
        nameInput.style.flex = '1';
        nameInput.style.marginRight = '8px';
        nameInput.value = name;
        nameInput.onchange = (e) => {
          const newName = e.target.value;
          if (newName && newName !== name && !schema.materials[newName]) {
            schema.materials[newName] = schema.materials[name];
            delete schema.materials[name];
            renderMaterials();
          }
        };
        headerDiv.appendChild(nameInput);

        const deleteBtn = document.createElement('button');
        deleteBtn.className = 'material-btn material-delete';
        deleteBtn.innerText = 'ðŸ—‘ï¸ Delete';
        deleteBtn.onclick = () => removeMaterial(name);
        headerDiv.appendChild(deleteBtn);

        item.appendChild(headerDiv);

        // Color
        const colorDiv = document.createElement('div');
        colorDiv.style.display = 'flex';
        colorDiv.style.gap = '8px';
        colorDiv.style.alignItems = 'center';
        colorDiv.style.marginBottom = '8px';

        const colorLabel = document.createElement('label');
        colorLabel.style.fontSize = '10px';
        colorLabel.style.fontWeight = '600';
        colorLabel.style.color = 'var(--text-dim)';
        colorLabel.style.minWidth = '60px';
        colorLabel.innerText = 'Color:';
        colorDiv.appendChild(colorLabel);

        const colorInput = document.createElement('input');
        colorInput.type = 'color';
        colorInput.value = material.color;
        colorInput.style.cursor = 'pointer';
        colorInput.style.width = '40px';
        colorInput.style.height = '30px';
        colorInput.style.border = '1px solid var(--border)';
        colorInput.style.borderRadius = '4px';
        colorInput.onchange = (e) => updateMaterial(name, 'color', e.target.value);
        colorDiv.appendChild(colorInput);

        const colorValue = document.createElement('span');
        colorValue.style.fontFamily = 'monospace';
        colorValue.style.fontSize = '10px';
        colorValue.style.color = 'var(--text-dim)';
        colorValue.innerText = material.color;
        colorDiv.appendChild(colorValue);

        item.appendChild(colorDiv);

        // Roughness
        const roughDiv = document.createElement('div');
        roughDiv.style.marginBottom = '8px';
        const roughLabel = document.createElement('div');
        roughLabel.style.display = 'flex';
        roughLabel.style.justifyContent = 'space-between';
        roughLabel.style.fontSize = '10px';
        roughLabel.style.marginBottom = '4px';
        roughLabel.innerHTML = `<span style="color: var(--text-dim);">Roughness</span><span style="color: var(--accent); font-family: monospace;">${material.roughness.toFixed(2)}</span>`;
        roughDiv.appendChild(roughLabel);

        const roughSlider = document.createElement('input');
        roughSlider.type = 'range';
        roughSlider.min = '0';
        roughSlider.max = '1';
        roughSlider.step = '0.01';
        roughSlider.value = material.roughness;
        roughSlider.style.width = '100%';
        roughSlider.style.cursor = 'pointer';
        roughSlider.onchange = (e) => {
          updateMaterial(name, 'roughness', parseFloat(e.target.value));
        };
        roughDiv.appendChild(roughSlider);
        item.appendChild(roughDiv);

        // Metalness
        const metalDiv = document.createElement('div');
        const metalLabel = document.createElement('div');
        metalLabel.style.display = 'flex';
        metalLabel.style.justifyContent = 'space-between';
        metalLabel.style.fontSize = '10px';
        metalLabel.style.marginBottom = '4px';
        metalLabel.innerHTML = `<span style="color: var(--text-dim);">Metalness</span><span style="color: var(--accent); font-family: monospace;">${material.metalness.toFixed(2)}</span>`;
        metalDiv.appendChild(metalLabel);

        const metalSlider = document.createElement('input');
        metalSlider.type = 'range';
        metalSlider.min = '0';
        metalSlider.max = '1';
        metalSlider.step = '0.01';
        metalSlider.value = material.metalness;
        metalSlider.style.width = '100%';
        metalSlider.style.cursor = 'pointer';
        metalSlider.onchange = (e) => {
          updateMaterial(name, 'metalness', parseFloat(e.target.value));
        };
        metalDiv.appendChild(metalSlider);
        item.appendChild(metalDiv);

        container.appendChild(item);
      }
    }

    // TIMELINE
    window.addStep = (afterIndex = -1) => {
      const newStep = {
        "thought": "New Step",
        "do": "createBox",
        "params": getHelperParams('createBox'),
        "transform": { "position": [0, 0, 0] },
        "as": `step_${Date.now()}`,
        "material": "default"
      };

      if (afterIndex >= 0) schema.actions.splice(afterIndex + 1, 0, newStep);
      else schema.actions.push(newStep);

      renderTimeline();
      run();
    };

    window.removeStep = (index) => {
      schema.actions.splice(index, 1);
      renderTimeline();
      run();
    };

    window.openAddMenu = (index) => {
      const overlay = document.getElementById('menu-overlay');
      const popup = document.getElementById('menu-popup');
      overlay.classList.add('active');

      popup.innerHTML = HELPERS.map(h => `<div class="menu-item" onclick="addStepWithHelper('${h}', ${index})">${h}</div>`).join('');

      const btn = event.target;
      const rect = btn.getBoundingClientRect();
      popup.style.top = rect.bottom + 'px';
      popup.style.left = rect.left + 'px';
    };

    window.addStepWithHelper = (helper, index) => {
      const params = getHelperParams(helper);

      if (params.hasOwnProperty('geometry') && index >= 0 && schema.actions[index]) {
        params.geometry = schema.actions[index].as;
      }

      const newStep = {
        "thought": `Use ${helper}`,
        "do": helper,
        "params": params,
        "as": `${helper}_${Date.now()}`,
        "material": "default"
      };

      schema.actions.splice(index + 1, 0, newStep);
      closeAddMenu();
      renderTimeline();
      run();
    };

    window.closeAddMenu = () => {
      document.getElementById('menu-overlay').classList.remove('active');
    };

    window.updateStepField = (index, field, value) => {
      if (field === 'thought') schema.actions[index].thought = value;
      else if (field === 'do') {
        schema.actions[index].do = value;
        schema.actions[index].params = getHelperParams(value);
      }
      else if (field === 'as') schema.actions[index].as = value;
      else if (field === 'material') schema.actions[index].material = value;
      else if (field.startsWith('param-')) {
        const paramKey = field.replace('param-', '');
        schema.actions[index].params[paramKey] = value;
      }
      renderTimeline();
      run();
    };

    function renderTimeline() {
      const container = document.getElementById('timeline-container');
      container.innerHTML = '';

      schema.actions.forEach((action, i) => {
        const card = document.createElement('div');
        card.className = 'step-card';

        const headerDiv = document.createElement('div');
        headerDiv.className = 'step-header';
        headerDiv.innerHTML = `
          <div class="step-num">${i+1}</div>
          <input class="step-title-input" value="${action.thought || ''}" onchange="updateStepField(${i}, 'thought', this.value)" placeholder="Step description" />
          <div class="step-actions">
            <button class="step-btn step-btn-add" onclick="openAddMenu(${i})" title="Add step after">+</button>
            <button class="step-btn step-btn-remove" onclick="removeStep(${i})" title="Remove step">Ã—</button>
          </div>
        `;
        card.appendChild(headerDiv);

        const bodyDiv = document.createElement('div');
        bodyDiv.className = 'step-body';

        // Helper selector
        const helperGroup = document.createElement('div');
        helperGroup.className = 'field-group';
        helperGroup.innerHTML = `
          <label class="field-label">Helper (do)</label>
          <select class="helper-select" value="${action.do}" onchange="updateStepField(${i}, 'do', this.value)">
            <option value="">-- Select --</option>
            ${HELPERS.map(h => `<option value="${h}" ${action.do === h ? 'selected' : ''}>${h}</option>`).join('')}
          </select>
        `;
        bodyDiv.appendChild(helperGroup);

        // Output name
        const asGroup = document.createElement('div');
        asGroup.className = 'field-group';
        const asInput = document.createElement('input');
        asInput.type = 'text';
        asInput.className = 'helper-select';
        asInput.value = action.as || '';
        asInput.placeholder = 'e.g., box_mesh';
        asInput.onchange = (e) => updateStepField(i, 'as', e.target.value);
        asGroup.innerHTML = '<label class="field-label">Output Name (as)</label>';
        asGroup.appendChild(asInput);
        bodyDiv.appendChild(asGroup);

        // Parameters
        const helperDef = HELPER_REGISTRY[action.do];
        if (helperDef) {
          for (const [key, def] of Object.entries(helperDef.params)) {
            const value = action.params[key];
            const field = renderParameterField(key, value, def, i);
            bodyDiv.appendChild(field);
          }
        }

        // Material selector
        const matGroup = document.createElement('div');
        matGroup.className = 'field-group';
        matGroup.innerHTML = '<label class="field-label">Material</label>';
        const matSelect = document.createElement('select');
        matSelect.className = 'helper-select';
        matSelect.value = action.material || 'default';
        for (const matName of Object.keys(schema.materials)) {
          const opt = document.createElement('option');
          opt.value = matName;
          opt.innerText = matName;
          if (action.material === matName) opt.selected = true;
          matSelect.appendChild(opt);
        }
        matSelect.onchange = (e) => updateStepField(i, 'material', e.target.value);
        matGroup.appendChild(matSelect);
        bodyDiv.appendChild(matGroup);

        card.appendChild(bodyDiv);
        container.appendChild(card);
      });
    }

    // JSON
    window.exportJSON = () => {
      const jsonInput = document.getElementById('json-input');
      jsonInput.value = JSON.stringify(schema, null, 2);
    };

    window.importJSON = () => {
      const jsonInput = document.getElementById('json-input');
      try {
        schema = JSON.parse(jsonInput.value);
        setTab('globals');
        renderGlobals();
        renderTimeline();
        renderMaterials();
        run();
        alert('Schema imported successfully!');
      } catch (e) {
        alert('Invalid JSON: ' + e.message);
      }
    };

    // 3D ENGINE
    const canvas = document.querySelector('#gl');
    const renderer = new THREE.WebGLRenderer({ canvas, antialias: true });
    const scene = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera(45, 1, 0.1, 1000);
    const controls = new OrbitControls(camera, canvas);
    let currentMesh = null;
    const executor = new ProceduralExecutor();

    function setupScene() {
      renderer.setSize(canvas.clientWidth, canvas.clientHeight);
      camera.aspect = canvas.clientWidth / canvas.clientHeight;
      camera.position.set(40, 40, 40);
      camera.updateProjectionMatrix();
      controls.enableDamping = true;
      controls.target.set(0, 0, 0);
      scene.background = new THREE.Color(0x111114);
      scene.add(new THREE.AmbientLight(0xffffff, 0.6));
      const dirLight = new THREE.DirectionalLight(0xffffff, 1);
      dirLight.position.set(50, 100, 50);
      scene.add(dirLight);
      scene.add(new THREE.GridHelper(100, 20, 0x333333, 0x111111));
    }

    function run() {
      if (currentMesh) {
        scene.remove(currentMesh);
        currentMesh.traverse(c => {
          if (c.geometry) c.geometry.dispose();
          if (c.material && !Array.isArray(c.material)) c.material.dispose();
        });
      }

      const params = {};
      for (const [k, v] of Object.entries(schema.globalParameters)) params[k] = v.value;

      try {
        currentMesh = executor.execute(schema, params);
        scene.add(currentMesh);
        let count = 0;
        currentMesh.traverse(c => { if (c.isMesh) count++; });
        document.getElementById('stats').innerText = `Meshes: ${count} | Globals: ${Object.keys(schema.globalParameters).join(', ')}`;
      } catch (e) {
        document.getElementById('stats').innerText = `Error: ${e.message.substring(0, 30)}`;
        console.error(e);
      }
    }

    // INIT
    setupScene();
    renderGlobals();
    renderTimeline();
    renderMaterials();
    run();

    function animate() {
      requestAnimationFrame(animate);
      controls.update();
      renderer.render(scene, camera);
    }
    animate();

    window.onresize = () => {
      renderer.setSize(canvas.clientWidth, canvas.clientHeight);
      camera.aspect = canvas.clientWidth / canvas.clientHeight;
      camera.updateProjectionMatrix();
    }
  </script>
</body>
</html>