<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Spellshape - Clean UI</title>
  
  <script type="importmap">
    {
      "imports": {
        "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js",
        "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/"
      }
    }
  </script>

  <style>
    :root {
      --bg: #121214;
      --panel: #1c1c21;
      --border: #333;
      --accent: #646cff;
      --text: #ececec;
      --text-dim: #888;
    }

    body { margin: 0; overflow: hidden; background: var(--bg); font-family: 'Inter', system-ui, sans-serif; color: var(--text); }
    .app { display: flex; height: 100vh; width: 100vw; }
    
    /* SIDEBAR */
    .sidebar {
      width: 360px;
      background: var(--panel);
      border-right: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      z-index: 10;
    }

    .header {
      padding: 20px;
      border-bottom: 1px solid var(--border);
      background: var(--bg);
    }
    .header h1 { margin: 0; font-size: 16px; font-weight: 700; letter-spacing: -0.5px; }

    /* TABS */
    .tabs { display: flex; padding: 0 20px; border-bottom: 1px solid var(--border); }
    .tab {
      padding: 12px 0; margin-right: 20px;
      font-size: 12px; font-weight: 600; color: var(--text-dim);
      cursor: pointer; border-bottom: 2px solid transparent;
      transition: all 0.2s;
    }
    .tab.active { color: var(--accent); border-bottom-color: var(--accent); }
    .tab:hover { color: #fff; }

    /* SCROLL CONTENT */
    .content { flex: 1; overflow-y: auto; padding: 20px; }

    /* PARAMETER GROUPS */
    .group-title {
      font-size: 11px; font-weight: 700; text-transform: uppercase; color: var(--text-dim);
      margin: 24px 0 12px 0; letter-spacing: 1px;
    }
    .group-title:first-child { margin-top: 0; }

    /* SLIDER CONTROL */
    .control { margin-bottom: 16px; }
    .control-header { display: flex; justify-content: space-between; font-size: 12px; margin-bottom: 6px; }
    .control-val { font-family: monospace; color: var(--accent); }

    input[type=range] {
      width: 100%; -webkit-appearance: none; background: transparent; cursor: pointer;
    }
    input[type=range]::-webkit-slider-runnable-track {
      width: 100%; height: 4px; background: #333; border-radius: 2px;
    }
    input[type=range]::-webkit-slider-thumb {
      -webkit-appearance: none; height: 14px; width: 14px; border-radius: 50%;
      background: #fff; margin-top: -5px; box-shadow: 0 2px 5px rgba(0,0,0,0.3);
      transition: background 0.2s, transform 0.2s;
    }
    input[type=range]:hover::-webkit-slider-thumb { background: var(--accent); transform: scale(1.1); }

    /* RECIPE CARD (Hidden by default) */
    .step-card {
      background: #25252b; border: 1px solid #333; border-radius: 6px;
      padding: 12px; margin-bottom: 10px; font-size: 13px;
    }
    .step-title { font-weight: 600; margin-bottom: 4px; color: #fff; }
    .step-desc { font-size: 11px; color: #888; font-family: monospace; }

    /* VIEWPORT */
    .viewport { flex: 1; position: relative; background: radial-gradient(circle at center, #222 0%, #111 100%); }
    canvas { display: block; width: 100%; height: 100%; outline: none; }
    
    .stats {
      position: absolute; bottom: 20px; right: 20px;
      font-family: monospace; font-size: 10px; color: #666;
      background: rgba(0,0,0,0.5); padding: 8px 12px; border-radius: 4px;
      pointer-events: none;
    }
  </style>
</head>
<body>

  <div class="app">
    <div class="sidebar">
      <div class="header">
        <h1>Spellshape</h1>
      </div>
      
      <div class="tabs">
        <div class="tab active" onclick="showTab('controls')">Controls</div>
        <div class="tab" onclick="showTab('recipe')">Recipe</div>
        <div class="tab" onclick="showTab('json')">JSON</div>
      </div>

      <!-- TAB 1: GROUPED SLIDERS -->
      <div id="tab-controls" class="content">
        <!-- Generated via JS -->
      </div>

      <!-- TAB 2: RECIPE CARDS -->
      <div id="tab-recipe" class="content" style="display:none">
        <!-- Generated via JS -->
      </div>

      <!-- TAB 3: RAW JSON -->
      <div id="tab-json" class="content" style="display:none">
        <textarea id="schema-text" style="width:100%; height:400px; background:#111; color:#ccc; border:1px solid #333; font-family:monospace; font-size:11px; padding:10px; resize:none;" spellcheck="false"></textarea>
        <button onclick="applySchema()" style="width:100%; padding:10px; background:var(--accent); border:none; color:#fff; border-radius:4px; margin-top:10px; cursor:pointer; font-weight:600;">Update Schema</button>
      </div>
    </div>

    <div class="viewport">
      <canvas id="gl"></canvas>
      <div class="stats" id="stats">Ready</div>
    </div>
  </div>

  <script type="module">
    import * as THREE from 'three';
    import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
    import { ProceduralExecutor } from './procedural-executor_FINAL_v2.js';

    // --- ENHANCED SCHEMA (v4.6) with Groups ---
    const defaultSchema = {
      "version": "4.6",
      "type": "emergent_procedure",
      "intent": "Complete Checkerboard Tower",
      "materials": {
        "wall": { "color": "#1a3a5c", "roughness": 0.7, "metalness": 0.1 },
        "window": { "color": "#b3d9ff", "roughness": 0.1, "metalness": 0.8, "transparent": true, "opacity": 0.6 },
        "core": { "color": "#c1440e", "roughness": 0.6, "metalness": 0 },
        "column": { "color": "#2a2a2a", "roughness": 0.8, "metalness": 0.3 },
        "floor_slab": { "color": "#b8b8b8", "roughness": 0.7, "metalness": 0.1 }
      },
      "globalParameters": {
        "floors": { "value": 15, "type": "integer", "min": 3, "max": 30, "group": "Structure" },
        "floorHeight": { "value": 3.5, "type": "number", "min": 2, "max": 5, "group": "Structure" },
        "coreWidth": { "value": 8, "type": "number", "min": 4, "max": 16, "group": "Dimensions" },
        "coreDepth": { "value": 8, "type": "number", "min": 4, "max": 12, "group": "Dimensions" },
        "slabExpansion": { "value": 2, "type": "number", "min": 0, "max": 4, "group": "Dimensions" },
        "rotationPerFloor": { "value": 0.08, "type": "number", "min": 0, "max": 0.2, "group": "Animation" },
        "panelsPerSide": { "value": 6, "type": "integer", "min": 2, "max": 12, "group": "Facade" }
      },
      "context": {},
      "actions": [
        // ... (Same 15 steps as before, hidden for brevity in this snippet) ...
        // Paste the full action list from v4.5 here
        { "thought": "1. Create Slab Base", "do": "createBox", "params": { "width": "ctx.coreWidth + ctx.slabExpansion", "height": 0.3, "depth": "ctx.coreDepth + ctx.slabExpansion" }, "transform": { "position": [0, -0.15, 0] }, "as": "slab_mesh" },
        { "thought": "2. Create Core", "do": "createBox", "params": { "width": "ctx.coreWidth", "height": "ctx.floorHeight", "depth": "ctx.coreDepth" }, "transform": { "position": [0, "ctx.floorHeight/2", 0] }, "as": "core_mesh" },
        { "thought": "3. Create Columns", "do": "createCylinder", "params": { "radiusTop": 0.4, "radiusBottom": 0.4, "height": "ctx.floorHeight" }, "transform": { "position": [0, "ctx.floorHeight/2", 0] }, "as": "col_base" },
        { "thought": "4. Distribute Columns", "do": "distributeOnGrid3d", "params": { "geometry": "col_base", "rows": 2, "cols": 2, "spacing": ["ctx.coreWidth + 1", 0, "ctx.coreDepth + 1"], "centered": true, "autoMerge": true }, "as": "cols_mesh" },
        { "thought": "5. Create Facade Panels", "do": "createBox", "params": { "width": "(ctx.coreWidth + ctx.slabExpansion) / ctx.panelsPerSide - 0.1", "height": "ctx.floorHeight", "depth": 0.2 }, "transform": { "position": [0, "ctx.floorHeight/2", 0] }, "as": "panel_horz" },
        { "do": "createBox", "params": { "width": 0.2, "height": "ctx.floorHeight", "depth": "(ctx.coreDepth + ctx.slabExpansion) / ctx.panelsPerSide - 0.1" }, "transform": { "position": [0, "ctx.floorHeight/2", 0] }, "as": "panel_vert" },
        { "thought": "6. Assemble Patterns", "do": "repeatLinear3d", "params": { "geometry": "panel_horz", "count": "ctx.panelsPerSide / 2", "spacing": "((ctx.coreWidth + ctx.slabExpansion) / ctx.panelsPerSide) * 2", "axis": "x", "centered": true }, "transform": { "position": ["-((ctx.coreWidth + ctx.slabExpansion)/ctx.panelsPerSide)/2", 0, "(ctx.coreDepth + ctx.slabExpansion)/2 - 0.1"] }, "as": "front_even" },
        { "do": "repeatLinear3d", "params": { "geometry": "panel_horz", "count": "ctx.panelsPerSide / 2", "spacing": "((ctx.coreWidth + ctx.slabExpansion) / ctx.panelsPerSide) * 2", "axis": "x", "centered": true }, "transform": { "position": ["((ctx.coreWidth + ctx.slabExpansion)/ctx.panelsPerSide)/2", 0, "(ctx.coreDepth + ctx.slabExpansion)/2 - 0.1"] }, "as": "front_odd" },
        { "do": "repeatLinear3d", "params": { "geometry": "panel_horz", "count": "ctx.panelsPerSide / 2", "spacing": "((ctx.coreWidth + ctx.slabExpansion) / ctx.panelsPerSide) * 2", "axis": "x", "centered": true }, "transform": { "position": ["-((ctx.coreWidth + ctx.slabExpansion)/ctx.panelsPerSide)/2", 0, "-(ctx.coreDepth + ctx.slabExpansion)/2 + 0.1"] }, "as": "back_even" },
        { "do": "repeatLinear3d", "params": { "geometry": "panel_horz", "count": "ctx.panelsPerSide / 2", "spacing": "((ctx.coreWidth + ctx.slabExpansion) / ctx.panelsPerSide) * 2", "axis": "x", "centered": true }, "transform": { "position": ["((ctx.coreWidth + ctx.slabExpansion)/ctx.panelsPerSide)/2", 0, "-(ctx.coreDepth + ctx.slabExpansion)/2 + 0.1"] }, "as": "back_odd" },
        { "do": "repeatLinear3d", "params": { "geometry": "panel_vert", "count": "ctx.panelsPerSide / 2", "spacing": "((ctx.coreDepth + ctx.slabExpansion) / ctx.panelsPerSide) * 2", "axis": "z", "centered": true }, "transform": { "position": ["-(ctx.coreWidth + ctx.slabExpansion)/2 + 0.1", 0, "-((ctx.coreDepth + ctx.slabExpansion)/ctx.panelsPerSide)/2"] }, "as": "left_even" },
        { "do": "repeatLinear3d", "params": { "geometry": "panel_vert", "count": "ctx.panelsPerSide / 2", "spacing": "((ctx.coreDepth + ctx.slabExpansion) / ctx.panelsPerSide) * 2", "axis": "z", "centered": true }, "transform": { "position": ["-(ctx.coreWidth + ctx.slabExpansion)/2 + 0.1", 0, "((ctx.coreDepth + ctx.slabExpansion)/ctx.panelsPerSide)/2"] }, "as": "left_odd" },
        { "do": "repeatLinear3d", "params": { "geometry": "panel_vert", "count": "ctx.panelsPerSide / 2", "spacing": "((ctx.coreDepth + ctx.slabExpansion) / ctx.panelsPerSide) * 2", "axis": "z", "centered": true }, "transform": { "position": ["(ctx.coreWidth + ctx.slabExpansion)/2 - 0.1", 0, "-((ctx.coreDepth + ctx.slabExpansion)/ctx.panelsPerSide)/2"] }, "as": "right_even" },
        { "do": "repeatLinear3d", "params": { "geometry": "panel_vert", "count": "ctx.panelsPerSide / 2", "spacing": "((ctx.coreDepth + ctx.slabExpansion) / ctx.panelsPerSide) * 2", "axis": "z", "centered": true }, "transform": { "position": ["(ctx.coreWidth + ctx.slabExpansion)/2 - 0.1", 0, "((ctx.coreDepth + ctx.slabExpansion)/ctx.panelsPerSide)/2"] }, "as": "right_odd" },
        { 
          "thought": "7. Stack Floors", 
          "do": "loop", "var": "i", "from": 0, "to": "ctx.floors",
          "body": [
             { "do": "clone", "params": {"id":"slab_mesh"}, "transform": {"rotation": [0, "i * ctx.rotationPerFloor", 0], "position": [0, "i * ctx.floorHeight", 0]}, "material": "floor_slab" },
             { "do": "clone", "params": {"id":"core_mesh"}, "transform": {"rotation": [0, "i * ctx.rotationPerFloor", 0], "position": [0, "i * ctx.floorHeight", 0]}, "material": "core" },
             { "do": "clone", "params": {"id":"cols_mesh"}, "transform": {"rotation": [0, "i * ctx.rotationPerFloor", 0], "position": [0, "i * ctx.floorHeight", 0]}, "material": "column" },
             
             { "do": "clone", "params": {"id":"front_even"}, "transform": {"rotation": [0, "i * ctx.rotationPerFloor", 0], "position": [0, "i * ctx.floorHeight", 0]}, "material": "(i % 2 === 0) ? 'wall' : 'window'" },
             { "do": "clone", "params": {"id":"front_odd"}, "transform": {"rotation": [0, "i * ctx.rotationPerFloor", 0], "position": [0, "i * ctx.floorHeight", 0]}, "material": "(i % 2 === 0) ? 'window' : 'wall'" },
             { "do": "clone", "params": {"id":"back_even"}, "transform": {"rotation": [0, "i * ctx.rotationPerFloor", 0], "position": [0, "i * ctx.floorHeight", 0]}, "material": "(i % 2 === 0) ? 'wall' : 'window'" },
             { "do": "clone", "params": {"id":"back_odd"}, "transform": {"rotation": [0, "i * ctx.rotationPerFloor", 0], "position": [0, "i * ctx.floorHeight", 0]}, "material": "(i % 2 === 0) ? 'window' : 'wall'" },
             { "do": "clone", "params": {"id":"left_even"}, "transform": {"rotation": [0, "i * ctx.rotationPerFloor", 0], "position": [0, "i * ctx.floorHeight", 0]}, "material": "(i % 2 === 0) ? 'window' : 'wall'" },
             { "do": "clone", "params": {"id":"left_odd"}, "transform": {"rotation": [0, "i * ctx.rotationPerFloor", 0], "position": [0, "i * ctx.floorHeight", 0]}, "material": "(i % 2 === 0) ? 'wall' : 'window'" },
             { "do": "clone", "params": {"id":"right_even"}, "transform": {"rotation": [0, "i * ctx.rotationPerFloor", 0], "position": [0, "i * ctx.floorHeight", 0]}, "material": "(i % 2 === 0) ? 'window' : 'wall'" },
             { "do": "clone", "params": {"id":"right_odd"}, "transform": {"rotation": [0, "i * ctx.rotationPerFloor", 0], "position": [0, "i * ctx.floorHeight", 0]}, "material": "(i % 2 === 0) ? 'wall' : 'window'" }
          ] 
        }
      ]
    };

    // --- STATE ---
    let currentSchema = defaultSchema;
    let currentMesh = null;
    const executor = new ProceduralExecutor();

    // --- UI LOGIC ---
    const controlsDiv = document.getElementById('tab-controls');
    const recipeDiv = document.getElementById('tab-recipe');
    const jsonText = document.getElementById('schema-text');

    function renderControls() {
      controlsDiv.innerHTML = '';
      
      // Group params by 'group' property
      const groups = {};
      const params = currentSchema.globalParameters || {};
      
      for (const [key, def] of Object.entries(params)) {
        const gName = def.group || 'General';
        if (!groups[gName]) groups[gName] = [];
        groups[gName].push({ key, def });
      }

      // Render groups
      for (const [gName, items] of Object.entries(groups)) {
        const title = document.createElement('div');
        title.className = 'group-title';
        title.innerText = gName;
        controlsDiv.appendChild(title);

        items.forEach(({ key, def }) => {
          const wrapper = document.createElement('div');
          wrapper.className = 'control';
          
          const header = document.createElement('div');
          header.className = 'control-header';
          header.innerHTML = `<span>${key}</span><span class="control-val" id="disp-${key}">${def.value}</span>`;
          
          const input = document.createElement('input');
          input.type = 'range';
          input.min = def.min;
          input.max = def.max;
          input.step = def.step || (def.type === 'integer' ? 1 : 0.01);
          input.value = def.value;
          
          input.oninput = (e) => {
            const val = parseFloat(e.target.value);
            def.value = val; // Update Source
            document.getElementById(`disp-${key}`).innerText = val;
            run();
          };

          wrapper.appendChild(header);
          wrapper.appendChild(input);
          controlsDiv.appendChild(wrapper);
        });
      }
    }

    function renderRecipe() {
      recipeDiv.innerHTML = '';
      currentSchema.actions.forEach((action, i) => {
        if (!action.thought) return; // Skip hidden steps
        
        const card = document.createElement('div');
        card.className = 'step-card';
        card.innerHTML = `
          <div class="step-title">${i+1}. ${action.thought}</div>
          <div class="step-desc">${action.do} â†’ ${action.as || 'output'}</div>
        `;
        recipeDiv.appendChild(card);
      });
    }

    window.showTab = (id) => {
      document.querySelectorAll('.tab').forEach(el => el.classList.remove('active'));
      document.querySelectorAll('.content').forEach(el => el.style.display = 'none');
      
      document.querySelector(`.tab[onclick="showTab('${id}')"]`).classList.add('active');
      document.getElementById(`tab-${id}`).style.display = 'block';

      if (id === 'json') {
        jsonText.value = JSON.stringify(currentSchema, null, 2);
      }
    }

    window.applySchema = () => {
      try {
        currentSchema = JSON.parse(jsonText.value);
        renderControls();
        renderRecipe();
        run();
        showTab('controls'); // Switch back to controls
      } catch (e) {
        alert("Invalid JSON");
      }
    }

    // --- 3D RUNTIME ---
    const canvas = document.querySelector('#gl');
    const renderer = new THREE.WebGLRenderer({ canvas, antialias: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    
    const scene = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera(45, window.innerWidth/window.innerHeight, 0.1, 1000);
    camera.position.set(60, 50, 60);
    
    const controls = new OrbitControls(camera, canvas);
    controls.enableDamping = true;
    controls.target.set(0, 20, 0);

    scene.add(new THREE.AmbientLight(0xffffff, 0.6));
    const dirLight = new THREE.DirectionalLight(0xffffff, 1);
    dirLight.position.set(50, 100, 50);
    scene.add(dirLight);
    scene.add(new THREE.GridHelper(100, 20, 0x333333, 0x111111));

    function run() {
      const start = performance.now();
      if (currentMesh) {
        scene.remove(currentMesh);
        currentMesh.traverse(c => {
          if (c.geometry) c.geometry.dispose();
          if (c.material) c.material.dispose();
        });
      }

      const params = {};
      for (const [k, v] of Object.entries(currentSchema.globalParameters)) {
        params[k] = v.value;
      }

      try {
        currentMesh = executor.execute(currentSchema, params);
        scene.add(currentMesh);
        const time = (performance.now() - start).toFixed(2);
        document.getElementById('stats').innerText = `Render: ${time}ms`;
      } catch (e) {
        console.error(e);
      }
    }

    // Init
    renderControls();
    renderRecipe();
    run();

    function animate() {
      requestAnimationFrame(animate);
      controls.update();
      renderer.render(scene, camera);
    }
    animate();

    window.onresize = () => {
      camera.aspect = window.innerWidth/window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight);
    }
  </script>
</body>
</html>
