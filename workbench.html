<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Spellshape - Procedural Editor</title>

  <script type="importmap">
    {
      "imports": {
        "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js",
        "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/"
      }
    }
  </script>

  <style>
    :root {
      --bg: #121214;
      --panel: #1c1c21;
      --card: #25252b;
      --border: #333;
      --accent: #646cff;
      --text: #ececec;
      --text-dim: #888;
    }

    * { box-sizing: border-box; }
    body { margin: 0; overflow: hidden; background: var(--bg); font-family: 'Inter', system-ui, sans-serif; color: var(--text); font-size: 12px; }
    .app { display: flex; height: 100vh; width: 100vw; }

    .sidebar {
      flex: 0 0 400px;
      width: 400px;
      background: var(--panel);
      border-right: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      z-index: 10;
    }

    .header {
      padding: 20px;
      border-bottom: 1px solid var(--border);
      background: var(--bg);
    }
    .header h1 { margin: 0; font-size: 16px; font-weight: 700; letter-spacing: -0.5px; }
    .header select { width: 100%; padding: 6px; margin-top: 8px; background: #111; border: 1px solid var(--border); color: #fff; border-radius: 4px; cursor: pointer; }

    .tabs { display: flex; padding: 0 20px; border-bottom: 1px solid var(--border); }
    .tab {
      padding: 12px 0; margin-right: 20px;
      font-size: 12px; font-weight: 600; color: var(--text-dim);
      cursor: pointer; border-bottom: 2px solid transparent;
      transition: all 0.2s;
    }
    .tab.active { color: var(--accent); border-bottom-color: var(--accent); }
    .tab:hover { color: #fff; }

    .content { flex: 1; overflow-y: auto; padding: 20px; display: none; }
    .content.active { display: block; }

    /* CONTROLS TAB */
    .group-title {
      font-size: 10px; font-weight: 700; text-transform: uppercase; color: var(--text-dim);
      margin: 20px 0 12px 0; letter-spacing: 1px; border-bottom: 1px solid #333; padding-bottom: 4px;
    }
    .group-title:first-child { margin-top: 0; }

    .control { margin-bottom: 16px; }
    .control-header { display: flex; justify-content: space-between; font-size: 11px; margin-bottom: 6px; }
    .control-val { font-family: monospace; color: var(--accent); }
    .control-label { color: #ccc; font-weight: 500; }

    input[type=range] {
      width: 100%; -webkit-appearance: none; background: transparent; cursor: pointer;
    }
    input[type=range]::-webkit-slider-runnable-track {
      width: 100%; height: 4px; background: #333; border-radius: 2px;
    }
    input[type=range]::-webkit-slider-thumb {
      -webkit-appearance: none; height: 14px; width: 14px; border-radius: 50%;
      background: #fff; margin-top: -5px; box-shadow: 0 2px 5px rgba(0,0,0,0.3);
      transition: background 0.2s, transform 0.2s;
    }
    input[type=range]:hover::-webkit-slider-thumb { background: var(--accent); transform: scale(1.1); }

    /* RECIPE TAB */
    .step-card {
      background: var(--card); border: 1px solid var(--border); border-radius: 6px;
      padding: 14px; margin-bottom: 12px; position: relative;
    }
    .step-card.add-card {
      border: 2px dashed var(--accent); display: flex; align-items: center; justify-content: center;
      cursor: pointer; min-height: 60px;
    }
    .step-card.add-card:hover { background: rgba(100, 108, 255, 0.1); }

    .step-header { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; justify-content: space-between; }
    .step-num { 
      width: 18px; height: 18px; background: #333; border-radius: 50%; 
      font-size: 10px; font-weight: bold; color: #888; 
      display: flex; align-items: center; justify-content: center;
    }
    .step-title { font-size: 13px; font-weight: 600; color: #fff; flex: 1; }
    .step-type { font-family: monospace; font-size: 9px; color: var(--accent); background: rgba(100, 108, 255, 0.1); padding: 2px 6px; border-radius: 3px; }
    .step-delete { font-size: 18px; cursor: pointer; color: #888; transition: color 0.2s; }
    .step-delete:hover { color: #f44; }

    .step-controls { 
      margin-top: 10px; padding-top: 10px; border-top: 1px solid rgba(255,255,255,0.05); 
    }

    /* JSON TAB */
    textarea {
      width: 100%; height: 100%; background: #111; border: none;
      color: #ccc; font-family: monospace; font-size: 11px; padding: 10px; resize: none;
    }

    .json-footer {
      padding: 10px; background: var(--panel); border-top: 1px solid var(--border);
    }
    .json-btn {
      width: 100%; padding: 8px; background: var(--accent); border: none; border-radius: 4px;
      color: white; cursor: pointer; font-weight: 600; font-size: 11px;
    }
    .json-btn:hover { opacity: 0.9; }

    /* HELPER MENU */
    .helper-menu {
      position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
      background: var(--panel); border: 1px solid var(--border); border-radius: 8px;
      z-index: 1000; display: none; flex-direction: column; max-height: 60vh; width: 300px;
    }
    .helper-menu.open { display: flex; }
    .helper-menu-header { padding: 12px 16px; border-bottom: 1px solid var(--border); font-weight: 600; }
    .helper-menu-list { overflow-y: auto; padding: 12px; flex: 1; }
    .helper-item {
      padding: 8px 12px; margin-bottom: 4px; background: var(--card); border: 1px solid var(--border);
      border-radius: 4px; cursor: pointer; transition: all 0.2s; font-size: 11px;
    }
    .helper-item:hover { border-color: var(--accent); background: rgba(100, 108, 255, 0.1); }
    .helper-category { font-size: 9px; font-weight: 700; color: var(--text-dim); margin-top: 12px; margin-bottom: 6px; }
    .helper-category:first-child { margin-top: 0; }
    .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 999; display: none; }
    .overlay.open { display: block; }

    /* VIEWPORT */
    .viewport { flex: 1; position: relative; background: radial-gradient(circle at center, #222 0%, #111 100%); }
    canvas { display: block; width: 100%; height: 100%; outline: none; }

    .stats {
      position: absolute; bottom: 20px; right: 20px;
      font-family: monospace; font-size: 10px; color: #666;
      background: rgba(0,0,0,0.5); padding: 8px 12px; border-radius: 4px;
      pointer-events: none;
    }
  </style>
</head>
<body>

  <div class="app">
    <div class="sidebar">
      <div class="header">
        <h1>Spellshape</h1>
        <select id="schema-select" onchange="APP.loadSchema(this.value)">
          <option value="schema1">Tower Schema</option>
          <option value="schema2">Noise Column</option>
          <option value="schema3">Deformed Surface</option>
        </select>
      </div>

      <div class="tabs">
        <div class="tab active" onclick="APP.setTab('controls')">Controls</div>
        <div class="tab" onclick="APP.setTab('recipe')">Recipe</div>
        <div class="tab" onclick="APP.setTab('json')">JSON</div>
      </div>

      <div id="tab-controls" class="content active"></div>
      <div id="tab-recipe" class="content"></div>
      <div id="tab-json" class="content" style="padding:0; display: flex; flex-direction: column;">
        <textarea id="json-input" spellcheck="false"></textarea>
        <div class="json-footer">
          <button class="json-btn" onclick="APP.updateFromJSON()">Update Geometry</button>
        </div>
      </div>
    </div>

    <div class="viewport">
      <canvas id="gl"></canvas>
      <div class="stats" id="stats">Ready</div>
    </div>
  </div>

  <div class="overlay" id="overlay" onclick="APP.closeHelperMenu()"></div>
  <div class="helper-menu" id="helper-menu">
    <div class="helper-menu-header">Select Helper</div>
    <div class="helper-menu-list" id="helper-list"></div>
  </div>

  <script type="module">
    import * as THREE from 'three';
    import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
    import { ProceduralExecutor } from './src/modules/interpreter/procedural-executor.js';

    // --- APP NAMESPACE ---
    window.APP = {};

    // --- HELPERS LIBRARY ---
    const helpers = {
      'createBox': { category: 'Basic', params: { width: 1, height: 1, depth: 1 } },
      'createCylinder': { category: 'Basic', params: { radiusTop: 1, radiusBottom: 1, height: 1 } },
      'createSphere': { category: 'Basic', params: { radius: 1, widthSegments: 32, heightSegments: 16 } },
      'createCone': { category: 'Basic', params: { radius: 1, height: 1 } },
      'createPlane': { category: 'Basic', params: { width: 1, height: 1 } },
      'twistGeometry': { category: 'Deform', params: { geometry: null, angle: 0.785, axis: [0, 1, 0] } },
      'taperGeometry': { category: 'Deform', params: { geometry: null, topScale: [0.5, 0.5] } },
      'bendGeometry': { category: 'Deform', params: { geometry: null, angle: 0.785 } },
      'deformByNoise': { category: 'Deform', params: { geometry: null, amount: 0.2, frequency: 1.0 } },
      'repeatLinear3d': { category: 'Distribution', params: { geometry: null, count: 3, spacing: 1, axis: 'x' } },
      'repeatRadial3d': { category: 'Distribution', params: { geometry: null, count: 8, radius: 5 } },
      'distributeOnGrid3d': { category: 'Distribution', params: { geometry: null, rows: 3, cols: 3, spacing: [2, 0, 2] } },
      'modifyGeometry': { category: 'Emergent', params: { geometry: null, operations: [] } },
      'loop': { category: 'Logic', params: { var: 'i', from: 0, to: 10, body: [] } },
    };

    // --- SAMPLE SCHEMAS ---
    let schema = {
      "version": "4.9",
      "intent": "My Design",
      "globalParameters": {
        "scale": { "value": 1.0, "type": "number", "min": 0.5, "max": 2.0, "group": "General" },
        "detail": { "value": 32, "type": "integer", "min": 8, "max": 64, "group": "General" }
      },
      "actions": []
    };

    const schemas = {
      schema1: {
        "version": "4.9",
        "intent": "Tower",
        "globalParameters": {
          "floors": { "value": 10, "type": "integer", "min": 3, "max": 20, "group": "Massing" },
          "floorHeight": { "value": 3.5, "type": "number", "min": 2, "max": 5, "group": "Massing" }
        },
        "actions": [
          { "thought": "Create Slab", "do": "createBox", "params": { "width": 12, "height": 0.3, "depth": 12 }, "as": "slab", "controls": [] },
          { "thought": "Create Core", "do": "createBox", "params": { "width": 6, "height": "ctx.floorHeight", "depth": 6 }, "as": "core", "controls": [] }
        ]
      },
      schema2: {
        "version": "4.9",
        "intent": "Noise Column",
        "globalParameters": {
          "layers": { "value": 50, "type": "integer", "min": 20, "max": 100, "group": "General" }
        },
        "actions": [
          { "thought": "Create Slice", "do": "createBox", "params": { "width": 4, "height": 0.2, "depth": 4 }, "as": "slice", "controls": [] }
        ]
      },
      schema3: {
        "version": "4.9",
        "intent": "Deformed Surface",
        "globalParameters": {
          "width": { "value": 6, "type": "number", "min": 2, "max": 10, "group": "Dimensions" },
          "resolution": { "value": 30, "type": "integer", "min": 10, "max": 100, "group": "Quality" }
        },
        "actions": [
          { "thought": "Create Base", "do": "createBox", "params": { "width": "ctx.width", "height": 8, "depth": 6, "widthSegments": "ctx.resolution", "heightSegments": "ctx.resolution" }, "as": "base", "controls": ["width", "resolution"] }
        ]
      }
    };

    // --- UI STATE ---
    const tabs = {
      controls: document.getElementById('tab-controls'),
      recipe: document.getElementById('tab-recipe'),
      json: document.getElementById('tab-json')
    };
    const jsonInput = document.getElementById('json-input');

    // --- UI FUNCTIONS ---
    APP.setTab = function(name) {
      document.querySelectorAll('.tab').forEach(el => el.classList.remove('active'));
      document.querySelectorAll('.content').forEach(el => el.classList.remove('active'));

      document.querySelector(`.tab[onclick="APP.setTab('${name}')"]`).classList.add('active');
      tabs[name].classList.add('active');

      if (name === 'json') {
        jsonInput.value = JSON.stringify(schema, null, 2);
      }
    };

    APP.loadSchema = function(key) {
      schema = JSON.parse(JSON.stringify(schemas[key]));
      renderUI();
      run();
    };

    // --- SLIDER CREATION ---
    function createSlider(key, def, context = 'global') {
      const wrapper = document.createElement('div');
      wrapper.className = 'control';

      const header = document.createElement('div');
      header.className = 'control-header';
      const val = document.createElement('span');
      val.className = 'control-val';
      val.innerText = def.value;
      val.id = `val-${context}-${key}`;

      header.innerHTML = `<span class="control-label">${key}</span>`;
      header.appendChild(val);

      const input = document.createElement('input');
      input.type = 'range';
      input.min = def.min;
      input.max = def.max;
      input.step = def.type === 'integer' ? 1 : 0.01;
      input.value = def.value;
      input.setAttribute('data-key', key);
      input.setAttribute('data-context', context);

      input.oninput = (e) => {
        const parsed = def.type === 'integer' ? parseInt(e.target.value) : parseFloat(e.target.value);
        def.value = parsed;

        // Update ALL displays of this key
        document.querySelectorAll(`[id^="val-"][id$="-${key}"]`).forEach(el => el.innerText = parsed);
        document.querySelectorAll(`input[data-key="${key}"]`).forEach(el => el.value = parsed);

        run();
      };

      wrapper.appendChild(header);
      wrapper.appendChild(input);
      return wrapper;
    }

    // --- RENDER UI ---
    function renderUI() {
      // CONTROLS TAB
      tabs.controls.innerHTML = '';
      const groups = {};
      for (const [key, def] of Object.entries(schema.globalParameters)) {
        const g = def.group || 'General';
        if (!groups[g]) groups[g] = [];
        groups[g].push({ key, def });
      }

      for (const [gName, items] of Object.entries(groups)) {
        const title = document.createElement('div');
        title.className = 'group-title';
        title.innerText = gName;
        tabs.controls.appendChild(title);
        items.forEach(({ key, def }) => tabs.controls.appendChild(createSlider(key, def, 'ctrl')));
      }

      // RECIPE TAB
      tabs.recipe.innerHTML = '';
      schema.actions.forEach((action, i) => {
        const card = document.createElement('div');
        card.className = 'step-card';

        const header = document.createElement('div');
        header.className = 'step-header';
        header.innerHTML = `
          <div class="step-num">${i+1}</div>
          <div class="step-title">${action.thought}</div>
          <div class="step-type">${action.do}</div>
          <div class="step-delete" onclick="APP.deleteStep(${i})">âœ•</div>
        `;
        card.appendChild(header);

        if (action.controls && action.controls.length > 0) {
          const controlsArea = document.createElement('div');
          controlsArea.className = 'step-controls';
          action.controls.forEach(key => {
            if (schema.globalParameters[key]) {
              controlsArea.appendChild(createSlider(key, schema.globalParameters[key], `recipe-${i}`));
            }
          });
          card.appendChild(controlsArea);
        }

        tabs.recipe.appendChild(card);
      });

      // ADD BUTTON
      const addCard = document.createElement('div');
      addCard.className = 'step-card add-card';
      addCard.innerText = '+ Add Step';
      addCard.onclick = () => APP.openHelperMenu();
      tabs.recipe.appendChild(addCard);
    }

    // --- HELPER MENU ---
    APP.openHelperMenu = function() {
      const list = document.getElementById('helper-list');
      list.innerHTML = '';
      const categories = {};

      for (const [name, info] of Object.entries(helpers)) {
        if (!categories[info.category]) categories[info.category] = [];
        categories[info.category].push(name);
      }

      for (const [cat, items] of Object.entries(categories)) {
        const catTitle = document.createElement('div');
        catTitle.className = 'helper-category';
        catTitle.innerText = cat;
        list.appendChild(catTitle);

        items.forEach(name => {
          const item = document.createElement('div');
          item.className = 'helper-item';
          item.innerText = name;
          item.onclick = () => APP.addStep(name);
          list.appendChild(item);
        });
      }

      document.getElementById('helper-menu').classList.add('open');
      document.getElementById('overlay').classList.add('open');
    };

    APP.closeHelperMenu = function() {
      document.getElementById('helper-menu').classList.remove('open');
      document.getElementById('overlay').classList.remove('open');
    };

    APP.addStep = function(helperName) {
      const helperInfo = helpers[helperName];
      const newAction = {
        thought: helperName,
        do: helperName,
        params: { ...helperInfo.params },
        as: `obj_${Date.now().toString().slice(-4)}`,
        controls: []
      };
      schema.actions.push(newAction);
      APP.closeHelperMenu();
      renderUI();
      run();
    };

    APP.deleteStep = function(index) {
      schema.actions.splice(index, 1);
      renderUI();
      run();
    };

    APP.updateFromJSON = function() {
      try {
        schema = JSON.parse(jsonInput.value);
        renderUI();
        run();
        APP.setTab('controls');
      } catch (e) {
        alert('Invalid JSON: ' + e.message);
      }
    };

    // --- 3D ENGINE ---
    const canvas = document.querySelector('#gl');
    const renderer = new THREE.WebGLRenderer({ canvas, antialias: true });
    const scene = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera(45, 1, 0.1, 1000);
    const controls = new OrbitControls(camera, canvas);
    let currentMesh = null;
    const executor = new ProceduralExecutor();

    function setupScene() {
      renderer.setSize(canvas.clientWidth, canvas.clientHeight);
      camera.aspect = canvas.clientWidth / canvas.clientHeight;
      camera.position.set(60, 50, 60);
      camera.updateProjectionMatrix();
      controls.enableDamping = true;
      controls.target.set(0, 20, 0);
      scene.background = new THREE.Color(0x111114);
      scene.add(new THREE.AmbientLight(0xffffff, 0.6));
      const dirLight = new THREE.DirectionalLight(0xffffff, 1);
      dirLight.position.set(50, 100, 50);
      scene.add(dirLight);
      scene.add(new THREE.GridHelper(100, 20, 0x333333, 0x111111));
    }

    function run() {
      if (currentMesh) {
        scene.remove(currentMesh);
        currentMesh.traverse(c => {
          if (c.geometry) c.geometry.dispose();
          if (c.material && !Array.isArray(c.material)) c.material.dispose();
        });
      }

      const params = {};
      for (const [k, v] of Object.entries(schema.globalParameters)) params[k] = v.value;

      try {
        currentMesh = executor.execute(schema, params);
        scene.add(currentMesh);
        let count = 0;
        currentMesh.traverse(c => { if (c.isMesh) count++; });
        document.getElementById('stats').innerText = `Meshes: ${count}`;
      } catch (e) {
        console.error(e);
        document.getElementById('stats').innerText = `Error: ${e.message.substring(0, 30)}`;
      }
    }

    // INIT
    setupScene();
    renderUI();
    run();

    function animate() {
      requestAnimationFrame(animate);
      controls.update();
      renderer.render(scene, camera);
    }
    animate();

    window.onresize = () => {
      renderer.setSize(canvas.clientWidth, canvas.clientHeight);
      camera.aspect = canvas.clientWidth / canvas.clientHeight;
      camera.updateProjectionMatrix();
    };
  </script>
</body>
</html>