<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spellshape - Procedural Timeline Editor</title>

    <script type="importmap">
    {
        "imports": {
            "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js",
            "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/"
        }
    }
    </script>

    <style>
        :root {
            --bg: #121214;
            --panel: #1c1c21;
            --card: #25252b;
            --card-hover: #2d2d33;
            --border: #333;
            --accent: #646cff;
            --text: #ececec;
            --text-dim: #888;
            --success: #4ade80;
            --error: #ff6464;
        }

        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            overflow: hidden;
            background: var(--bg);
            font-family: Inter, system-ui, sans-serif;
            color: var(--text);
        }

        .app {
            display: flex;
            height: 100vh;
            width: 100vw;
        }

        .sidebar {
            flex: 0 0 500px;
            width: 500px;
            background: var(--panel);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            z-index: 10;
        }

        .header {
            padding: 16px 20px;
            border-bottom: 1px solid var(--border);
            background: var(--bg);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            margin: 0;
            font-size: 14px;
            font-weight: 700;
            flex: 1;
        }

        .view-controls {
            display: flex;
            gap: 4px;
            align-items: center;
        }

        .view-btn {
            width: 24px;
            height: 24px;
            background: rgba(100, 108, 255, 0.2);
            border: 1px solid transparent;
            border-radius: 3px;
            color: var(--text-dim);
            cursor: pointer;
            font-size: 11px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .view-btn.active {
            background: rgba(100, 108, 255, 0.4);
            color: var(--accent);
            border-color: var(--accent);
        }

        .view-btn:hover {
            background: rgba(100, 108, 255, 0.3);
        }

        .tabs {
            display: flex;
            padding: 0 20px;
            border-bottom: 1px solid var(--border);
            gap: 12px;
            overflow-x: auto;
        }

        .tab {
            padding: 10px 0;
            font-size: 10px;
            font-weight: 600;
            color: var(--text-dim);
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
            white-space: nowrap;
        }

        .tab.active {
            color: var(--accent);
            border-bottom-color: var(--accent);
        }

        .tab:hover {
            color: #fff;
        }

        .content {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            display: none;
        }

        .content.active {
            display: block;
        }

        .globals-container {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .global-group {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 12px;
        }

        .global-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            color: var(--text-dim);
        }

        .btn-add-global {
            width: 20px;
            height: 20px;
            background: rgba(100, 108, 255, 0.2);
            border: none;
            border-radius: 3px;
            color: var(--accent);
            cursor: pointer;
            font-weight: bold;
        }

        .btn-add-global:hover {
            background: rgba(100, 108, 255, 0.4);
        }

        .global-item {
            display: flex;
            gap: 8px;
            margin-bottom: 8px;
            align-items: center;
        }

        .global-slider-group {
            display: flex;
            flex-direction: column;
            gap: 4px;
            margin-top: 8px;
        }

        .slider-header {
            display: flex;
            justify-content: space-between;
            font-size: 10px;
            color: var(--text-dim);
        }

        .slider-value {
            color: var(--accent);
        }

        input[type="range"] {
            width: 100%;
            height: 4px;
            border-radius: 2px;
            background: var(--border);
            outline: none;
            -webkit-appearance: none;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--accent);
            cursor: pointer;
        }

        input[type="range"]::-moz-range-thumb {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--accent);
            cursor: pointer;
            border: none;
        }

        input[type="text"],
        input[type="number"],
        select {
            width: 100%;
            padding: 6px 8px;
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 3px;
            color: var(--text);
            font-size: 12px;
            font-family: inherit;
        }

        input[type="text"]:focus,
        input[type="number"]:focus,
        select:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 2px rgba(100, 108, 255, 0.2);
        }

        label {
            font-size: 11px;
            font-weight: 600;
            color: var(--text-dim);
            display: block;
            margin-bottom: 4px;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 4px;
            margin-bottom: 10px;
        }

        .btn {
            padding: 8px 12px;
            background: rgba(100, 108, 255, 0.3);
            border: 1px solid var(--accent);
            border-radius: 4px;
            color: var(--accent);
            cursor: pointer;
            font-size: 11px;
            font-weight: 600;
            transition: all 0.2s;
        }

        .btn:hover {
            background: rgba(100, 108, 255, 0.5);
        }

        .btn.primary {
            background: var(--accent);
            color: var(--bg);
        }

        .btn.primary:hover {
            background: #7c84ff;
        }

        .btn.danger {
            background: rgba(255, 100, 100, 0.3);
            border-color: var(--error);
            color: var(--error);
        }

        .btn.danger:hover {
            background: rgba(255, 100, 100, 0.5);
        }

        .canvas-container {
            flex: 1;
            position: relative;
            background: #0a0a0c;
        }

        #canvas {
            width: 100%;
            height: 100%;
            display: block;
        }

        .status-bar {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0, 0, 0, 0.8);
            padding: 8px 16px;
            font-size: 11px;
            color: var(--text-dim);
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
        }

        .status-item {
            display: flex;
            gap: 8px;
        }

        .spinner {
            width: 12px;
            height: 12px;
            border: 2px solid var(--border);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .step-card {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 6px;
            overflow: hidden;
            transition: all 0.2s;
            margin-bottom: 8px;
        }

        .step-card:hover {
            background: var(--card-hover);
            border-color: var(--accent);
        }

        .step-card.hidden {
            opacity: 0.5;
            border-color: #555;
        }

        .step-card.collapsed {
            padding: 0;
        }

        .step-header {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px;
            background: var(--card);
            cursor: pointer;
            user-select: none;
            transition: background 0.2s;
        }

        .step-header:hover {
            background: var(--card-hover);
        }

        .step-collapse-toggle {
            width: 16px;
            height: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            color: var(--text-dim);
            transition: transform 0.2s;
            flex-shrink: 0;
        }

        .step-card.collapsed .step-collapse-toggle {
            transform: rotate(0deg);
        }

        .step-card:not(.collapsed) .step-collapse-toggle {
            transform: rotate(90deg);
        }

        .step-num {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            font-size: 10px;
            font-weight: bold;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--accent);
            flex-shrink: 0;
        }

        .step-header-content {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 8px;
            min-width: 0;
        }

        .step-title-input {
            background: transparent;
            border: 1px solid transparent;
            padding: 0;
            color: var(--text);
            font-size: 12px;
            font-weight: 600;
            border-radius: 3px;
            flex: 1;
            min-width: 0;
        }

        .step-title-input:hover {
            border-color: var(--border);
        }

        .step-title-input:focus {
            outline: none;
            border-color: var(--accent);
            background: rgba(100, 108, 255, 0.1);
        }

        .step-helper-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 2px 8px;
            background: rgba(100, 108, 255, 0.15);
            border: 1px solid rgba(100, 108, 255, 0.3);
            border-radius: 12px;
            font-size: 9px;
            color: var(--accent);
            font-weight: 600;
            white-space: nowrap;
            flex-shrink: 0;
        }

        .step-actions {
            display: flex;
            gap: 6px;
            flex-shrink: 0;
        }

        .step-btn {
            width: 22px;
            height: 22px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 11px;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .step-btn-visibility {
            background: rgba(100, 200, 255, 0.2);
            color: #64c8ff;
        }

        .step-btn-visibility:hover {
            background: rgba(100, 200, 255, 0.4);
        }

        .step-btn-visibility.hidden {
            background: rgba(100, 100, 100, 0.2);
            color: #666;
            opacity: 0.5;
        }

        .step-btn-remove {
            background: rgba(255, 100, 100, 0.2);
            color: var(--error);
        }

        .step-btn-remove:hover {
            background: rgba(255, 100, 100, 0.4);
        }

        .step-body {
            display: flex;
            flex-direction: column;
            gap: 8px;
            padding: 12px;
            border-top: 1px solid var(--border);
            max-height: 2000px;
            overflow: hidden;
            transition: max-height 0.3s ease, opacity 0.3s ease;
            opacity: 1;
        }

        .step-card.collapsed .step-body {
            max-height: 0;
            padding: 0 12px;
            opacity: 0;
            pointer-events: none;
        }

        .field-group {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .field-label {
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            color: var(--text-dim);
        }

        .helper-select {
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid var(--border);
            border-radius: 4px;
            padding: 6px 10px;
            color: var(--text);
            font-size: 11px;
            cursor: pointer;
        }

        .helper-select:hover {
            border-color: var(--accent);
        }

        .helper-select:focus {
            outline: none;
            border-color: var(--accent);
        }

      /* Helper Info Box Styling */
.helper-info-box {
    background: rgba(0, 0, 0, 0.3); /* Darker background */
    border-left: 3px solid var(--accent); /* Accent color bar */
    padding: 10px;
    margin: 8px 0;
    border-radius: 0 4px 4px 0;
    font-size: 12px;
}

.helper-description {
    color: var(--text-dim);
    line-height: 1.4;
    margin-bottom: 8px;
    font-style: italic;
}

.helper-meta-tags {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
}

.helper-tag {
    background: var(--border);
    color: var(--text);
    padding: 2px 8px;
    border-radius: 10px;
    font-size: 10px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    font-weight: 600;
}

.helper-tag.output { color: var(--accent); }

      /* New container for all parameters */
.params-container {
    margin-top: 8px;
    border-top: 1px solid var(--border);
    padding-top: 8px;
}

/* Individual parameter row */
.param-row {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 6px;
}

.param-label {
    width: 80px;
    font-size: 11px;
    color: var(--text-dim);
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

/* The "fx" toggle button */
.param-toggle {
    width: 22px;
    height: 22px;
    background: transparent;
    border: 1px solid var(--border);
    color: var(--text-dim);
    border-radius: 3px;
    cursor: pointer;
    font-size: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0;
    flex-shrink: 0;
}

.param-toggle.active {
    background: var(--accent);
    color: white;
    border-color: var(--accent);
}

/* The input field */
.param-input {
    flex: 1;
    background: rgba(0, 0, 0, 0.3);
    border: 1px solid var(--border);
    color: var(--text);
    border-radius: 3px;
    padding: 4px 8px;
    font-size: 11px;
    min-width: 0; 
}

.param-input.expression {
    color: #a5b3ce; /* Light blue for code */
    font-family: monospace;
}


        .timeline-controls {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
        }

        .timeline-btn {
            padding: 6px 12px;
            background: rgba(100, 108, 255, 0.2);
            border: 1px solid var(--border);
            border-radius: 4px;
            color: var(--accent);
            cursor: pointer;
            font-size: 10px;
            font-weight: 600;
            transition: all 0.2s;
        }

        .timeline-btn:hover {
            background: rgba(100, 108, 255, 0.4);
        }

        .material-item {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 12px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 8px;
        }

        .material-item:hover {
            background: var(--card-hover);
        }

        .material-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .material-btn {
            padding: 4px 8px;
            background: rgba(100, 108, 255, 0.2);
            border: none;
            border-radius: 3px;
            color: var(--accent);
            cursor: pointer;
            font-size: 10px;
        }

        .material-btn:hover {
            background: rgba(100, 108, 255, 0.4);
        }

        .material-delete {
            background: rgba(255, 100, 100, 0.2);
            color: var(--error);
        }

        .material-delete:hover {
            background: rgba(255, 100, 100, 0.4);
        }

        .json-container {
            display: flex;
            flex-direction: column;
            height: 100%;
            gap: 10px;
        }

        textarea.json-input {
            flex: 1;
            background: #111;
            border: 1px solid var(--border);
            border-radius: 4px;
            padding: 10px;
            color: #0f0;
            font-family: monospace;
            font-size: 10px;
            resize: none;
        }

        textarea.json-input:focus {
            outline: none;
            border-color: var(--accent);
        }

        .json-buttons {
            display: flex;
            gap: 8px;
        }

        .json-btn {
            flex: 1;
            padding: 8px;
            background: rgba(100, 108, 255, 0.2);
            border: 1px solid var(--accent);
            border-radius: 4px;
            color: var(--accent);
            cursor: pointer;
            font-weight: 600;
        }

        .json-btn:hover {
            background: rgba(100, 108, 255, 0.4);
        }
    </style>
</head>
<body>
    <div class="app">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="header">
                <h1>ðŸ”® Spellshape</h1>
                <div class="view-controls">
                    <button class="view-btn active" data-view="schema" title="Schema">S</button>
                    <button class="view-btn" data-view="actions" title="Actions">A</button>
                </div>
            </div>

            <div class="tabs">
                <div class="tab active" data-tab="globals" onclick="window.setTab('globals')">Globals</div>
                <div class="tab" data-tab="timeline" onclick="window.setTab('timeline')">Timeline</div>
                <div class="tab" data-tab="materials" onclick="window.setTab('materials')">Materials</div>
                <div class="tab" data-tab="json" onclick="window.setTab('json')">JSON</div>
            </div>

            <!-- GLOBALS TAB -->
            <div class="content active" id="tab-globals">
                <div class="globals-container" id="globals-container"></div>
                <button class="btn primary" onclick="window.addGlobalParam()" style="width: 100%; margin-top: 12px;">+ Add Global Parameter</button>
            </div>

            <!-- MATERIALS TAB -->
            <div class="content" id="tab-materials">
                <div id="materials-container"></div>
                <button class="btn primary" onclick="window.addMaterial()" style="width: 100%; margin-top: 12px;">+ Add Material</button>
            </div>

            <!-- TIMELINE TAB -->
            <div class="content" id="tab-timeline">
                <div class="timeline-controls">
                    <button class="timeline-btn" onclick="window.expandAllSteps()">Expand All</button>
                    <button class="timeline-btn" onclick="window.collapseAllSteps()">Collapse All</button>
                </div>
                <div id="timeline-container"></div>
                <button class="btn primary" onclick="window.addStep()" style="width: 100%; margin-top: 12px;">+ Add Action</button>
            </div>

            <!-- JSON TAB -->
            <div class="content" id="tab-json">
                <div class="json-container">
                    <textarea class="json-input" id="json-input" spellcheck="false"></textarea>
                    <div class="json-buttons">
                        <button class="json-btn" onclick="window.importJSON()">Import</button>
                        <button class="json-btn" onclick="window.exportJSON()">Export</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 3D Canvas -->
        <div class="canvas-container">
            <canvas id="canvas"></canvas>
            <div class="status-bar">
                <div class="status-item">
                    <span id="status-text">Ready</span>
                </div>
                <div class="status-item" id="status-spinner" style="display: none;">
                    <div class="spinner"></div>
                    <span>Generating...</span>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        import ProceduralExecutor from './src/modules/interpreter/procedural-executor2.js';

        // =========================================================================
        // IMPORT HELPERS REGISTRY
        // =========================================================================
        const helpersRegistryResponse = await fetch('./src/modules/interpreter/helpers_registry.json');
        const helpersRegistry = await helpersRegistryResponse.json();
        console.log(`âœ… Loaded ${helpersRegistry.length} helpers from registry`);

      // Tracks which fields are explicitly set to expression mode
const expressionState = {}; 

        // =========================================================================
        // REGISTER HELPERS FROM JSON REGISTRY
        // =========================================================================
        function registerJSONHelpers(executor, registry) {
            const definitions = {};
            registry.forEach(entry => {
                if (entry.id && entry.code) {
                    definitions[entry.id] = { code: entry.code };
                }
            });
            executor.registerDynamicHelpers(definitions);
            console.log(`âœ… Registered ${Object.keys(definitions).length} helpers from JSON registry`);
        }

      // =========================================================================
        // EXTRACT FONTS
        // =========================================================================
      function extractFontPathsFromSchema(schema) {
    const fonts = new Set();
    
    // Collect fonts from all actions
    if (schema.actions && Array.isArray(schema.actions)) {
        schema.actions.forEach(action => {
            if (action.params && action.params.font) {
                fonts.add(action.params.font);
                console.log(`ðŸ“ Font reference found: ${action.params.font}`);
            }
        });
    }
    
    return Array.from(fonts);
}

        // =========================================================================
        // THREE.JS SCENE SETUP
        // =========================================================================
        const canvas = document.getElementById('canvas');
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x0a0a0c);

        const camera = new THREE.PerspectiveCamera(
            75,
            canvas.clientWidth / canvas.clientHeight,
            0.1,
            10000
        );
        camera.position.set(0, 0, 5);

        const renderer = new THREE.WebGLRenderer({ canvas, antialias: true });
        renderer.setSize(canvas.clientWidth, canvas.clientHeight);
        renderer.setPixelRatio(window.devicePixelRatio);

        const controls = new OrbitControls(camera, canvas);
        controls.enableDamping = true;
        controls.dampingFactor = 0.05;

        // Lights
        const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
        scene.add(ambientLight);

        const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
        directionalLight.position.set(5, 10, 7);
        scene.add(directionalLight);

        // =========================================================================
        // EXECUTOR INITIALIZATION
        // =========================================================================
        const executor = new ProceduralExecutor(scene, THREE);
        registerJSONHelpers(executor, helpersRegistry);

        // =========================================================================
        // UI STATE
        // =========================================================================
        let currentGroup = null;
        let schema = {
            version: 4.0,
            intent: 'Custom Procedure',
            materials: {
                default: { color: '#888888', roughness: 0.7, metalness: 0.1 },
                gold: { color: '#FFD700', roughness: 0.2, metalness: 0.8 }
            },
            globalParameters: {
                scale: { value: 1, type: 'number', min: 0.1, max: 5 }
            },
            actions: []
        };

        let collapseState = {};

        // =========================================================================
        // TAB MANAGEMENT (GLOBAL)
        // =========================================================================
        window.setTab = function(name) {
            document.querySelectorAll('.tab').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.content').forEach(el => el.classList.remove('active'));
            
            document.querySelector(`[data-tab="${name}"]`).classList.add('active');
            document.getElementById(`tab-${name}`).classList.add('active');
            
            if (name === 'json') {
                window.exportJSON();
            }
        };

        // =========================================================================
        // TIMELINE MANAGEMENT (GLOBAL)
        // =========================================================================
        window.addStep = function(afterIndex = -1) {
            const newStep = {
                thought: 'New Step',
                do: 'createBox',
                params: { width: 1, height: 1, depth: 1 },
                as: `step_${Date.now()}`,
                material: 'default',
                visible: true
            };
            
            if (afterIndex >= 0) {
                schema.actions.splice(afterIndex + 1, 0, newStep);
            } else {
                schema.actions.push(newStep);
            }
            
            window.renderTimeline();
            window.run();
        };

        window.removeStep = function(index) {
            schema.actions.splice(index, 1);
            delete collapseState[index];
            window.renderTimeline();
            window.run();
        };

        window.toggleStepCollapse = function(index) {
            collapseState[index] = !collapseState[index];
            window.renderTimeline();
        };

        window.toggleStepVisibility = function(index) {
            schema.actions[index].visible = !schema.actions[index].visible;
            window.renderTimeline();
            window.run();
        };

        window.expandAllSteps = function() {
            for (let i = 0; i < schema.actions.length; i++) {
                collapseState[i] = false;
            }
            window.renderTimeline();
        };

        window.collapseAllSteps = function() {
            for (let i = 0; i < schema.actions.length; i++) {
                collapseState[i] = true;
            }
            window.renderTimeline();
        };

        window.updateStepField = function(index, field, value) {
            if (field === 'thought') {
                schema.actions[index].thought = value;
            } else if (field === 'do') {
                schema.actions[index].do = value;
                schema.actions[index].params = getHelperParams(value);
            } else if (field === 'as') {
                schema.actions[index].as = value;
            } else if (field === 'material') {
                schema.actions[index].material = value;
            } else if (field.startsWith('param-')) {
                const paramKey = field.replace('param-', '');
                schema.actions[index].params[paramKey] = value;
            }
            
            window.renderTimeline();
            window.run();
        };

        function getHelperParams(helperName) {
            // Look up helper in registry
            const helperEntry = helpersRegistry.find(entry => entry.id === helperName);
            if (!helperEntry || !helperEntry.paramsSchema) {
                return {};
            }
            
            // Extract default values from paramsSchema
            const defaults = {};
            for (const [key, schema] of Object.entries(helperEntry.paramsSchema)) {
                defaults[key] = schema.default !== undefined ? schema.default : 0;
            }
            return defaults;
        }

        function getHelperParamSchema(helperName) {
            // 1. Check STATIC registry
    const helperEntry = helpersRegistry.find(entry => entry.id === helperName);
    if (helperEntry && helperEntry.paramsSchema) return helperEntry.paramsSchema;

    // 2. Check DYNAMIC schema definitions (Add this!)
    if (schema && schema.definitions && schema.definitions[helperName] && schema.definitions[helperName].paramsSchema) {
        return schema.definitions[helperName].paramsSchema;
    }

    return {};
        }

        function getMaterialColor(materialName) {
            if (schema.materials && schema.materials[materialName]) {
                return schema.materials[materialName].color;
            }
            return '#888888';
        }

        window.renderTimeline = function() {
    const container = document.getElementById('timeline-container');
    container.innerHTML = '';
    
    schema.actions.forEach((action, i) => {
        const card = document.createElement('div');
        card.className = 'step-card';
        
        if (!action.visible) card.classList.add('hidden');
        if (collapseState[i]) card.classList.add('collapsed');
        
        // HEADER
        const headerDiv = document.createElement('div');
        headerDiv.className = 'step-header';
        headerDiv.onclick = () => window.toggleStepCollapse(i);
        
        const toggleIcon = document.createElement('div');
        toggleIcon.className = 'step-collapse-toggle';
        toggleIcon.innerText = 'â–¶';
        headerDiv.appendChild(toggleIcon);
        
        const stepNum = document.createElement('div');
        stepNum.className = 'step-num';
        stepNum.style.backgroundColor = getMaterialColor(action.material);
        stepNum.innerText = i + 1;
        headerDiv.appendChild(stepNum);
        
        const headerContent = document.createElement('div');
        headerContent.className = 'step-header-content';
        
        const titleInput = document.createElement('input');
        titleInput.className = 'step-title-input';
        titleInput.type = 'text';
        titleInput.value = action.thought;
        titleInput.placeholder = 'Step description';
        titleInput.onclick = (e) => e.stopPropagation();
        titleInput.onchange = (e) => window.updateStepField(i, 'thought', e.target.value);
        headerContent.appendChild(titleInput);
        
        const helperBadge = document.createElement('div');
        helperBadge.className = 'step-helper-badge';
        
        // Look up helper metadata from registry
        const helperEntry = helpersRegistry.find(entry => entry.id === action.do);

        if (helperEntry) {
            helperBadge.innerText = action.do || 'None';
            if (helperEntry.description) helperBadge.title = helperEntry.description;
            if (helperEntry.category) {
                 const catSpan = document.createElement('span');
                 // You can style this if you want, or just keep it simple
                 helperBadge.appendChild(catSpan);
            }
        } else {
            helperBadge.innerText = action.do || 'None';
        }

        headerContent.appendChild(helperBadge);
        headerDiv.appendChild(headerContent);
        
        const actions = document.createElement('div');
        actions.className = 'step-actions';
        
        const visBtn = document.createElement('button');
        visBtn.className = 'step-btn step-btn-visibility' + (!action.visible ? ' hidden' : '');
        visBtn.innerText = 'ðŸ‘';
        visBtn.onclick = (e) => { e.stopPropagation(); window.toggleStepVisibility(i); };
        actions.appendChild(visBtn);
        
        const delBtn = document.createElement('button');
        delBtn.className = 'step-btn step-btn-remove';
        delBtn.innerText = 'âœ•';
        delBtn.onclick = (e) => { e.stopPropagation(); window.removeStep(i); };
        actions.appendChild(delBtn);
        
        headerDiv.appendChild(actions);
        card.appendChild(headerDiv);
        
        // BODY
        const bodyDiv = document.createElement('div');
        bodyDiv.className = 'step-body';
        
        // Helper select
        const helperGroup = document.createElement('div');
        helperGroup.className = 'field-group';
        
        const helperLabel = document.createElement('label');
        helperLabel.className = 'field-label';
        helperLabel.innerText = 'Helper';
        helperGroup.appendChild(helperLabel);
        
        const helperSelect = document.createElement('select');
        helperSelect.className = 'helper-select';
        helperSelect.onchange = (e) => window.updateStepField(i, 'do', e.target.value);
        
        const placeholderOpt = document.createElement('option');
        placeholderOpt.value = '';
        placeholderOpt.text = '-- Select Helper --';
        helperSelect.appendChild(placeholderOpt);
        
        const helperNames = Array.from(executor.dynamicHelpers.keys()).sort();
        helperNames.forEach(helperName => {
            const opt = document.createElement('option');
            opt.value = helperName;
            opt.text = helperName;
            if (action.do === helperName) opt.selected = true;
            helperSelect.appendChild(opt);
        });
        
        helperGroup.appendChild(helperSelect);
        bodyDiv.appendChild(helperGroup);

        // Info Box
        if (action.do) {
            const helperEntry = helpersRegistry.find(entry => entry.id === action.do);
            
            if (helperEntry) {
                const infoBox = document.createElement('div');
                infoBox.className = 'helper-info-box';
                
                if (helperEntry.description) {
                    const desc = document.createElement('div');
                    desc.className = 'helper-description';
                    desc.innerText = helperEntry.description;
                    infoBox.appendChild(desc);
                }
                
                const tags = document.createElement('div');
                tags.className = 'helper-meta-tags';
                
                if (helperEntry.outputType) {
                    const outputTag = document.createElement('div');
                    outputTag.className = 'helper-tag output';
                    outputTag.innerText = `Output: ${helperEntry.outputType}`;
                    tags.appendChild(outputTag);
                }
                
                if (helperEntry.category) {
                    const catTag = document.createElement('div');
                    catTag.className = 'helper-tag';
                    catTag.innerText = `Category: ${helperEntry.category}`;
                    tags.appendChild(catTag);
                }
                
                infoBox.appendChild(tags);
                bodyDiv.appendChild(infoBox);
            }
        }
        
        // Output name
        const asGroup = document.createElement('div');
        asGroup.className = 'field-group';
        const asInput = document.createElement('input');
        asInput.type = 'text';
        asInput.className = 'helper-select';
        asInput.value = action.as;
        asInput.placeholder = 'Output name';
        asInput.onchange = (e) => window.updateStepField(i, 'as', e.target.value);
        asGroup.innerHTML = '<label class="field-label">Output As</label>';
        asGroup.appendChild(asInput);
        bodyDiv.appendChild(asGroup);
        
        // Parameters
        const paramSchema = getHelperParamSchema(action.do);
        
        const paramsContainer = document.createElement('div');
        paramsContainer.className = 'params-container';
        bodyDiv.appendChild(paramsContainer);

        // 1. Pre-calculate available geometries from PREVIOUS steps for dropdowns
        const availableGeometries = [];
        schema.actions.forEach((act, idx) => {
            if (idx < i && act.as) { // Only show outputs from steps BEFORE this one
                availableGeometries.push(act.as);
            }
        });

        // 2. Iterate over parameters
        for (const [key, paramSchemaDef] of Object.entries(paramSchema)) {
            // Get Current Value
            let paramVal = action.params && action.params[key] !== undefined 
                ? action.params[key] 
                : (paramSchemaDef.default !== undefined ? paramSchemaDef.default : '');

            // Determine Mode (Expression vs Value)
            const stateKey = `${i}-${key}`;
            const isExplicitExpression = expressionState[stateKey] === true;
            const isImplicitExpression = typeof paramVal === 'string' && isNaN(Number(paramVal)) && paramVal !== '';
            const isExpression = isExplicitExpression || isImplicitExpression;

            const row = document.createElement('div');
            row.className = 'param-row';

            // Label
            const label = document.createElement('div');
            label.className = 'param-label';
            label.title = key;
            label.innerText = key;
            row.appendChild(label);

            // Toggle Button (fx)
            const toggleBtn = document.createElement('button');
            toggleBtn.className = `param-toggle ${isExpression ? 'active' : ''}`;
            toggleBtn.innerText = 'fx';
            toggleBtn.title = 'Toggle Expression';
            
            toggleBtn.onclick = (e) => {
                e.stopPropagation();
                expressionState[stateKey] = !isExpression;
                
                // When switching MODES, we might need to type-cast
                // (Logic simplified here: let the re-render handle the UI state change)
                window.renderTimeline();
            };
            row.appendChild(toggleBtn);

            // --- INPUT FIELD LOGIC ---
            
            // Check if this param is likely a geometry reference
            const isGeometryField = ['geometry', 'profile', 'path', 'curve', 'target', 'lookAt', 'points'].includes(key);
            
            if (isGeometryField && !isExpression) {
                // CASE A: GEOMETRY SELECT DROPDOWN
                const select = document.createElement('select');
                select.className = 'param-input';
                
                // Placeholder option
                const emptyOpt = document.createElement('option');
                emptyOpt.value = "";
                emptyOpt.innerText = "-- Select Geometry --";
                select.appendChild(emptyOpt);
                
                // Populate from previous steps
                let foundCurrent = false;
                availableGeometries.forEach(geoName => {
                    const opt = document.createElement('option');
                    opt.value = geoName;
                    opt.innerText = geoName;
                    if (paramVal === geoName) {
                        opt.selected = true;
                        foundCurrent = true;
                    }
                    select.appendChild(opt);
                });

                // If the current value isn't in the list (e.g. external var), add it so it's not lost
                if (paramVal && !foundCurrent && typeof paramVal === 'string') {
                    const opt = document.createElement('option');
                    opt.value = paramVal;
                    opt.innerText = `${paramVal} (External)`;
                    opt.selected = true;
                    select.appendChild(opt);
                }

                select.onchange = (e) => window.updateStepField(i, `param-${key}`, e.target.value);
                row.appendChild(select);

            } else {
                // CASE B: STANDARD INPUT (Text/Number/Checkbox)
                const input = document.createElement('input');
                input.className = `param-input ${isExpression ? 'expression' : ''}`;
                
                if (isExpression) {
                    // Expression Mode: Always Text
                    input.type = 'text';
                    input.value = typeof paramVal === 'object' ? JSON.stringify(paramVal) : paramVal;
                    input.placeholder = 'Expression (e.g. ctx.w * 2)';
                } else {
                    // Value Mode: Check type
                    if (paramSchemaDef.type === 'boolean') {
                        input.type = 'checkbox';
                        input.checked = !!paramVal;
                        input.style.flex = 'none';
                    } else {
                        input.type = 'number';
                        input.step = 'any';
                        input.value = paramVal;
                    }
                }

                // Unified Change Handler
                input.onchange = (e) => {
                    let val = input.type === 'checkbox' ? input.checked : e.target.value;

                    if (isExpression) {
                        // Try to parse arrays/objects automatically
                        try {
                            const trimmed = String(val).trim();
                            if (trimmed.startsWith('[') || trimmed.startsWith('{')) {
                                val = JSON.parse(trimmed);
                            }
                        } catch (err) {
                            // It's a string expression (e.g. "ctx.x + 10")
                        }
                    } else if (input.type === 'number') {
                         // Parse number, fallback to default if invalid
                        const parsed = parseFloat(val);
                        val = isNaN(parsed) ? (paramSchemaDef.default || 0) : parsed;
                    }

                    window.updateStepField(i, `param-${key}`, val);
                };
                
                row.appendChild(input);
            }
            
            paramsContainer.appendChild(row);
        }
        
        // Material
        const matGroup = document.createElement('div');
        matGroup.className = 'field-group';
        matGroup.innerHTML = '<label class="field-label">Material</label>';
        const matSelect = document.createElement('select');
        matSelect.className = 'helper-select';
        matSelect.disabled = !action.visible;
        
        matSelect.onchange = (e) => window.updateStepField(i, 'material', e.target.value);
        
        // Note: schema.materials must exist globally or be passed in
        if (schema && schema.materials) {
             for (const matName in schema.materials) {
                const opt = document.createElement('option');
                opt.value = matName;
                opt.innerText = matName;
                matSelect.appendChild(opt);
            }
        }

      matSelect.value = action.material || 'default';
       
        matGroup.appendChild(matSelect);
        bodyDiv.appendChild(matGroup);
        
        card.appendChild(bodyDiv);
        container.appendChild(card);
    });
};


        // =========================================================================
        // MATERIALS MANAGEMENT (GLOBAL)
        // =========================================================================
        window.addMaterial = function() {
            const name = `material_${Date.now()}`;
            schema.materials[name] = { color: '#888888', roughness: 0.7, metalness: 0.1 };
            window.renderMaterials();
        };

        window.removeMaterial = function(name) {
            delete schema.materials[name];
            window.renderMaterials();
        };

        window.updateMaterial = function(name, prop, value) {
            schema.materials[name][prop] = value;
            window.renderMaterials();
            window.renderTimeline();
            window.run();
        };

        window.renderMaterials = function() {
            const container = document.getElementById('materials-container');
            container.innerHTML = '';
            
            for (const [name, material] of Object.entries(schema.materials)) {
                const item = document.createElement('div');
                item.className = 'material-item';
                
                const headerDiv = document.createElement('div');
                headerDiv.className = 'material-header';
                
                const nameInput = document.createElement('input');
                nameInput.type = 'text';
                nameInput.style.background = 'rgba(255, 255, 255, 0.05)';
                nameInput.style.border = '1px solid var(--border)';
                nameInput.style.borderRadius = '4px';
                nameInput.style.padding = '6px 10px';
                nameInput.style.color = 'var(--text)';
                nameInput.style.fontSize = '11px';
                nameInput.style.flex = '1';
                nameInput.style.marginRight = '8px';
                nameInput.value = name;
                nameInput.onchange = (e) => {
                    const newName = e.target.value;
                    if (newName && newName !== name && !schema.materials[newName]) {
                        schema.materials[newName] = schema.materials[name];
                        delete schema.materials[name];
                        window.renderMaterials();
                        window.renderTimeline();
                    }
                };
                headerDiv.appendChild(nameInput);
                
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'material-btn material-delete';
                deleteBtn.innerText = 'âœ•';
                deleteBtn.onclick = () => window.removeMaterial(name);
                headerDiv.appendChild(deleteBtn);
                item.appendChild(headerDiv);
                
                // Color
                const colorDiv = document.createElement('div');
                colorDiv.style.display = 'flex';
                colorDiv.style.gap = '8px';
                colorDiv.style.alignItems = 'center';
                colorDiv.style.marginBottom = '8px';
                
                const colorLabel = document.createElement('label');
                colorLabel.style.fontSize = '10px';
                colorLabel.style.fontWeight = '600';
                colorLabel.style.color = 'var(--text-dim)';
                colorLabel.style.minWidth = '60px';
                colorLabel.innerText = 'Color';
                colorDiv.appendChild(colorLabel);
                
                const colorInput = document.createElement('input');
                colorInput.type = 'color';
                colorInput.value = material.color;
                colorInput.style.cursor = 'pointer';
                colorInput.style.width = '40px';
                colorInput.style.height = '30px';
                colorInput.style.border = '1px solid var(--border)';
                colorInput.style.borderRadius = '4px';
                colorInput.onchange = (e) => window.updateMaterial(name, 'color', e.target.value);
                colorDiv.appendChild(colorInput);
                
                item.appendChild(colorDiv);
                
                // Roughness
                const roughDiv = document.createElement('div');
                roughDiv.style.marginBottom = '8px';
                roughDiv.innerHTML = `
                    <div style="display: flex; justify-content: space-between; font-size: 10px; margin-bottom: 4px; color: var(--text-dim)">
                        <span>Roughness</span>
                        <span style="color: var(--accent); font-family: monospace">${material.roughness.toFixed(2)}</span>
                    </div>
                `;
                const roughSlider = document.createElement('input');
                roughSlider.type = 'range';
                roughSlider.min = '0';
                roughSlider.max = '1';
                roughSlider.step = '0.01';
                roughSlider.value = material.roughness;
                roughSlider.style.width = '100%';
                roughSlider.style.cursor = 'pointer';
                roughSlider.onchange = (e) => window.updateMaterial(name, 'roughness', parseFloat(e.target.value));
                roughDiv.appendChild(roughSlider);
                item.appendChild(roughDiv);
                
                // Metalness
                const metalDiv = document.createElement('div');
                metalDiv.innerHTML = `
                    <div style="display: flex; justify-content: space-between; font-size: 10px; margin-bottom: 4px; color: var(--text-dim)">
                        <span>Metalness</span>
                        <span style="color: var(--accent); font-family: monospace">${material.metalness.toFixed(2)}</span>
                    </div>
                `;
                const metalSlider = document.createElement('input');
                metalSlider.type = 'range';
                metalSlider.min = '0';
                metalSlider.max = '1';
                metalSlider.step = '0.01';
                metalSlider.value = material.metalness;
                metalSlider.style.width = '100%';
                metalSlider.style.cursor = 'pointer';
                metalSlider.onchange = (e) => window.updateMaterial(name, 'metalness', parseFloat(e.target.value));
                metalDiv.appendChild(metalSlider);
                item.appendChild(metalDiv);
                
                container.appendChild(item);
            }
        };

        // =========================================================================
        // GLOBALS MANAGEMENT (GLOBAL)
        // =========================================================================
        window.addGlobalParam = function() {
            const key = `param_${Date.now()}`;
            schema.globalParameters[key] = { value: 5, type: 'number', min: 0, max: 100 };
            window.renderGlobals();
        };

        window.removeGlobalParam = function(key) {
            delete schema.globalParameters[key];
            window.renderGlobals();
            window.renderTimeline();
            window.run();
        };

        window.updateGlobalParam = function(key, field, value) {
            if (field === 'value') {
                schema.globalParameters[key].value = parseFloat(value) || 0;
            } else if (field === 'min') {
                schema.globalParameters[key].min = parseFloat(value) || 0;
            } else if (field === 'max') {
                schema.globalParameters[key].max = parseFloat(value) || 100;
            } else if (field === 'key') {
                schema.globalParameters[value] = schema.globalParameters[key];
                delete schema.globalParameters[key];
                window.renderGlobals();
                return;
            }
            window.renderGlobals();
            window.run();
        };

        window.renderGlobals = function() {
            const container = document.getElementById('globals-container');
            container.innerHTML = '';
            
            for (const [key, param] of Object.entries(schema.globalParameters)) {
                const group = document.createElement('div');
                group.className = 'global-group';
                
                const headerHtml = `<div class="global-header"><span>${param.group || 'Parameters'}</span><button class="btn-add-global" onclick="window.removeGlobalParam('${key}')">âœ•</button></div>`;
                group.innerHTML = headerHtml;
                
                const nameInput = document.createElement('input');
                nameInput.type = 'text';
                nameInput.value = key;
                nameInput.style.marginBottom = '8px';
                nameInput.className = 'helper-select';
                nameInput.onchange = (e) => window.updateGlobalParam(key, 'key', e.target.value);
                group.appendChild(nameInput);
                
                const sliderDiv = document.createElement('div');
                sliderDiv.className = 'global-slider-group';
                sliderDiv.innerHTML = `
                    <div class="slider-header">
                        <span>Value</span>
                        <span class="slider-value">${param.value.toFixed(2)}</span>
                    </div>
                `;
                const slider = document.createElement('input');
                slider.type = 'range';
                slider.min = param.min || 0;
                slider.max = param.max || 100;
                slider.step = '0.1';
                slider.value = param.value;
                slider.onchange = (e) => window.updateGlobalParam(key, 'value', e.target.value);
                sliderDiv.appendChild(slider);
                group.appendChild(sliderDiv);
                
                container.appendChild(group);
            }
        };

        // =========================================================================
        // JSON IMPORT/EXPORT (GLOBAL)
        // =========================================================================
        window.exportJSON = function() {
            document.getElementById('json-input').value = JSON.stringify(schema, null, 2);
        };

        window.importJSON = function() {
            try {
                schema = JSON.parse(document.getElementById('json-input').value);
                window.setTab('globals');
                window.renderGlobals();
                window.renderTimeline();
                window.renderMaterials();
                window.run();
                alert('âœ… Schema imported!');
            } catch (e) {
                alert('âŒ Invalid JSON: ' + e.message);
            }
        };


      // Extract fonts from schema
window.extractFontsFromSchema = function(schema) {
    const fonts = new Set();
    
    // Check both procedures and actions format
    if (schema.procedures?.length) {
        schema.procedures.forEach(proc => {
            proc.steps?.forEach(step => {
                if (step.params?.font) fonts.add(step.params.font);
            });
        });
    }
    
    if (schema.actions?.length) {
        schema.actions.forEach(action => {
            if (action.params?.font) fonts.add(action.params.font);
        });
    }
    
    return Array.from(fonts);
};

        // =========================================================================
        // EXECUTION (GLOBAL)
        // =========================================================================
        window.run = async function() {

          // Add font extraction
    const fonts = window.extractFontsFromSchema(schema);
    if (fonts.length > 0) {
        schema.fonts = fonts;  // Tell executor which fonts to load
    }
          
            if (currentGroup) scene.remove(currentGroup);
            
            try {
                const params = {};
                for (const key in schema.globalParameters) {
                    params[key] = schema.globalParameters[key].value;
                }
                
                currentGroup = await executor.execute(schema, params);
                scene.add(currentGroup);
                
                let meshCount = 0;
let triangleCount = 0;

currentGroup.traverse(c => {
  if (c.isMesh && c.geometry) {
    meshCount++;
    const geom = c.geometry;
    const pos = geom.attributes && geom.attributes.position;
    if (!pos) return;

    if (geom.index) {
      // Indexed: each 3 indices is one triangle
      triangleCount += geom.index.count / 3;
    } else {
      // Non-indexed: each 3 positions is one triangle
      triangleCount += pos.count / 3;
    }
  }
});

const statusEl = document.getElementById('status-text');
if (statusEl) {
  statusEl.textContent =
    `Meshes: ${meshCount}  |  Triangles: ${Math.round(triangleCount).toLocaleString()}`;
}
            } catch (e) {
                document.getElementById('status-text').textContent = `Error: ${e.message.substring(0, 30)}`;
                console.error(e);
            }
        };

        // =========================================================================
        // INITIALIZATION
        // =========================================================================
        window.renderGlobals();
        window.renderTimeline();
        window.renderMaterials();
        window.run();

        // =========================================================================
        // ANIMATION LOOP
        // =========================================================================
        function animate() {
            requestAnimationFrame(animate);
            controls.update();
            renderer.render(scene, camera);
        }
        animate();

        // Handle window resize
        window.addEventListener('resize', () => {
            camera.aspect = canvas.clientWidth / canvas.clientHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(canvas.clientWidth, canvas.clientHeight);
        });
    </script>
</body>
</html>