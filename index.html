<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Spellshape Three Dev</title>
  <style>
    body {
      margin: 0;
      overflow: hidden;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }

    .container {
      flex: 1;
      width: 100%;
      display: flex;
    }

    canvas {
      display: block;
      flex: 1;
      width: 100%;
      height: 100%;
    }

    .controls {
      z-index: 2;
      position: absolute;
      top: 10px;
      right: 10px;
    }
  </style>
</head>

<body>
  <div class="container">
    <canvas id="canvas"></canvas>

    <div class="controls">
      <div class="control-item">
        <label>Width (0.1 - 5.0m)</label>
        <input type="range" id="cube_width" min="0.1" max="5" step="0.01" value="3">
        <span class="value-display" id="width_display">1.00m</span>
      </div>
    </div>
  </div>

  <div id="validation-panel"
    style="position: absolute; top: 10px; left: 10px; background: rgba(255,0,0,0.8); color: white; padding: 10px; display: none;">
  </div>
  <script type="module">
    import { start } from './src/index.js';

    // Example schema for testing
    const testSchema = {
  "version": "3.1",
  "type": "parametric_scene",
  "children": [
    {
      "type": "parametric_template",
      "id": "parametric_tower",
      "parameters": {
        "floors": {"value": 40, "type": "integer", "min": 5, "max": 60, "step": 1, "group": "structure"},
        "floor_height": {"value": 3, "type": "number", "min": 2, "max": 5, "step": 0.1, "group": "structure"},
        "total_twist": {"value": 90, "type": "number", "min": 0, "max": 180, "step": 5, "group": "structure"},
        "twist_zone": {"value": 35, "type": "number", "min": 10, "max": 90, "step": 5, "group": "structure"},
        "building_width": {"value": 25, "type": "number", "min": 10, "max": 50, "step": 1, "group": "structure"},
        "building_depth": {"value": 15, "type": "number", "min": 10, "max": 50, "step": 1, "group": "structure"},
        "panels_per_side_width": {"value": 15, "type": "integer", "min": 4, "max": 40, "step": 1, "group": "facade"},
        "panels_per_side_depth": {"value": 10, "type": "integer", "min": 4, "max": 40, "step": 1, "group": "facade"},
        "wall_depth": {"value": 0.8, "type": "number", "min": 0.1, "max": 1, "step": 0.05, "group": "facade"},
        "window_depth": {"value": 0.05, "type": "number", "min": 0.02, "max": 0.5, "step": 0.01, "group": "facade"},
        "core_width": {"value": 8, "type": "number", "min": 2, "max": 15, "step": 0.5, "group": "core"},
        "core_depth": {"value": 6, "type": "number", "min": 2, "max": 12, "step": 0.5, "group": "core"},
        "column_radius": {"value": 0.3, "type": "number", "min": 0.1, "max": 1, "step": 0.05, "group": "structure"},
        "columns_per_side": {"value": 3, "type": "integer", "min": 2, "max": 8, "step": 1, "group": "structure"},
        "column_offset": {"value": 2, "type": "number", "min": 1, "max": 8, "step": 0.2, "group": "structure"},
        "slab_thickness": {"value": 0.3, "type": "number", "min": 0.1, "max": 1, "step": 0.05, "group": "floors"}
      },
      "expressions": {
        "building_half_width": "$building_width / 2",
        "building_half_depth": "$building_depth / 2",
        "panel_width_on_width_facades": "$building_width / $panels_per_side_width",
        "panel_width_on_depth_facades": "$building_depth / $panels_per_side_depth",
        "twist_radians": "$total_twist * pi / 180",
        "twist_start": "(50 - $twist_zone/2) / 100",
        "twist_end": "(50 + $twist_zone/2) / 100",
        "front_start": "-$building_half_width",
        "back_start": "$building_half_width",
        "right_start": "$building_half_depth",
        "left_start": "-$building_half_depth"
      },
      "template": [
        {
          "type": "repeat",
          "id": "tower_floors",
          "count": "$floors",
          "instance_parameters": {
            "floor_idx": "$index",
            "normalized_pos": "$index / max(($floors - 1), 1)",
            "twist_progress": "clamp(($normalized_pos - $twist_start) / max(($twist_end - $twist_start), 0.01), 0, 1)",
            "floor_twist": "if($normalized_pos >= $twist_start && $normalized_pos <= $twist_end, $twist_radians * $twist_progress, if($normalized_pos > $twist_end, $twist_radians, 0))",
            "start_with": "if(mod($index, 2) == 0, \"wall\", \"window\")"
          },
          "distribution": {
            "type": "linear",
            "axis": "y",
            "start": "$floor_height/2",
            "step": "$floor_height"
          },
          "children": [
            {
              "type": "group",
              "id": "floor_group",
              "rotation": [0, "$floor_twist", 0],
              "children": [
                {
                  "type": "box",
                  "id": "core",
                  "material": "core",
                  "dimensions": ["$core_width", "$floor_height", "$core_depth"],
                  "position": [0, 0, 0]
                },
                {
                  "type": "repeat",
                  "id": "front_columns",
                  "count": "$columns_per_side",
                  "instance_parameters": {"col_pos": "$index"},
                  "distribution": {
                    "type": "linear",
                    "axis": "x",
                    "start": "-$building_half_width + $column_offset",
                    "step": "($building_width - $column_offset * 2) / max(($columns_per_side - 1), 1)"
                  },
                  "children": [
                    {
                      "type": "cylinder",
                      "id": "column_front",
                      "material": "column",
                      "dimensions": ["$column_radius", "$column_radius", "$floor_height"],
                      "position": [0, 0, "$building_half_depth - $column_offset"]
                    }
                  ]
                },
                {
                  "type": "repeat",
                  "id": "back_columns",
                  "count": "$columns_per_side",
                  "instance_parameters": {"col_pos": "$index"},
                  "distribution": {
                    "type": "linear",
                    "axis": "x",
                    "start": "$building_half_width - $column_offset",
                    "step": "-($building_width - $column_offset * 2) / max(($columns_per_side - 1), 1)"
                  },
                  "children": [
                    {
                      "type": "cylinder",
                      "id": "column_back",
                      "material": "column",
                      "dimensions": ["$column_radius", "$column_radius", "$floor_height"],
                      "position": [0, 0, "-$building_half_depth + $column_offset"]
                    }
                  ]
                },
                {
                  "type": "repeat",
                  "id": "left_columns",
                  "count": "max(($columns_per_side - 2), 0)",
                  "instance_parameters": {"col_pos": "$index + 1"},
                  "distribution": {
                    "type": "linear",
                    "axis": "z",
                    "start": "-$building_half_depth + $column_offset + ($building_depth - $column_offset * 2) / max(($columns_per_side - 1), 1)",
                    "step": "($building_depth - $column_offset * 2) / max(($columns_per_side - 1), 1)"
                  },
                  "children": [
                    {
                      "type": "cylinder",
                      "id": "column_left",
                      "material": "column",
                      "dimensions": ["$column_radius", "$column_radius", "$floor_height"],
                      "position": ["-$building_half_width + $column_offset", 0, 0]
                    }
                  ]
                },
                {
                  "type": "repeat",
                  "id": "right_columns",
                  "count": "max(($columns_per_side - 2), 0)",
                  "instance_parameters": {"col_pos": "$index + 1"},
                  "distribution": {
                    "type": "linear",
                    "axis": "z",
                    "start": "$building_half_depth - $column_offset - ($building_depth - $column_offset * 2) / max(($columns_per_side - 1), 1)",
                    "step": "-($building_depth - $column_offset * 2) / max(($columns_per_side - 1), 1)"
                  },
                  "children": [
                    {
                      "type": "cylinder",
                      "id": "column_right",
                      "material": "column",
                      "dimensions": ["$column_radius", "$column_radius", "$floor_height"],
                      "position": ["$building_half_width - $column_offset", 0, 0]
                    }
                  ]
                },
                {
                  "type": "helper3d",
                  "helper": "checkerboardPanels3D",
                  "params": {
                    "count": "$panels_per_side_width",
                    "wallWidth": "$panel_width_on_width_facades",
                    "windowWidth": "$panel_width_on_width_facades",
                    "height": "$floor_height",
                    "wallDepth": "$wall_depth",
                    "windowDepth": "$window_depth",
                    "origin": [0, 0, "$building_half_depth"],
                    "axis": "x",
                    "start": "$front_start",
                    "direction": 1,
                    "wallMaterial": "wall",
                    "windowMaterial": "window",
                    "startWith": "$start_with",
                    "id": "front_facade"
                  }
                },
                {
                  "type": "helper3d",
                  "helper": "checkerboardPanels3D",
                  "params": {
                    "count": "$panels_per_side_width",
                    "wallWidth": "$panel_width_on_width_facades",
                    "windowWidth": "$panel_width_on_width_facades",
                    "height": "$floor_height",
                    "wallDepth": "$wall_depth",
                    "windowDepth": "$window_depth",
                    "origin": [0, 0, "-$building_half_depth"],
                    "axis": "x",
                    "start": "$back_start",
                    "direction": -1,
                    "wallMaterial": "wall",
                    "windowMaterial": "window",
                    "startWith": "$start_with",
                    "id": "back_facade"
                  }
                },
                {
                  "type": "helper3d",
                  "helper": "checkerboardPanels3D",
                  "params": {
                    "count": "$panels_per_side_depth",
                    "wallWidth": "$panel_width_on_depth_facades",
                    "windowWidth": "$panel_width_on_depth_facades",
                    "height": "$floor_height",
                    "wallDepth": "$wall_depth",
                    "windowDepth": "$window_depth",
                    "origin": ["$building_half_width", 0, 0],
                    "axis": "z",
                    "start": "$right_start",
                    "direction": -1,
                    "wallMaterial": "wall",
                    "windowMaterial": "window",
                    "startWith": "$start_with",
                    "id": "right_facade"
                  }
                },
                {
                  "type": "helper3d",
                  "helper": "checkerboardPanels3D",
                  "params": {
                    "count": "$panels_per_side_depth",
                    "wallWidth": "$panel_width_on_depth_facades",
                    "windowWidth": "$panel_width_on_depth_facades",
                    "height": "$floor_height",
                    "wallDepth": "$wall_depth",
                    "windowDepth": "$window_depth",
                    "origin": ["-$building_half_width", 0, 0],
                    "axis": "z",
                    "start": "$left_start",
                    "direction": 1,
                    "wallMaterial": "wall",
                    "windowMaterial": "window",
                    "startWith": "$start_with",
                    "id": "left_facade"
                  }
                },
                {
  "type": "box",
  "id": "floor_slab_bottom",
  "material": "floor_slab",
  "dimensions": ["$building_width", "$slab_thickness", "$building_depth"],
  "position": [0, "-$floor_height/2 + $slab_thickness/2", 0]
},
{
  "type": "box",
  "id": "floor_slab_top",
  "material": "floor_slab",
  "dimensions": ["$building_width", "$slab_thickness", "$building_depth"],
  "position": [0, "$floor_height/2 - $slab_thickness/2", 0]
}
              ]
            }
          ]
        },
        {
          "type": "box",
          "id": "roof_slab",
          "material": "floor_slab",
          "dimensions": ["$building_width", "$slab_thickness", "$building_depth"],
          "position": [0, "$floor_height/2 + ($floors - 1) * $floor_height + $floor_height/2 + $slab_thickness/2", 0],
          "rotation": [0, "$twist_radians", 0]
        }
      ]
    }
  ],
  "materials": {
    "wall": {"type": "standard", "color": "#f9f9f9", "roughness": 0.7, "metalness": 0.1},
    "window": {"type": "standard", "color": "#f2f2f2", "roughness": 0.2, "metalness": 0, "opacity": 0.3},
    "core": {"type": "standard", "color": "#d94026", "roughness": 0.6, "metalness": 0.1},
    "column": {"type": "standard", "color": "#404040", "roughness": 0.8, "metalness": 0.2},
    "floor_slab": {"type": "standard", "color": "#a6a6a6", "roughness": 0.7, "metalness": 0.1}
  },
  "ui_controls": {
    "groups": {
      "structure": {"label": "ðŸ—ï¸ Structure", "order": 1, "default_open": true},
      "facade": {"label": "ðŸ¢ Facade", "order": 2, "default_open": false},
      "core": {"label": "ðŸ›ï¸ Core", "order": 3, "default_open": false},
      "floors": {"label": "ðŸ—ï¸ Floors", "order": 4, "default_open": false}
    }
  }
}




// Wait for DOM to be fully loaded
    document.addEventListener('DOMContentLoaded', async () => {
      const canvas = document.getElementById('canvas');
      let viewer = null;

      // Initialize the viewer
      async function initViewer() {
        try {
          viewer = await start(canvas, testSchema, true);
          console.log('Viewer initialized:', viewer);

          // Check if updateParameter is available
          if (viewer.updateParameter) {
            console.log('âœ… updateParameter function is available');
          } else {
            console.error('âŒ updateParameter function is NOT available');
          }
        } catch (error) {
          console.error('Error initializing viewer:', error);
        }
      }

      // Setup the single control
      function setupControl() {
        const heightInput = document.getElementById('cube_width');
        const heightDisplay = document.getElementById('width_display');

        // Check if elements exist
        if (!heightInput) {
          console.error('Height input element not found!');
          return;
        }
        if (!heightDisplay) {
          console.error('Height display element not found!');
          return;
        }

        console.log('âœ… Control elements found, setting up event listener');

        heightInput.addEventListener('input', (e) => {
          const value = parseFloat(e.target.value);

          // Update the 3D model using selective regeneration
          if (viewer && viewer.updateParameter) {
            const success = viewer.updateParameter('cube_width', value);
            console.log(`Updated cube_width to ${value}: ${success ? 'Success' : 'Failed'}`);
          } else {
            console.error('updateParameter function not available');
          }

          // Update the display
          heightDisplay.textContent = value.toFixed(2) + 'm';
        });

        console.log('âœ… Event listener attached successfully');
      }

      // Initialize everything in proper order
      await initViewer();
      setupControl();

      console.log('ðŸš€ Ready! Drag the slider to test updateParameter function.');
    });
  </script>
</body>

</html>
