<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Spellshape - Final UI</title>
  
  <script type="importmap">
    {
      "imports": {
        "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js",
        "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/"
      }
    }
  </script>

  <style>
    :root {
      --bg: #121214;
      --panel: #1c1c21;
      --card: #25252b;
      --border: #333;
      --accent: #646cff;
      --text: #ececec;
      --text-dim: #888;
    }

    body { margin: 0; overflow: hidden; background: var(--bg); font-family: 'Inter', system-ui, sans-serif; color: var(--text); }
    .app { display: flex; height: 100vh; width: 100vw; }
    
    /* SIDEBAR */
    .sidebar {
      flex: 0 0 400px;
      width: 400px;
      background: var(--panel);
      border-right: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      z-index: 10;
    }

    .header {
      padding: 20px;
      border-bottom: 1px solid var(--border);
      background: var(--bg);
    }
    .header h1 { margin: 0; font-size: 16px; font-weight: 700; letter-spacing: -0.5px; }

    /* TABS */
    .tabs { display: flex; padding: 0 20px; border-bottom: 1px solid var(--border); }
    .tab {
      padding: 12px 0; margin-right: 20px;
      font-size: 12px; font-weight: 600; color: var(--text-dim);
      cursor: pointer; border-bottom: 2px solid transparent;
      transition: all 0.2s;
    }
    .tab.active { color: var(--accent); border-bottom-color: var(--accent); }
    .tab:hover { color: #fff; }

    /* CONTENT AREA */
    .content { flex: 1; overflow-y: auto; padding: 20px; display: none; }
    .content.active { display: block; }

    /* SHARED SLIDER STYLES */
    .control { margin-bottom: 16px; }
    .control-header { display: flex; justify-content: space-between; font-size: 11px; margin-bottom: 6px; }
    .control-val { font-family: monospace; color: var(--accent); }
    .control-label { color: #ccc; font-weight: 500; }

    input[type=range] {
      width: 100%; -webkit-appearance: none; background: transparent; cursor: pointer;
    }
    input[type=range]::-webkit-slider-runnable-track {
      width: 100%; height: 4px; background: #333; border-radius: 2px;
    }
    input[type=range]::-webkit-slider-thumb {
      -webkit-appearance: none; height: 14px; width: 14px; border-radius: 50%;
      background: #fff; margin-top: -5px; box-shadow: 0 2px 5px rgba(0,0,0,0.3);
      transition: background 0.2s, transform 0.2s;
    }
    input[type=range]:hover::-webkit-slider-thumb { background: var(--accent); transform: scale(1.1); }

    /* TAB 1: GROUPS */
    .group-title {
      font-size: 10px; font-weight: 700; text-transform: uppercase; color: var(--text-dim);
      margin: 24px 0 12px 0; letter-spacing: 1px; border-bottom: 1px solid #333; padding-bottom: 4px;
    }
    .group-title:first-child { margin-top: 0; }

    /* TAB 2: RECIPE CARDS */
    .step-card {
      background: var(--card); border: 1px solid var(--border); border-radius: 6px;
      padding: 14px; margin-bottom: 12px; position: relative;
    }
    .step-header { display: flex; align-items: center; gap: 10px; margin-bottom: 8px; }
    .step-num { 
      width: 18px; height: 18px; background: #333; border-radius: 50%; 
      font-size: 10px; font-weight: bold; color: #888; 
      display: flex; align-items: center; justify-content: center;
    }
    .step-title { font-size: 13px; font-weight: 600; color: #fff; flex: 1; }
    
    .step-actions {
      display: flex; gap: 8px; margin-left: auto;
    }
    .step-btn {
      width: 24px; height: 24px; border: none; border-radius: 4px; cursor: pointer;
      font-size: 12px; font-weight: 600; display: flex; align-items: center; justify-content: center;
      transition: all 0.2s;
    }
    .step-btn-add {
      background: rgba(100, 108, 255, 0.2); color: var(--accent);
    }
    .step-btn-add:hover {
      background: rgba(100, 108, 255, 0.4); transform: scale(1.1);
    }
    .step-btn-remove {
      background: rgba(255, 100, 100, 0.2); color: #ff6464;
    }
    .step-btn-remove:hover {
      background: rgba(255, 100, 100, 0.4); transform: scale(1.1);
    }
    
    .step-controls { 
      margin-top: 10px; padding-top: 10px; border-top: 1px solid rgba(255,255,255,0.05); 
    }

    /* TAB 3: JSON */
    textarea {
      width: 100%; height: 100%; background: #111; border: none;
      color: #ccc; font-family: monospace; font-size: 11px; padding: 10px; resize: none;
    }

    /* VIEWPORT */
    .viewport { flex: 1; position: relative; background: radial-gradient(circle at center, #222 0%, #111 100%); }
    canvas { display: block; width: 100%; height: 100%; outline: none; }
    
    .stats {
      position: absolute; bottom: 20px; right: 20px;
      font-family: monospace; font-size: 10px; color: #666;
      background: rgba(0,0,0,0.5); padding: 8px 12px; border-radius: 4px;
      pointer-events: none;
    }
  </style>
</head>
<body>

  <div class="app">
    <div class="sidebar">
      <div class="header">
        <h1>Spellshape</h1>
      </div>
      
      <div class="tabs">
        <div class="tab active" onclick="setTab('controls')">Controls</div>
        <div class="tab" onclick="setTab('recipe')">Recipe</div>
        <div class="tab" onclick="setTab('json')">JSON</div>
      </div>

      <!-- TAB 1: CONTROLS -->
      <div id="tab-controls" class="content active">
        <!-- Generated JS -->
      </div>

      <!-- TAB 2: RECIPE -->
      <div id="tab-recipe" class="content">
        <!-- Generated JS -->
      </div>

      <!-- TAB 3: JSON -->
      <div id="tab-json" class="content" style="padding:0;">
        <textarea id="json-input" spellcheck="false"></textarea>
        <div style="padding: 10px; background: var(--panel); border-top: 1px solid var(--border);">
          <button onclick="updateFromJSON()" style="width:100%; padding:8px; background:var(--accent); border:none; border-radius:4px; color:white; cursor:pointer; font-weight:600;">Update</button>
        </div>
      </div>
    </div>

    <div class="viewport">
      <canvas id="gl"></canvas>
      <div class="stats" id="stats">Ready</div>
    </div>
  </div>

  <script type="module">
    import * as THREE from 'three';
    import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
    import { ProceduralExecutor } from './src/modules/interpreter/procedural-executor.js';

    // --- SCHEMA (v4.8 - Curated Controls) ---
    let schema = {
  "version": "4.9",
  "type": "emergent_procedure",
  "intent": "Decoupled Logic Tower",
  "materials": {
    "wall": { "color": "#1a3a5c", "roughness": 0.7, "metalness": 0.1 },
    "window": { "color": "#b3d9ff", "roughness": 0.1, "metalness": 0.8, "transparent": true, "opacity": 0.6 },
    "core": { "color": "#c1440e", "roughness": 0.6, "metalness": 0 },
    "column": { "color": "#2a2a2a", "roughness": 0.8, "metalness": 0.3 },
    "floor_slab": { "color": "#b8b8b8", "roughness": 0.7, "metalness": 0.1 }
  },
  
  "globalParameters": {
    "floors": { "value": 15, "type": "integer", "min": 3, "max": 30, "group": "Massing" },
    "floorHeight": { "value": 3.5, "type": "number", "min": 2, "max": 5, "group": "Massing" },
    "slabWidth": { "value": 12, "type": "number", "min": 6, "max": 24, "group": "Slab" },
    "slabDepth": { "value": 12, "type": "number", "min": 6, "max": 24, "group": "Slab" },
    "slabThickness": { "value": 0.3, "type": "number", "min": 0.1, "max": 1.0, "group": "Slab" },
    "coreWidth": { "value": 8, "type": "number", "min": 4, "max": 16, "group": "Core" },
    "coreDepth": { "value": 8, "type": "number", "min": 4, "max": 16, "group": "Core" },
    "colRadius": { "value": 0.4, "type": "number", "min": 0.2, "max": 0.8, "group": "Columns" },
    "colInsetX": { "value": 1.0, "type": "number", "min": 0.5, "max": 4.0, "group": "Columns" },
    "colInsetZ": { "value": 1.0, "type": "number", "min": 0.5, "max": 4.0, "group": "Columns" },
    "panelsPerSide": { "value": 6, "type": "integer", "min": 2, "max": 12, "group": "Facade" },
    "rotationPerFloor": { "value": 0.08, "type": "number", "min": 0, "max": 0.2, "group": "Animation" }
  },
  
  "context": {}, 

  "actions": [
    { 
      "thought": "1. Create Slab Base", 
      "do": "createBox", 
      "params": { 
        "width": "ctx.slabWidth", 
        "height": "ctx.slabThickness", 
        "depth": "ctx.slabDepth" 
      }, 
      "transform": { "position": [0, "-ctx.slabThickness/2", 0] }, 
      "as": "slab_mesh",
      "controls": ["slabWidth", "slabDepth", "slabThickness"] 
    },
    { 
      "thought": "2. Create Core", 
      "do": "createBox", 
      "params": { 
        "width": "ctx.coreWidth", 
        "height": "ctx.floorHeight", 
        "depth": "ctx.coreDepth" 
      }, 
      "transform": { "position": [0, "ctx.floorHeight/2", 0] }, 
      "as": "core_mesh",
      "controls": ["coreWidth", "coreDepth"]
    }
  ]
};

    // --- UI LOGIC ---
    const tabs = { controls: document.getElementById('tab-controls'), recipe: document.getElementById('tab-recipe'), json: document.getElementById('tab-json') };
    const jsonInput = document.getElementById('json-input');

    window.setTab = (name) => {
      document.querySelectorAll('.tab').forEach(el => el.classList.remove('active'));
      document.querySelectorAll('.content').forEach(el => el.classList.remove('active'));
      
      document.querySelector(`.tab[onclick="setTab('${name}')"]`).classList.add('active');
      tabs[name].classList.add('active');

      if (name === 'json') {
        jsonInput.value = JSON.stringify(schema, null, 2);
      }
    };

    // --- HELPER: Create Slider ---
    function createSlider(key, def, uniqueId) {
      const wrapper = document.createElement('div');
      wrapper.className = 'control';
      
      const header = document.createElement('div');
      header.className = 'control-header';
      header.innerHTML = `<span class="control-label">${key}</span><span class="control-val" id="val-${uniqueId}">${def.value}</span>`;
      
      const input = document.createElement('input');
      input.type = 'range';
      input.min = def.min;
      input.max = def.max;
      input.step = def.step || (def.type === 'integer' ? 0.1 : 0.01);
      input.value = def.value;
      input.setAttribute('data-key', key);

      input.oninput = (e) => {
        const val = def.type === 'integer' ? parseInt(e.target.value) : parseFloat(e.target.value);
        def.value = val;
        
        document.querySelectorAll(`input[data-key="${key}"]`).forEach(el => el.value = val);
        document.querySelectorAll(`[id^="val-"]`).forEach(el => {
          if (el.id.startsWith(`val-ctrl-${key}`) || el.id.startsWith(`val-recipe-${key}`)) {
            el.innerText = val;
          }
        });
        
        run();
      };

      wrapper.appendChild(header);
      wrapper.appendChild(input);
      return wrapper;
    }

    // --- ADD STEP ---
    window.addStepAfter = (index) => {
      const newStep = {
        "thought": "New Step",
        "do": "clone",
        "params": { "id": "base" },
        "as": `step_${Date.now()}`
      };
      schema.actions.splice(index + 1, 0, newStep);
      renderUI();
      run();
    };

    // --- REMOVE STEP ---
    window.removeStep = (index) => {
      schema.actions.splice(index, 1);
      renderUI();
      run();
    };

    // --- RENDER TABS ---
    function renderUI() {
      // 1. CONTROLS TAB
      tabs.controls.innerHTML = '';
      const groups = {};
      for (const [key, def] of Object.entries(schema.globalParameters)) {
        const g = def.group || 'General';
        if (!groups[g]) groups[g] = [];
        groups[g].push({ key, def });
      }

      for (const [gName, items] of Object.entries(groups)) {
        const title = document.createElement('div');
        title.className = 'group-title';
        title.innerText = gName;
        tabs.controls.appendChild(title);
        items.forEach(({ key, def }) => tabs.controls.appendChild(createSlider(key, def, `ctrl-${key}`)));
      }

      // 2. RECIPE TAB
      tabs.recipe.innerHTML = '';
      schema.actions.forEach((action, i) => {
        if (!action.thought) return;

        const card = document.createElement('div');
        card.className = 'step-card';
        
        const header = document.createElement('div');
        header.className = 'step-header';
        header.innerHTML = `
          <div class="step-num">${i+1}</div>
          <div class="step-title">${action.thought}</div>
          <div class="step-actions">
            <button class="step-btn step-btn-add" onclick="addStepAfter(${i})" title="Add step after">+</button>
            <button class="step-btn step-btn-remove" onclick="removeStep(${i})" title="Remove step">Ã—</button>
          </div>
        `;
        card.appendChild(header);

        if (action.controls && action.controls.length > 0) {
          const controlsArea = document.createElement('div');
          controlsArea.className = 'step-controls';
          action.controls.forEach(key => {
            if (schema.globalParameters[key]) {
              controlsArea.appendChild(createSlider(key, schema.globalParameters[key], `recipe-${key}`));
            }
          });
          card.appendChild(controlsArea);
        }
        tabs.recipe.appendChild(card);
      });
    }

    window.updateFromJSON = () => {
      try {
        schema = JSON.parse(jsonInput.value);
        renderUI();
        run();
        setTab('controls');
      } catch(e) { alert('Invalid JSON'); }
    }

    // --- 3D ENGINE ---
    const canvas = document.querySelector('#gl');
    const renderer = new THREE.WebGLRenderer({ canvas, antialias: true });
    const scene = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera(45, 1, 0.1, 1000);
    const controls = new OrbitControls(camera, canvas);
    let currentMesh = null;
    const executor = new ProceduralExecutor();

    function setupScene() {
      renderer.setSize(canvas.clientWidth, canvas.clientHeight);
      camera.aspect = canvas.clientWidth / canvas.clientHeight;
      camera.position.set(60, 50, 60);
      camera.updateProjectionMatrix();
      controls.enableDamping = true;
      controls.target.set(0, 20, 0);
      scene.background = new THREE.Color(0x111114);
      scene.add(new THREE.AmbientLight(0xffffff, 0.6));
      const dirLight = new THREE.DirectionalLight(0xffffff, 1);
      dirLight.position.set(50, 100, 50);
      scene.add(dirLight);
      scene.add(new THREE.GridHelper(100, 20, 0x333333, 0x111111));
    }
    
    function run() {
      if (currentMesh) {
        scene.remove(currentMesh);
        currentMesh.traverse(c => {
          if (c.geometry) c.geometry.dispose();
          if (c.material && !Array.isArray(c.material)) c.material.dispose();
        });
      }

      const params = {};
      for (const [k, v] of Object.entries(schema.globalParameters)) params[k] = v.value;

      try {
        currentMesh = executor.execute(schema, params);
        scene.add(currentMesh);
        let count = 0;
        currentMesh.traverse(c => { if (c.isMesh) count++; });
        document.getElementById('stats').innerText = `Meshes: ${count}`;
      } catch (e) {
        console.error(e);
      }
    }

    // INIT
    setupScene();
    renderUI();
    run();

    function animate() {
      requestAnimationFrame(animate);
      controls.update();
      renderer.render(scene, camera);
    }
    animate();

    window.onresize = () => {
      renderer.setSize(canvas.clientWidth, canvas.clientHeight);
      camera.aspect = canvas.clientWidth / canvas.clientHeight;
      camera.updateProjectionMatrix();
    }
  </script>
</body>
</html>