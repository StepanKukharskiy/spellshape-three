<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Spellshape - Procedural Timeline Editor</title>

  <script type="importmap">
    {
      "imports": {
        "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js",
        "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/"
      }
    }
  </script>

  <style>
    :root {
      --bg: #121214;
      --panel: #1c1c21;
      --card: #25252b;
      --card-hover: #2d2d33;
      --border: #333;
      --accent: #646cff;
      --text: #ececec;
      --text-dim: #888;
      --success: #4ade80;
      --error: #ff6464;
    }

    * { box-sizing: border-box; }
    body { margin: 0; overflow: hidden; background: var(--bg); font-family: 'Inter', system-ui, sans-serif; color: var(--text); }
    .app { display: flex; height: 100vh; width: 100vw; }

    /* SIDEBAR */
    .sidebar {
      flex: 0 0 500px;
      width: 500px;
      background: var(--panel);
      border-right: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      z-index: 10;
    }

    .header {
      padding: 16px 20px;
      border-bottom: 1px solid var(--border);
      background: var(--bg);
    }
    .header h1 { margin: 0; font-size: 14px; font-weight: 700; }

    /* TABS */
    .tabs { display: flex; padding: 0 20px; border-bottom: 1px solid var(--border); gap: 20px; }
    .tab {
      padding: 10px 0;
      font-size: 11px; font-weight: 600; color: var(--text-dim);
      cursor: pointer; border-bottom: 2px solid transparent;
      transition: all 0.2s;
    }
    .tab.active { color: var(--accent); border-bottom-color: var(--accent); }
    .tab:hover { color: #fff; }

    /* CONTENT AREA */
    .content { flex: 1; overflow-y: auto; padding: 16px; display: none; }
    .content.active { display: block; }

    /* TAB 1: GLOBALS */
    .globals-container { display: flex; flex-direction: column; gap: 12px; }
    .global-group { background: var(--card); border: 1px solid var(--border); border-radius: 6px; padding: 12px; }
    .global-header {
      display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;
      font-size: 11px; font-weight: 700; text-transform: uppercase; color: var(--text-dim);
    }
    .btn-add-global { width: 20px; height: 20px; background: rgba(100, 108, 255, 0.2); border: none; border-radius: 3px; color: var(--accent); cursor: pointer; font-weight: bold; }
    .btn-add-global:hover { background: rgba(100, 108, 255, 0.4); }

    .global-item {
      display: flex; gap: 8px; margin-bottom: 8px; align-items: center;
    }
    .global-item:last-child { margin-bottom: 0; }

    .global-slider-group {
      display: flex; flex-direction: column; gap: 4px; margin-top: 8px;
    }
    .slider-header { display: flex; justify-content: space-between; font-size: 10px; color: var(--text-dim); }
    .slider-value { color: var(--accent); font-family: monospace; font-weight: bold; }

    input[type="text"], input[type="number"], input[type="range"] {
      background: rgba(255,255,255,0.05); border: 1px solid var(--border); border-radius: 4px;
      padding: 6px 10px; color: var(--text); font-size: 11px;
    }
    input[type="text"]:focus, input[type="number"]:focus {
      outline: none; border-color: var(--accent);
    }

    input[type="range"] {
      padding: 0; height: 4px; cursor: pointer;
    }
    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none; appearance: none; width: 14px; height: 14px;
      border-radius: 50%; background: var(--accent); cursor: pointer;
    }
    input[type="range"]::-moz-range-thumb {
      width: 14px; height: 14px; border-radius: 50%; background: var(--accent); cursor: pointer;
    }

    .btn-icon { width: 20px; height: 20px; background: rgba(255, 100, 100, 0.2); border: none; border-radius: 3px; color: var(--error); cursor: pointer; font-size: 12px; }
    .btn-icon:hover { background: rgba(255, 100, 100, 0.4); }

    /* TAB 2: TIMELINE */
    .timeline { display: flex; flex-direction: column; gap: 12px; }

    .step-card {
      background: var(--card); border: 1px solid var(--border); border-radius: 6px;
      padding: 12px; position: relative; transition: all 0.2s;
    }
    .step-card:hover { background: var(--card-hover); border-color: var(--accent); }

    .step-header {
      display: flex; align-items: center; gap: 10px; margin-bottom: 10px; justify-content: space-between;
    }
    .step-num { width: 16px; height: 16px; background: #333; border-radius: 50%; font-size: 9px; font-weight: bold; color: #888; display: flex; align-items: center; justify-content: center; }
    .step-title-input {
      flex: 1; background: transparent; border: 1px solid transparent; padding: 4px 8px;
      color: var(--text); font-size: 12px; font-weight: 600; border-radius: 3px;
    }
    .step-title-input:hover { border-color: var(--border); }
    .step-title-input:focus { outline: none; border-color: var(--accent); background: rgba(100, 108, 255, 0.1); }

    .step-actions { display: flex; gap: 6px; }
    .step-btn { width: 22px; height: 22px; border: none; border-radius: 3px; cursor: pointer; font-size: 11px; font-weight: 600; display: flex; align-items: center; justify-content: center; transition: all 0.2s; }
    .step-btn-add { background: rgba(100, 108, 255, 0.2); color: var(--accent); }
    .step-btn-add:hover { background: rgba(100, 108, 255, 0.4); }
    .step-btn-remove { background: rgba(255, 100, 100, 0.2); color: var(--error); }
    .step-btn-remove:hover { background: rgba(255, 100, 100, 0.4); }

    .step-body { display: flex; flex-direction: column; gap: 8px; }

    .field-group { display: flex; flex-direction: column; gap: 4px; }
    .field-label { font-size: 10px; font-weight: 600; text-transform: uppercase; color: var(--text-dim); }

    .helper-select {
      background: rgba(255,255,255,0.05); border: 1px solid var(--border); border-radius: 4px;
      padding: 6px 10px; color: var(--text); font-size: 11px; cursor: pointer;
    }
    .helper-select:hover { border-color: var(--accent); }
    .helper-select:focus { outline: none; border-color: var(--accent); }

    textarea.expr-input {
      background: rgba(255,255,255,0.03); border: 1px solid var(--border); border-radius: 4px;
      padding: 6px 10px; color: var(--text); font-size: 10px; font-family: 'Courier New', monospace;
      resize: vertical; min-height: 40px; max-height: 80px;
    }
    textarea.expr-input:focus { outline: none; border-color: var(--accent); }

    /* ADD STEP MENU */
    .menu-overlay {
      position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: none; z-index: 1000;
    }
    .menu-overlay.active { display: block; }

    .menu-popup {
      position: fixed; background: var(--panel); border: 1px solid var(--border); border-radius: 8px;
      min-width: 200px; max-height: 400px; overflow-y: auto; z-index: 1001;
      box-shadow: 0 10px 40px rgba(0,0,0,0.5);
    }

    .menu-item {
      padding: 10px 16px; cursor: pointer; font-size: 11px; border-bottom: 1px solid rgba(255,255,255,0.05);
      transition: all 0.2s;
    }
    .menu-item:hover { background: rgba(100, 108, 255, 0.2); color: var(--accent); }
    .menu-item:last-child { border-bottom: none; }

    /* TAB 3: JSON */
    .json-container { display: flex; flex-direction: column; height: 100%; gap: 10px; }
    textarea.json-input {
      flex: 1; background: #111; border: 1px solid var(--border); border-radius: 4px;
      padding: 10px; color: #0f0; font-family: monospace; font-size: 10px; resize: none;
    }
    textarea.json-input:focus { outline: none; border-color: var(--accent); }
    .json-buttons { display: flex; gap: 8px; }
    .json-btn { flex: 1; padding: 8px; background: rgba(100, 108, 255, 0.2); border: 1px solid var(--accent); border-radius: 4px; color: var(--accent); cursor: pointer; font-weight: 600; }
    .json-btn:hover { background: rgba(100, 108, 255, 0.4); }

    /* VIEWPORT */
    .viewport { flex: 1; position: relative; background: radial-gradient(circle at center, #222 0%, #111 100%); }
    canvas { display: block; width: 100%; height: 100%; outline: none; }

    .stats {
      position: absolute; bottom: 20px; right: 20px;
      font-family: monospace; font-size: 10px; color: #666;
      background: rgba(0,0,0,0.5); padding: 8px 12px; border-radius: 4px;
      pointer-events: none;
    }
  </style>
</head>
<body>

  <div class="app">
    <div class="sidebar">
      <div class="header">
        <h1>Spellshape - Procedural Editor</h1>
      </div>

      <div class="tabs">
        <div class="tab active" onclick="setTab('globals')">Globals</div>
        <div class="tab" onclick="setTab('timeline')">Timeline</div>
        <div class="tab" onclick="setTab('json')">JSON</div>
      </div>

      <!-- TAB 1: GLOBALS -->
      <div id="tab-globals" class="content active">
        <div class="globals-container" id="globals-container"></div>
        <button onclick="addGlobalParam()" style="width: 100%; padding: 10px; background: rgba(100, 108, 255, 0.2); border: 1px solid var(--accent); border-radius: 4px; color: var(--accent); cursor: pointer; font-weight: 600; margin-top: 12px;">+ Add Global Parameter</button>
      </div>

      <!-- TAB 2: TIMELINE -->
      <div id="tab-timeline" class="content">
        <div class="timeline" id="timeline-container"></div>
        <button onclick="addStep()" style="width: 100%; padding: 10px; background: rgba(100, 108, 255, 0.2); border: 1px solid var(--accent); border-radius: 4px; color: var(--accent); cursor: pointer; font-weight: 600; margin-top: 12px;">+ Add Step</button>
      </div>

      <!-- TAB 3: JSON -->
      <div id="tab-json" class="content">
        <div class="json-container">
          <textarea class="json-input" id="json-input" spellcheck="false"></textarea>
          <div class="json-buttons">
            <button class="json-btn" onclick="importJSON()">Import</button>
            <button class="json-btn" onclick="exportJSON()">Export</button>
          </div>
        </div>
      </div>
    </div>

    <div class="viewport">
      <canvas id="gl"></canvas>
      <div class="stats" id="stats">Ready</div>
    </div>
  </div>

  <!-- Add Step Menu -->
  <div class="menu-overlay" id="menu-overlay" onclick="closeAddMenu()"></div>
  <div class="menu-popup" id="menu-popup"></div>

  <script type="module">
    import * as THREE from 'three';
    import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
    import { ProceduralExecutor } from './src/modules/interpreter/procedural-executor.js';

    // ============================================================================
    // HELPER REGISTRY - Maps helpers to their ACTUAL parameters with defaults
    // ============================================================================
    const HELPER_REGISTRY = {
      'createBox': {
        category: 'Basic Geometry',
        params: {
          'width': { type: 'number', default: 1, min: 0.1, max: 50 },
          'height': { type: 'number', default: 1, min: 0.1, max: 50 },
          'depth': { type: 'number', default: 1, min: 0.1, max: 50 },
          'widthSegments': { type: 'integer', default: 1, min: 1, max: 32 },
          'heightSegments': { type: 'integer', default: 1, min: 1, max: 32 },
          'depthSegments': { type: 'integer', default: 1, min: 1, max: 32 }
        }
      },

      'createSphere': {
        category: 'Basic Geometry',
        params: {
          'radius': { type: 'number', default: 1, min: 0.1, max: 50 },
          'widthSegments': { type: 'integer', default: 32, min: 3, max: 128 },
          'heightSegments': { type: 'integer', default: 16, min: 2, max: 64 },
          'phiStart': { type: 'number', default: 0, min: 0, max: 6.28 },
          'phiLength': { type: 'number', default: 6.28, min: 0.1, max: 6.28 },
          'thetaStart': { type: 'number', default: 0, min: 0, max: 3.14 },
          'thetaLength': { type: 'number', default: 3.14, min: 0.1, max: 3.14 }
        }
      },

      'createCylinder': {
        category: 'Basic Geometry',
        params: {
          'radiusTop': { type: 'number', default: 1, min: 0.1, max: 50 },
          'radiusBottom': { type: 'number', default: 1, min: 0.1, max: 50 },
          'height': { type: 'number', default: 1, min: 0.1, max: 50 },
          'radialSegments': { type: 'integer', default: 32, min: 3, max: 128 },
          'heightSegments': { type: 'integer', default: 1, min: 1, max: 32 },
          'openEnded': { type: 'boolean', default: false },
          'thetaStart': { type: 'number', default: 0, min: 0, max: 6.28 },
          'thetaLength': { type: 'number', default: 6.28, min: 0.1, max: 6.28 }
        }
      },

      'createCone': {
        category: 'Basic Geometry',
        params: {
          'radius': { type: 'number', default: 1, min: 0.1, max: 50 },
          'height': { type: 'number', default: 1, min: 0.1, max: 50 },
          'radialSegments': { type: 'integer', default: 32, min: 3, max: 128 },
          'heightSegments': { type: 'integer', default: 1, min: 1, max: 32 },
          'openEnded': { type: 'boolean', default: false }
        }
      },

      'createTorus': {
        category: 'Basic Geometry',
        params: {
          'radius': { type: 'number', default: 1, min: 0.1, max: 50 },
          'tube': { type: 'number', default: 0.4, min: 0.1, max: 10 },
          'radialSegments': { type: 'integer', default: 16, min: 3, max: 64 },
          'tubularSegments': { type: 'integer', default: 100, min: 8, max: 256 },
          'arc': { type: 'number', default: 6.28, min: 0.1, max: 6.28 }
        }
      },

      'createPlane': {
        category: 'Basic Geometry',
        params: {
          'width': { type: 'number', default: 1, min: 0.1, max: 50 },
          'height': { type: 'number', default: 1, min: 0.1, max: 50 },
          'widthSegments': { type: 'integer', default: 1, min: 1, max: 32 },
          'heightSegments': { type: 'integer', default: 1, min: 1, max: 32 }
        }
      },

      'repeatLinear3d': {
        category: 'Distribution',
        params: {
          'geometry': { type: 'reference', default: null },
          'count': { type: 'integer', default: 3, min: 1, max: 50 },
          'spacing': { type: 'number', default: 1, min: 0.1, max: 50 },
          'axis': { type: 'string', default: 'x' },
          'centered': { type: 'boolean', default: false },
          'autoMerge': { type: 'boolean', default: true }
        }
      },

      'repeatRadial3d': {
        category: 'Distribution',
        params: {
          'geometry': { type: 'reference', default: null },
          'count': { type: 'integer', default: 8, min: 1, max: 50 },
          'radius': { type: 'number', default: 5, min: 0.1, max: 100 },
          'startAngle': { type: 'number', default: 0, min: 0, max: 6.28 },
          'endAngle': { type: 'number', default: 6.28, min: 0.1, max: 6.28 },
          'axis': { type: 'string', default: 'y' },
          'faceCenter': { type: 'boolean', default: true },
          'autoMerge': { type: 'boolean', default: true }
        }
      },

      'distributeOnGrid3d': {
        category: 'Distribution',
        params: {
          'geometry': { type: 'reference', default: null },
          'rows': { type: 'integer', default: 3, min: 1, max: 50 },
          'cols': { type: 'integer', default: 3, min: 1, max: 50 },
          'spacing': { type: 'array', default: [2, 0, 2] },
          'centered': { type: 'boolean', default: true },
          'autoMerge': { type: 'boolean', default: true }
        }
      },

      'twistGeometry': {
        category: 'Deformation',
        params: {
          'geometry': { type: 'reference', default: null },
          'angle': { type: 'number', default: 0.785, min: -6.28, max: 6.28 },
          'axis': { type: 'array', default: [0, 1, 0] }
        }
      },

      'taperGeometry': {
        category: 'Deformation',
        params: {
          'geometry': { type: 'reference', default: null },
          'topScale': { type: 'array', default: [0.5, 0.5] },
          'axis': { type: 'array', default: [0, 1, 0] }
        }
      },

      'bendGeometry': {
        category: 'Deformation',
        params: {
          'geometry': { type: 'reference', default: null },
          'angle': { type: 'number', default: 0.785, min: -6.28, max: 6.28 },
          'direction': { type: 'array', default: [1, 0, 0] }
        }
      },

      'deformByNoise': {
        category: 'Deformation',
        params: {
          'geometry': { type: 'reference', default: null },
          'amount': { type: 'number', default: 0.2, min: 0, max: 10 },
          'frequency': { type: 'number', default: 1.0, min: 0.1, max: 10 },
          'axis': { type: 'array', default: [0, 1, 0] }
        }
      },

      'mergeGeometries': {
        category: 'Utilities',
        params: {
          'geometries': { type: 'array', default: [] }
        }
      },

      'modifyGeometry': {
        category: 'Emergent',
        params: {
          'geometry': { type: 'reference', default: null },
          'operations': { type: 'array', default: [] },
          'context': { type: 'object', default: {} }
        }
      },

      'clone': {
        category: 'Utilities',
        params: {
          'geometry': { type: 'reference', default: null }
        }
      },

      'transformMesh': {
        category: 'Utilities',
        params: {
          'geometry': { type: 'reference', default: null },
          'scale': { type: 'array', default: [1, 1, 1] },
          'rotation': { type: 'array', default: [0, 0, 0] },
          'position': { type: 'array', default: [0, 0, 0] }
        }
      },

      'loop': {
        category: 'Logic',
        params: {
          'var': { type: 'string', default: 'i' },
          'from': { type: 'number', default: 0 },
          'to': { type: 'number', default: 10 },
          'body': { type: 'array', default: [] }
        }
      }
    };

    // Generate params for a helper
    function getHelperParams(helperName) {
      const helperDef = HELPER_REGISTRY[helperName];
      if (!helperDef) {
        console.warn('Unknown helper:', helperName);
        return {};
      }

      const params = {};
      for (const [key, def] of Object.entries(helperDef.params)) {
        if (def.default !== null && def.default !== undefined) {
          params[key] = def.default;
        }
      }
      return params;
    }

    // --- SCHEMA STATE ---
    let schema = {
      "version": "5.0",
      "type": "emergent_procedure",
      "intent": "Custom Procedure",
      "materials": {
        "default": { "color": "#888888", "roughness": 0.7, "metalness": 0.1 }
      },
      "globalParameters": {
        "width": { "value": 10, "type": "number", "min": 1, "max": 50, "group": "Dimensions" },
        "height": { "value": 10, "type": "number", "min": 1, "max": 50, "group": "Dimensions" }
      },
      "context": {},
      "actions": []
    };

    const HELPERS = Object.keys(HELPER_REGISTRY);

    // --- UI LOGIC ---
    window.setTab = (name) => {
      document.querySelectorAll('.tab').forEach(el => el.classList.remove('active'));
      document.querySelectorAll('.content').forEach(el => el.classList.remove('active'));

      document.querySelector(`.tab[onclick="setTab('${name}')"]`).classList.add('active');
      document.getElementById(`tab-${name}`).classList.add('active');

      if (name === 'json') {
        document.getElementById('json-input').value = JSON.stringify(schema, null, 2);
      }
    };

    // --- GLOBAL PARAMETERS UI ---
    window.addGlobalParam = () => {
      const key = `param_${Date.now()}`;
      schema.globalParameters[key] = { value: 5, type: "number", min: 0, max: 100, group: "Custom" };
      renderGlobals();
      run();
    };

    window.removeGlobalParam = (key) => {
      delete schema.globalParameters[key];
      renderGlobals();
      run();
    };

    window.updateGlobalParam = (key, field, value) => {
      if (field === 'value') {
        schema.globalParameters[key].value = parseFloat(value) || 0;
        run();
      } else if (field === 'min') schema.globalParameters[key].min = parseFloat(value) || 0;
      else if (field === 'max') schema.globalParameters[key].max = parseFloat(value) || 100;
      else if (field === 'key') {
        schema.globalParameters[value] = schema.globalParameters[key];
        delete schema.globalParameters[key];
        renderGlobals();
      }
    };

    function renderGlobals() {
      const container = document.getElementById('globals-container');
      container.innerHTML = '';

      for (const [key, param] of Object.entries(schema.globalParameters)) {
        const group = document.createElement('div');
        group.className = 'global-group';

        const headerHtml = `
          <div class="global-header">
            <span>Parameter</span>
            <button class="btn-add-global" onclick="removeGlobalParam('${key}')">×</button>
          </div>
          <div class="global-item">
            <label style="font-size: 10px; min-width: 40px;">Name:</label>
            <input type="text" value="${key}" onchange="updateGlobalParam('${key}', 'key', this.value)" placeholder="param name" />
          </div>
          <div class="global-slider-group">
            <div class="slider-header">
              <span>Value</span>
              <span class="slider-value">${param.value}</span>
            </div>
            <input type="range" min="${param.min}" max="${param.max}" step="0.1" value="${param.value}" 
              oninput="updateGlobalParam('${key}', 'value', this.value); document.querySelector('[id^=val-${key}]').innerText = this.value;" />
          </div>
          <div class="global-item">
            <label style="font-size: 10px; min-width: 40px;">Min:</label>
            <input type="number" value="${param.min}" onchange="updateGlobalParam('${key}', 'min', this.value)" />
          </div>
          <div class="global-item">
            <label style="font-size: 10px; min-width: 40px;">Max:</label>
            <input type="number" value="${param.max}" onchange="updateGlobalParam('${key}', 'max', this.value)" />
          </div>
        `;
        group.innerHTML = headerHtml;
        container.appendChild(group);
      }
    }

    // --- TIMELINE ACTIONS UI ---
    window.addStep = (afterIndex = -1) => {
      const newStep = {
        "thought": "New Step",
        "do": "createBox",
        "params": getHelperParams('createBox'),
        "transform": { "position": [0, 0, 0] },
        "as": `step_${Date.now()}`,
        "material": "default"
      };

      if (afterIndex >= 0) schema.actions.splice(afterIndex + 1, 0, newStep);
      else schema.actions.push(newStep);

      renderTimeline();
      run();
    };

    window.removeStep = (index) => {
      schema.actions.splice(index, 1);
      renderTimeline();
      run();
    };

    window.openAddMenu = (index) => {
      const overlay = document.getElementById('menu-overlay');
      const popup = document.getElementById('menu-popup');
      overlay.classList.add('active');

      popup.innerHTML = HELPERS.map(h => `<div class="menu-item" onclick="addStepWithHelper('${h}', ${index})">${h}</div>`).join('');

      const btn = event.target;
      const rect = btn.getBoundingClientRect();
      popup.style.top = rect.bottom + 'px';
      popup.style.left = rect.left + 'px';
    };

    window.addStepWithHelper = (helper, index) => {
      const newStep = {
        "thought": `Use ${helper}`,
        "do": helper,
        "params": getHelperParams(helper),  // ← FIX: Use actual helper params!
        "as": `${helper}_${Date.now()}`,
        "material": "default"
      };

      schema.actions.splice(index + 1, 0, newStep);
      closeAddMenu();
      renderTimeline();
      run();
    };

    window.closeAddMenu = () => {
      document.getElementById('menu-overlay').classList.remove('active');
    };

    window.updateStepField = (index, field, value) => {
      if (field === 'thought') schema.actions[index].thought = value;
      else if (field === 'do') schema.actions[index].do = value;
      else if (field === 'as') schema.actions[index].as = value;
      else if (field === 'material') schema.actions[index].material = value;
      else if (field === 'params') {
        try {
          schema.actions[index].params = JSON.parse(value);
        } catch (e) {
          console.error('Invalid JSON params:', e);
          return;
        }
      }
      run();
    };

    function renderTimeline() {
      const container = document.getElementById('timeline-container');
      container.innerHTML = '';

      schema.actions.forEach((action, i) => {
        const card = document.createElement('div');
        card.className = 'step-card';

        const header = `
          <div class="step-header">
            <div class="step-num">${i+1}</div>
            <input class="step-title-input" value="${action.thought || ''}" onchange="updateStepField(${i}, 'thought', this.value)" placeholder="Step description" />
            <div class="step-actions">
              <button class="step-btn step-btn-add" onclick="openAddMenu(${i})" title="Add step after">+</button>
              <button class="step-btn step-btn-remove" onclick="removeStep(${i})" title="Remove step">×</button>
            </div>
          </div>
        `;

        const bodyHtml = `
          <div class="step-body">
            <div class="field-group">
              <label class="field-label">Helper (do)</label>
              <select class="helper-select" value="${action.do}" onchange="updateStepField(${i}, 'do', this.value)">
                <option value="">-- Select --</option>
                ${HELPERS.map(h => `<option value="${h}" ${action.do === h ? 'selected' : ''}>${h}</option>`).join('')}
              </select>
            </div>

            <div class="field-group">
              <label class="field-label">Output Name (as)</label>
              <input type="text" value="${action.as || ''}" onchange="updateStepField(${i}, 'as', this.value)" placeholder="e.g., box_mesh" style="background: rgba(255,255,255,0.05); border: 1px solid var(--border); border-radius: 4px; padding: 6px 10px; color: var(--text); font-size: 11px;" />
            </div>

            <div class="field-group">
              <label class="field-label">Parameters (JSON)</label>
              <textarea class="expr-input" onchange="updateStepField(${i}, 'params', this.value)" placeholder='{"width": "ctx.width"}'>${JSON.stringify(action.params || {})}</textarea>
            </div>

            <div class="field-group">
              <label class="field-label">Material</label>
              <input type="text" value="${action.material || 'default'}" onchange="updateStepField(${i}, 'material', this.value)" placeholder="material name" style="background: rgba(255,255,255,0.05); border: 1px solid var(--border); border-radius: 4px; padding: 6px 10px; color: var(--text); font-size: 11px;" />
            </div>
          </div>
        `;

        card.innerHTML = header + bodyHtml;
        container.appendChild(card);
      });
    }

    // --- JSON IMPORT/EXPORT ---
    window.exportJSON = () => {
      const jsonInput = document.getElementById('json-input');
      jsonInput.value = JSON.stringify(schema, null, 2);
    };

    window.importJSON = () => {
      const jsonInput = document.getElementById('json-input');
      try {
        schema = JSON.parse(jsonInput.value);
        setTab('globals');
        renderGlobals();
        renderTimeline();
        run();
        alert('Schema imported successfully!');
      } catch (e) {
        alert('Invalid JSON: ' + e.message);
      }
    };

    // --- 3D ENGINE ---
    const canvas = document.querySelector('#gl');
    const renderer = new THREE.WebGLRenderer({ canvas, antialias: true });
    const scene = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera(45, 1, 0.1, 1000);
    const controls = new OrbitControls(camera, canvas);
    let currentMesh = null;
    const executor = new ProceduralExecutor();

    function setupScene() {
      renderer.setSize(canvas.clientWidth, canvas.clientHeight);
      camera.aspect = canvas.clientWidth / canvas.clientHeight;
      camera.position.set(40, 40, 40);
      camera.updateProjectionMatrix();
      controls.enableDamping = true;
      controls.target.set(0, 0, 0);
      scene.background = new THREE.Color(0x111114);
      scene.add(new THREE.AmbientLight(0xffffff, 0.6));
      const dirLight = new THREE.DirectionalLight(0xffffff, 1);
      dirLight.position.set(50, 100, 50);
      scene.add(dirLight);
      scene.add(new THREE.GridHelper(100, 20, 0x333333, 0x111111));
    }

    function run() {
      if (currentMesh) {
        scene.remove(currentMesh);
        currentMesh.traverse(c => {
          if (c.geometry) c.geometry.dispose();
          if (c.material && !Array.isArray(c.material)) c.material.dispose();
        });
      }

      const params = {};
      for (const [k, v] of Object.entries(schema.globalParameters)) params[k] = v.value;

      try {
        currentMesh = executor.execute(schema, params);
        scene.add(currentMesh);
        let count = 0;
        currentMesh.traverse(c => { if (c.isMesh) count++; });
        document.getElementById('stats').innerText = `Meshes: ${count}`;
      } catch (e) {
        document.getElementById('stats').innerText = `Error: ${e.message.substring(0, 30)}`;
        console.error(e);
      }
    }

    // INIT
    setupScene();
    renderGlobals();
    renderTimeline();
    run();

    function animate() {
      requestAnimationFrame(animate);
      controls.update();
      renderer.render(scene, camera);
    }
    animate();

    window.onresize = () => {
      renderer.setSize(canvas.clientWidth, canvas.clientHeight);
      camera.aspect = canvas.clientWidth / canvas.clientHeight;
      camera.updateProjectionMatrix();
    }
  </script>
</body>
</html>