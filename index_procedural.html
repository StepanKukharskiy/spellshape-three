<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Spellshape - Emergent Architecture</title>
  
  <!-- Import Map -->
  <script type="importmap">
    {
      "imports": {
        "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js",
        "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/"
      }
    }
  </script>

  <style>
    :root {
      --bg: #1a1a1f;
      --panel-bg: rgba(30, 30, 35, 0.95);
      --border: rgba(255, 255, 255, 0.1);
      --accent: #6699ff;
      --text: #e0e0e0;
      --text-dim: #808080;
    }

    body { margin: 0; overflow: hidden; background: var(--bg); font-family: 'Inter', sans-serif; color: var(--text); }
    
    .container { display: flex; height: 100vh; }
    canvas { flex: 1; outline: none; }

    /* Panel */
    .panel {
      width: 400px;
      background: var(--panel-bg);
      border-right: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      z-index: 10;
      transition: transform 0.3s ease;
    }
    
    .panel.collapsed { transform: translateX(-400px); }

    .header {
      padding: 15px;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .tabs { display: flex; border-bottom: 1px solid var(--border); }
    .tab {
      flex: 1; padding: 10px; background: none; border: none;
      color: var(--text-dim); cursor: pointer; font-weight: 600;
      border-bottom: 2px solid transparent;
    }
    .tab.active { color: var(--accent); border-bottom-color: var(--accent); }

    .content { flex: 1; overflow-y: auto; padding: 15px; position: relative; }
    
    textarea {
      width: 100%; height: 300px; background: #111; border: 1px solid var(--border);
      color: #ccc; font-family: monospace; padding: 10px; resize: vertical;
    }

    /* Parameters */
    .param-row { margin-bottom: 15px; }
    .param-header { display: flex; justify-content: space-between; font-size: 12px; margin-bottom: 5px; color: var(--text-dim); }
    input[type=range] { width: 100%; accent-color: var(--accent); }

    /* Logs */
    .log-entry {
      font-family: monospace; font-size: 11px; padding: 6px;
      border-bottom: 1px solid var(--border); display: flex; gap: 8px;
    }
    .log-icon { color: var(--accent); }
    .log-text { color: #ccc; }

    /* Footer Buttons */
    .footer { padding: 15px; border-top: 1px solid var(--border); display: flex; gap: 10px; }
    button {
      flex: 1; padding: 10px; border-radius: 4px; border: none; cursor: pointer;
      font-weight: 600; background: #333; color: white;
    }
    button.primary { background: var(--accent); }
    
    .toggle {
      position: absolute; left: 400px; top: 50%; width: 24px; height: 60px;
      background: var(--panel-bg); border: 1px solid var(--border); border-left: none;
      display: flex; align-items: center; justify-content: center; cursor: pointer;
      border-radius: 0 8px 8px 0; z-index: 100; color: var(--text-dim);
    }
    .panel.collapsed + .toggle { left: 0; }

  </style>
</head>
<body>

  <div class="container">
    <div class="panel" id="sidebar">
      <div class="header">
        <h3>Spellshape Emergent</h3>
        <small style="color: var(--text-dim)">v4.5</small>
      </div>

      <div class="tabs">
        <button class="tab active" onclick="switchTab('params')">Controls</button>
        <button class="tab" onclick="switchTab('schema')">Schema</button>
        <button class="tab" onclick="switchTab('logs')">Thought Process</button>
      </div>

      <div class="content" id="tab-params">
        <!-- Sliders generated here -->
        <div id="controls-container"></div>
      </div>

      <div class="content" id="tab-schema" style="display:none">
        <textarea id="schema-input" spellcheck="false"></textarea>
        <button onclick="applySchemaFromText()" style="margin-top:10px; width:100%">Update Schema</button>
      </div>

      <div class="content" id="tab-logs" style="display:none">
        <div id="log-container"></div>
      </div>

      <div class="footer">
        <button class="primary" onclick="runSchema()">Regenerate</button>
        <button onclick="resetCamera()">Reset View</button>
      </div>
    </div>
    
    <div class="toggle" onclick="document.getElementById('sidebar').classList.toggle('collapsed')">â—€</div>
    
    <canvas id="gl"></canvas>
  </div>

  <script type="module">
    import * as THREE from 'three';
    import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
    import { ProceduralExecutor } from './procedural-executor_FINAL_v2.js';
    
    // --- DEFAULT SCHEMA (Twisted Tower v4.5) ---
    const defaultSchema = {
      "version": "4.5",
      "type": "emergent_procedure",
      "intent": "Complete Checkerboard Tower",
      "materials": {
        "wall": { "color": "#1a3a5c", "roughness": 0.7, "metalness": 0.1 },
        "window": { "color": "#b3d9ff", "roughness": 0.1, "metalness": 0.8, "transparent": true, "opacity": 0.6 },
        "core": { "color": "#c1440e", "roughness": 0.6, "metalness": 0 },
        "column": { "color": "#2a2a2a", "roughness": 0.8, "metalness": 0.3 },
        "floor_slab": { "color": "#b8b8b8", "roughness": 0.7, "metalness": 0.1 }
      },
      "globalParameters": {
        "floors": { "value": 15, "type": "integer", "min": 3, "max": 30 },
        "floorHeight": { "value": 3.5, "type": "number", "min": 2, "max": 5 },
        "coreWidth": { "value": 8, "type": "number", "min": 4, "max": 16 },
        "coreDepth": { "value": 8, "type": "number", "min": 4, "max": 12 },
        "slabExpansion": { "value": 2, "type": "number", "min": 0, "max": 4 },
        "rotationPerFloor": { "value": 0.08, "type": "number", "min": 0, "max": 0.2 },
        "panelsPerSide": { "value": 6, "type": "integer", "min": 2, "max": 12 }
      },
      "context": {},
      "actions": [
        { "do": "createBox", "params": { "width": "ctx.coreWidth + ctx.slabExpansion", "height": 0.3, "depth": "ctx.coreDepth + ctx.slabExpansion" }, "transform": { "position": [0, -0.15, 0] }, "as": "slab_mesh" },
        { "do": "createBox", "params": { "width": "ctx.coreWidth", "height": "ctx.floorHeight", "depth": "ctx.coreDepth" }, "transform": { "position": [0, "ctx.floorHeight/2", 0] }, "as": "core_mesh" },
        { "do": "createCylinder", "params": { "radiusTop": 0.4, "radiusBottom": 0.4, "height": "ctx.floorHeight" }, "transform": { "position": [0, "ctx.floorHeight/2", 0] }, "as": "col_base" },
        { "do": "distributeOnGrid3d", "params": { "geometry": "col_base", "rows": 2, "cols": 2, "spacing": ["ctx.coreWidth + 1", 0, "ctx.coreDepth + 1"], "centered": true, "autoMerge": true }, "as": "cols_mesh" },
        { "do": "createBox", "params": { "width": "(ctx.coreWidth + ctx.slabExpansion) / ctx.panelsPerSide - 0.1", "height": "ctx.floorHeight", "depth": 0.2 }, "transform": { "position": [0, "ctx.floorHeight/2", 0] }, "as": "panel_horz" },
        { "do": "createBox", "params": { "width": 0.2, "height": "ctx.floorHeight", "depth": "(ctx.coreDepth + ctx.slabExpansion) / ctx.panelsPerSide - 0.1" }, "transform": { "position": [0, "ctx.floorHeight/2", 0] }, "as": "panel_vert" },
        { "do": "repeatLinear3d", "params": { "geometry": "panel_horz", "count": "ctx.panelsPerSide / 2", "spacing": "((ctx.coreWidth + ctx.slabExpansion) / ctx.panelsPerSide) * 2", "axis": "x", "centered": true }, "transform": { "position": ["-((ctx.coreWidth + ctx.slabExpansion)/ctx.panelsPerSide)/2", 0, "(ctx.coreDepth + ctx.slabExpansion)/2 - 0.1"] }, "as": "front_even" },
        { "do": "repeatLinear3d", "params": { "geometry": "panel_horz", "count": "ctx.panelsPerSide / 2", "spacing": "((ctx.coreWidth + ctx.slabExpansion) / ctx.panelsPerSide) * 2", "axis": "x", "centered": true }, "transform": { "position": ["((ctx.coreWidth + ctx.slabExpansion)/ctx.panelsPerSide)/2", 0, "(ctx.coreDepth + ctx.slabExpansion)/2 - 0.1"] }, "as": "front_odd" },
        { "do": "repeatLinear3d", "params": { "geometry": "panel_horz", "count": "ctx.panelsPerSide / 2", "spacing": "((ctx.coreWidth + ctx.slabExpansion) / ctx.panelsPerSide) * 2", "axis": "x", "centered": true }, "transform": { "position": ["-((ctx.coreWidth + ctx.slabExpansion)/ctx.panelsPerSide)/2", 0, "-(ctx.coreDepth + ctx.slabExpansion)/2 + 0.1"] }, "as": "back_even" },
        { "do": "repeatLinear3d", "params": { "geometry": "panel_horz", "count": "ctx.panelsPerSide / 2", "spacing": "((ctx.coreWidth + ctx.slabExpansion) / ctx.panelsPerSide) * 2", "axis": "x", "centered": true }, "transform": { "position": ["((ctx.coreWidth + ctx.slabExpansion)/ctx.panelsPerSide)/2", 0, "-(ctx.coreDepth + ctx.slabExpansion)/2 + 0.1"] }, "as": "back_odd" },
        { "do": "repeatLinear3d", "params": { "geometry": "panel_vert", "count": "ctx.panelsPerSide / 2", "spacing": "((ctx.coreDepth + ctx.slabExpansion) / ctx.panelsPerSide) * 2", "axis": "z", "centered": true }, "transform": { "position": ["-(ctx.coreWidth + ctx.slabExpansion)/2 + 0.1", 0, "-((ctx.coreDepth + ctx.slabExpansion)/ctx.panelsPerSide)/2"] }, "as": "left_even" },
        { "do": "repeatLinear3d", "params": { "geometry": "panel_vert", "count": "ctx.panelsPerSide / 2", "spacing": "((ctx.coreDepth + ctx.slabExpansion) / ctx.panelsPerSide) * 2", "axis": "z", "centered": true }, "transform": { "position": ["-(ctx.coreWidth + ctx.slabExpansion)/2 + 0.1", 0, "((ctx.coreDepth + ctx.slabExpansion)/ctx.panelsPerSide)/2"] }, "as": "left_odd" },
        { "do": "repeatLinear3d", "params": { "geometry": "panel_vert", "count": "ctx.panelsPerSide / 2", "spacing": "((ctx.coreDepth + ctx.slabExpansion) / ctx.panelsPerSide) * 2", "axis": "z", "centered": true }, "transform": { "position": ["(ctx.coreWidth + ctx.slabExpansion)/2 - 0.1", 0, "-((ctx.coreDepth + ctx.slabExpansion)/ctx.panelsPerSide)/2"] }, "as": "right_even" },
        { "do": "repeatLinear3d", "params": { "geometry": "panel_vert", "count": "ctx.panelsPerSide / 2", "spacing": "((ctx.coreDepth + ctx.slabExpansion) / ctx.panelsPerSide) * 2", "axis": "z", "centered": true }, "transform": { "position": ["(ctx.coreWidth + ctx.slabExpansion)/2 - 0.1", 0, "((ctx.coreDepth + ctx.slabExpansion)/ctx.panelsPerSide)/2"] }, "as": "right_odd" },
        {
          "do": "loop", "var": "i", "from": 0, "to": "ctx.floors",
          "body": [
            { "do": "clone", "params": { "id": "slab_mesh" }, "transform": { "position": [0, "i*ctx.floorHeight", 0], "rotation": [0, "i*ctx.rotationPerFloor", 0] }, "material": "floor_slab" },
            { "do": "clone", "params": { "id": "core_mesh" }, "transform": { "position": [0, "i*ctx.floorHeight", 0], "rotation": [0, "i*ctx.rotationPerFloor", 0] }, "material": "core" },
            { "do": "clone", "params": { "id": "cols_mesh" }, "transform": { "position": [0, "i*ctx.floorHeight", 0], "rotation": [0, "i*ctx.rotationPerFloor", 0] }, "material": "column" },
            { "do": "clone", "params": { "id": "front_even" }, "transform": { "position": [0, "i*ctx.floorHeight", 0], "rotation": [0, "i*ctx.rotationPerFloor", 0] }, "material": "(i % 2 === 0) ? 'wall' : 'window'" },
            { "do": "clone", "params": { "id": "front_odd" },  "transform": { "position": [0, "i*ctx.floorHeight", 0], "rotation": [0, "i*ctx.rotationPerFloor", 0] }, "material": "(i % 2 === 0) ? 'window' : 'wall'" },
            { "do": "clone", "params": { "id": "back_even" },  "transform": { "position": [0, "i*ctx.floorHeight", 0], "rotation": [0, "i*ctx.rotationPerFloor", 0] }, "material": "(i % 2 === 0) ? 'wall' : 'window'" },
            { "do": "clone", "params": { "id": "back_odd" },   "transform": { "position": [0, "i*ctx.floorHeight", 0], "rotation": [0, "i*ctx.rotationPerFloor", 0] }, "material": "(i % 2 === 0) ? 'window' : 'wall'" },
            { "do": "clone", "params": { "id": "left_even" },  "transform": { "position": [0, "i*ctx.floorHeight", 0], "rotation": [0, "i*ctx.rotationPerFloor", 0] }, "material": "(i % 2 === 0) ? 'window' : 'wall'" },
            { "do": "clone", "params": { "id": "left_odd" },   "transform": { "position": [0, "i*ctx.floorHeight", 0], "rotation": [0, "i*ctx.rotationPerFloor", 0] }, "material": "(i % 2 === 0) ? 'wall' : 'window'" },
            { "do": "clone", "params": { "id": "right_even" }, "transform": { "position": [0, "i*ctx.floorHeight", 0], "rotation": [0, "i*ctx.rotationPerFloor", 0] }, "material": "(i % 2 === 0) ? 'window' : 'wall'" },
            { "do": "clone", "params": { "id": "right_odd" },  "transform": { "position": [0, "i*ctx.floorHeight", 0], "rotation": [0, "i*ctx.rotationPerFloor", 0] }, "material": "(i % 2 === 0) ? 'wall' : 'window'" }
          ]
        }
      ]
    };

    // --- SETUP ---
    const canvas = document.querySelector('#gl');
    const renderer = new THREE.WebGLRenderer({ canvas, antialias: true, alpha: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    
    const scene = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera(45, window.innerWidth/window.innerHeight, 0.1, 1000);
    camera.position.set(60, 40, 60);
    
    const controls = new OrbitControls(camera, canvas);
    controls.enableDamping = true;

    // Lights
    scene.add(new THREE.AmbientLight(0xffffff, 0.6));
    const dirLight = new THREE.DirectionalLight(0xffffff, 1.0);
    dirLight.position.set(50, 100, 50);
    scene.add(dirLight);
    scene.add(new THREE.GridHelper(100, 20, 0x444444, 0x222222));

    // State
    let currentSchema = defaultSchema;
    let currentGeometry = null;
    const executor = new ProceduralExecutor();

    // --- FUNCTIONS ---

    window.switchTab = (tabName) => {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.content').forEach(c => c.style.display = 'none');
      document.querySelector(`.tab[onclick="switchTab('${tabName}')"]`).classList.add('active');
      document.getElementById(`tab-${tabName}`).style.display = 'block';
    }

    window.resetCamera = () => {
      camera.position.set(60, 40, 60);
      controls.target.set(0, 0, 0);
    }

    window.runSchema = () => {
      // Clear Logs
      const logContainer = document.getElementById('log-container');
      logContainer.innerHTML = '';
      
      // Hijack console.log to feed the log panel
      const oldLog = console.log;
      console.log = (...args) => {
        oldLog(...args);
        if (args[0] === 'ðŸ’­' || args[0].includes('Action')) {
          const entry = document.createElement('div');
          entry.className = 'log-entry';
          entry.innerHTML = `<span class="log-icon">âš¡</span><span class="log-text">${args.slice(1).join(' ')}</span>`;
          logContainer.appendChild(entry);
        }
      }

      if (currentGeometry) scene.remove(currentGeometry);

      // Extract Parameters from Sliders
      const params = {};
      if (currentSchema.globalParameters) {
        for (const [key, val] of Object.entries(currentSchema.globalParameters)) {
          params[key] = val.value;
        }
      }

      // Execute
      currentGeometry = executor.execute(currentSchema, params);
      scene.add(currentGeometry);

      // Restore console
      console.log = oldLog;
    }

    window.applySchemaFromText = () => {
      try {
        const text = document.getElementById('schema-input').value;
        currentSchema = JSON.parse(text);
        generateControls();
        runSchema();
      } catch (e) {
        alert("Invalid JSON: " + e.message);
      }
    }

    function generateControls() {
      const container = document.getElementById('controls-container');
      container.innerHTML = '';
      
      if (!currentSchema.globalParameters) return;

      for (const [key, param] of Object.entries(currentSchema.globalParameters)) {
        const row = document.createElement('div');
        row.className = 'param-row';
        
        const header = document.createElement('div');
        header.className = 'param-header';
        header.innerHTML = `<span>${key}</span><span id="val-${key}">${param.value}</span>`;
        
        const input = document.createElement('input');
        input.type = 'range';
        input.min = param.min;
        input.max = param.max;
        input.step = param.step || (param.type === 'integer' ? 1 : 0.1);
        input.value = param.value;
        
        input.oninput = (e) => {
          param.value = parseFloat(e.target.value);
          document.getElementById(`val-${key}`).innerText = param.value;
          runSchema();
        };

        row.appendChild(header);
        row.appendChild(input);
        container.appendChild(row);
      }
    }

    // Initialize
    document.getElementById('schema-input').value = JSON.stringify(defaultSchema, null, 2);
    generateControls();
    runSchema();

    function animate() {
      requestAnimationFrame(animate);
      controls.update();
      renderer.render(scene, camera);
    }
    animate();

    window.onresize = () => {
      camera.aspect = window.innerWidth/window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight);
    }
  </script>
</body>
</html>
