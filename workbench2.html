<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spellshape - Procedural Timeline Editor</title>

    <script type="importmap">
    {
        "imports": {
            "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js",
            "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/"
        }
    }
    </script>

    <style>
        :root {
            --bg: #121214;
            --panel: #1c1c21;
            --card: #25252b;
            --card-hover: #2d2d33;
            --border: #333;
            --accent: #646cff;
            --text: #ececec;
            --text-dim: #888;
            --success: #4ade80;
            --error: #ff6464;
        }

        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            overflow: hidden;
            background: var(--bg);
            font-family: Inter, system-ui, sans-serif;
            color: var(--text);
        }

        .app {
            display: flex;
            height: 100vh;
            width: 100vw;
        }

        .sidebar {
            flex: 0 0 500px;
            width: 500px;
            background: var(--panel);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            z-index: 10;
        }

        .header {
            padding: 16px 20px;
            border-bottom: 1px solid var(--border);
            background: var(--bg);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            margin: 0;
            font-size: 14px;
            font-weight: 700;
            flex: 1;
        }

        .view-controls {
            display: flex;
            gap: 4px;
            align-items: center;
        }

        .view-btn {
            width: 24px;
            height: 24px;
            background: rgba(100, 108, 255, 0.2);
            border: 1px solid transparent;
            border-radius: 3px;
            color: var(--text-dim);
            cursor: pointer;
            font-size: 11px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .view-btn.active {
            background: rgba(100, 108, 255, 0.4);
            color: var(--accent);
            border-color: var(--accent);
        }

        .view-btn:hover {
            background: rgba(100, 108, 255, 0.3);
        }

        .tabs {
            display: flex;
            padding: 0 20px;
            border-bottom: 1px solid var(--border);
            gap: 12px;
            overflow-x: auto;
        }

        .tab {
            padding: 10px 0;
            font-size: 10px;
            font-weight: 600;
            color: var(--text-dim);
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
            white-space: nowrap;
        }

        .tab.active {
            color: var(--accent);
            border-bottom-color: var(--accent);
        }

        .tab:hover {
            color: #fff;
        }

        .content {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            display: none;
        }

        .content.active {
            display: block;
        }

        .globals-container {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .global-group {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 12px;
        }

        .global-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            color: var(--text-dim);
        }

        .btn-add-global {
            width: 20px;
            height: 20px;
            background: rgba(100, 108, 255, 0.2);
            border: none;
            border-radius: 3px;
            color: var(--accent);
            cursor: pointer;
            font-weight: bold;
        }

        .btn-add-global:hover {
            background: rgba(100, 108, 255, 0.4);
        }

        .global-item {
            display: flex;
            gap: 8px;
            margin-bottom: 8px;
            align-items: center;
        }

        .global-slider-group {
            display: flex;
            flex-direction: column;
            gap: 4px;
            margin-top: 8px;
        }

        .slider-header {
            display: flex;
            justify-content: space-between;
            font-size: 10px;
            color: var(--text-dim);
        }

        .slider-value {
            color: var(--accent);
        }

        input[type="range"] {
            width: 100%;
            height: 4px;
            border-radius: 2px;
            background: var(--border);
            outline: none;
            -webkit-appearance: none;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--accent);
            cursor: pointer;
        }

        input[type="range"]::-moz-range-thumb {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--accent);
            cursor: pointer;
            border: none;
        }

        input[type="text"],
        input[type="number"],
        select {
            width: 100%;
            padding: 6px 8px;
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 3px;
            color: var(--text);
            font-size: 12px;
            font-family: inherit;
        }

        input[type="text"]:focus,
        input[type="number"]:focus,
        select:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 2px rgba(100, 108, 255, 0.2);
        }

        label {
            font-size: 11px;
            font-weight: 600;
            color: var(--text-dim);
            display: block;
            margin-bottom: 4px;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 4px;
            margin-bottom: 10px;
        }

        .btn {
            padding: 8px 12px;
            background: rgba(100, 108, 255, 0.3);
            border: 1px solid var(--accent);
            border-radius: 4px;
            color: var(--accent);
            cursor: pointer;
            font-size: 11px;
            font-weight: 600;
            transition: all 0.2s;
        }

        .btn:hover {
            background: rgba(100, 108, 255, 0.5);
        }

        .btn.primary {
            background: var(--accent);
            color: var(--bg);
        }

        .btn.primary:hover {
            background: #7c84ff;
        }

        .btn.danger {
            background: rgba(255, 100, 100, 0.3);
            border-color: var(--error);
            color: var(--error);
        }

        .btn.danger:hover {
            background: rgba(255, 100, 100, 0.5);
        }

        .canvas-container {
            flex: 1;
            position: relative;
            background: #0a0a0c;
        }

        #canvas {
            width: 100%;
            height: 100%;
            display: block;
        }

        .status-bar {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0, 0, 0, 0.8);
            padding: 8px 16px;
            font-size: 11px;
            color: var(--text-dim);
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
        }

        .status-item {
            display: flex;
            gap: 8px;
        }

        .spinner {
            width: 12px;
            height: 12px;
            border: 2px solid var(--border);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .action-item {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 4px;
            padding: 8px;
            margin-bottom: 8px;
            font-size: 11px;
        }

        .action-title {
            font-weight: 600;
            color: var(--accent);
            margin-bottom: 4px;
        }

        .action-params {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .param-row {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .param-label {
            flex: 0 0 80px;
            color: var(--text-dim);
        }

        .param-input {
            flex: 1;
        }

        .btn-remove {
            width: 20px;
            height: 20px;
            background: rgba(255, 100, 100, 0.2);
            border: none;
            border-radius: 2px;
            color: var(--error);
            cursor: pointer;
            font-size: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .btn-remove:hover {
            background: rgba(255, 100, 100, 0.4);
        }
    </style>
</head>
<body>
    <div class="app">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="header">
                <h1>ðŸ”® Spellshape</h1>
                <div class="view-controls">
                    <button class="view-btn active" data-view="schema" title="Schema">S</button>
                    <button class="view-btn" data-view="actions" title="Actions">A</button>
                </div>
            </div>

            <div class="tabs">
                <div class="tab active" data-tab="globals">Globals</div>
                <div class="tab" data-tab="materials">Materials</div>
                <div class="tab" data-tab="schema">Schema</div>
            </div>

            <!-- GLOBALS TAB -->
            <div class="content active" id="tab-globals">
                <div class="globals-container" id="globals-container"></div>
                <button class="btn primary" style="width: 100%;">+ Add Global</button>
            </div>

            <!-- MATERIALS TAB -->
            <div class="content" id="tab-materials">
                <div id="materials-container"></div>
                <button class="btn primary" style="width: 100%;">+ Add Material</button>
            </div>

            <!-- SCHEMA TAB -->
            <div class="content" id="tab-schema">
                <div class="control-group">
                    <label>Version</label>
                    <input type="number" id="schema-version" value="4.0" min="3.0" step="0.1">
                </div>

                <div class="control-group">
                    <label>Intent</label>
                    <input type="text" id="schema-intent" placeholder="Describe the generation...">
                </div>

                <div class="control-group">
                    <label>Actions</label>
                    <div id="actions-container"></div>
                    <button class="btn" style="width: 100%;">+ Add Action</button>
                </div>

                <div style="display: flex; gap: 8px; margin-top: 16px;">
                    <button class="btn primary" style="flex: 1;" id="btn-generate">Generate</button>
                    <button class="btn" style="flex: 1;" id="btn-clear">Clear</button>
                </div>
            </div>
        </div>

        <!-- 3D Canvas -->
        <div class="canvas-container">
            <canvas id="canvas"></canvas>
            <div class="status-bar">
                <div class="status-item">
                    <span id="status-text">Ready</span>
                </div>
                <div class="status-item" id="status-spinner" style="display: none;">
                    <div class="spinner"></div>
                    <span>Generating...</span>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        import { ProceduralExecutor } from './src/modules/interpreter/procedural-executor.js';

        // =========================================================================
        // 1. IMPORT HELPERS REGISTRY (v2)
        // =========================================================================
        // NOTE: This assumes helpers_registry_complete-2.json is in the same directory
        // Adjust the path if needed
        const helpersRegistryResponse = await fetch('./src/modules/interpreter/helpers_registry.json');
        const helpersRegistry = await helpersRegistryResponse.json();
        console.log(`âœ… Loaded ${helpersRegistry.length} helpers from registry`);
        

        // =========================================================================
        // 3. REGISTER HELPERS FROM JSON REGISTRY
        // =========================================================================
        function registerJSONHelpers(executor, registry) {
            const definitions = {};

            registry.forEach(entry => {
                if (entry.id && entry.code) {
                    definitions[entry.id] = { code: entry.code };
                }
            });

            executor.registerDynamicHelpers(definitions);
            console.log(`âœ… Registered ${Object.keys(definitions).length} helpers from JSON registry`);
        }

        // =========================================================================
        // 4. THREE.JS SCENE SETUP
        // =========================================================================
        const canvas = document.getElementById('canvas');
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x0a0a0c);

        const camera = new THREE.PerspectiveCamera(
            75,
            canvas.clientWidth / canvas.clientHeight,
            0.1,
            10000
        );
        camera.position.set(0, 0, 5);

        const renderer = new THREE.WebGLRenderer({ canvas, antialias: true });
        renderer.setSize(canvas.clientWidth, canvas.clientHeight);
        renderer.setPixelRatio(window.devicePixelRatio);

        const controls = new OrbitControls(camera, canvas);
        controls.enableDamping = true;
        controls.dampingFactor = 0.05;

        // Lights
        const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
        scene.add(ambientLight);

        const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
        directionalLight.position.set(5, 10, 7);
        scene.add(directionalLight);

        // =========================================================================
        // 5. EXECUTOR INITIALIZATION
        // =========================================================================
        const executor = new ProceduralExecutor(scene);
        registerJSONHelpers(executor, helpersRegistry);

        // =========================================================================
        // 6. UI STATE & HANDLERS
        // =========================================================================
        let currentGroup = null;
        const statusText = document.getElementById('status-text');
        const statusSpinner = document.getElementById('status-spinner');

        function updateStatus(message, isLoading = false) {
            statusText.textContent = message;
            statusSpinner.style.display = isLoading ? 'flex' : 'none';
        }

        document.getElementById('btn-generate').addEventListener('click', async () => {
            updateStatus('Generating...', true);

            try {
                const schema = {
                    version: parseFloat(document.getElementById('schema-version').value),
                    intent: document.getElementById('schema-intent').value || 'Generated',
                    actions: [
                        {
                            do: 'createSphere',
                            params: { radius: 1.5, widthSegments: 32, heightSegments: 16 },
                            as: 'sphere'
                        }
                    ]
                };

                // Clear old group
                if (currentGroup) scene.remove(currentGroup);

                // Execute schema
                currentGroup = executor.execute(schema, {});
                scene.add(currentGroup);

                updateStatus(`âœ… Generated: ${schema.intent}`);
            } catch (error) {
                console.error('Generation error:', error);
                updateStatus(`âŒ Error: ${error.message}`);
            }
        });

        document.getElementById('btn-clear').addEventListener('click', () => {
            if (currentGroup) {
                scene.remove(currentGroup);
                currentGroup = null;
            }
            updateStatus('Cleared');
        });

        // Tab switching
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                const tabName = tab.dataset.tab;
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.content').forEach(c => c.classList.remove('active'));

                tab.classList.add('active');
                document.getElementById(`tab-${tabName}`).classList.add('active');
            });
        });

        // =========================================================================
        // 7. ANIMATION LOOP
        // =========================================================================
        function animate() {
            requestAnimationFrame(animate);
            controls.update();
            renderer.render(scene, camera);
        }
        animate();

        // Handle window resize
        window.addEventListener('resize', () => {
            camera.aspect = canvas.clientWidth / canvas.clientHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(canvas.clientWidth, canvas.clientHeight);
        });

        updateStatus('Ready');
    </script>
</body>
</html>