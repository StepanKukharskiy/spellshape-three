<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Spellshape Three Dev</title>
  <style>
    body {
      margin: 0;
      overflow: hidden;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }

    .container {
      flex: 1;
      width: 100%;
      display: flex;
    }

    canvas {
      display: block;
      flex: 1;
      width: 100%;
      height: 100%;
    }

    .controls {
      z-index: 2;
      position: absolute;
      top: 10px;
      right: 10px;
    }
  </style>
</head>

<body>
  <div class="container">
    <canvas id="canvas"></canvas>

    <div class="controls">
      <div class="control-item">
        <label>Width (0.1 - 5.0m)</label>
        <input type="range" id="cube_width" min="0.1" max="5" step="0.01" value="3">
        <span class="value-display" id="width_display">1.00m</span>
      </div>
    </div>
  </div>

  <div id="validation-panel"
    style="position: absolute; top: 10px; left: 10px; background: rgba(255,0,0,0.8); color: white; padding: 10px; display: none;">
  </div>
  <script type="module">
    import { start } from './src/index.js';

    // Example schema for testing
    const testSchema = {
  "version": "3.1",
  "type": "parametric_scene",
  "children": [{
    "type": "parametric_template",
    "id": "star_tower",
    "parameters": {
      "floors": {"value": 30, "type": "integer", "min": 10, "max": 50, "step": 1, "group": "tower"},
      "floor_height": {"value": 3.0, "type": "number", "min": 2.5, "max": 4.0, "step": 0.1, "group": "tower"},
      "star_diameter": {"value": 20.0, "type": "number", "min": 10.0, "max": 30.0, "step": 1.0, "group": "form"},
      "offset_distance": {"value": 3.0, "type": "number", "min": 1.0, "max": 5.0, "step": 0.5, "group": "form"},
      "twist_per_floor": {"value": 3.0, "type": "number", "min": 0.0, "max": 10.0, "step": 0.5, "group": "rotation"},
      "wave_amplitude": {"value": 0.8, "type": "number", "min": 0.0, "max": 2.0, "step": 0.1, "group": "facade"},
      "wave_frequency": {"value": 1.0, "type": "number", "min": 0.1, "max": 3.0, "step": 0.1, "group": "facade"},
      "core_width": {"value": 5.0, "type": "number", "min": 3.0, "max": 8.0, "step": 0.5, "group": "core"},
      "core_depth": {"value": 3.0, "type": "number", "min": 2.0, "max": 5.0, "step": 0.5, "group": "core"}
    },
    "expressions": {
      "slab_thickness": "0.3",
      "glass_height": "$floor_height - 0.4",
      "star_radius": "$star_diameter/2",
      "star_points": "5",
      "star_inner_radius": "$star_radius * 0.4"
    },
    "template": [{
      "type": "repeat",
      "id": "floor_repeat",
      "count": "$floors",
      "instance_parameters": {
        "floor": "$index",
        "progress": "$floor / max(($floors - 1), 1)",
        "rotation_angle": "$floor * $twist_per_floor * pi / 180",
        "wave_offset": "sin($progress * $wave_frequency * 2 * pi) * $wave_amplitude"
      },
      "distribution": {"type": "linear", "axis": "y", "start": "$floor_height/2", "step": "$floor_height"},
      "children": [{
        "type": "group",
        "id": "floor_group",
        "rotation": [0, "$rotation_angle", 0],
        "children": [{
          "type": "extrude",
          "id": "star_slab",
          "material": "concrete_mat",
          "dimensions": {
            "outer": [{
              "kind": "polygon",
              "cx": 0,
              "cy": 0,
              "r": "$star_radius",
              "sides": "$star_points",
              "rotation": "pi/2"
            }],
            "holes": [[{
              "kind": "polygon",
              "cx": 0,
              "cy": 0,
              "r": "$star_inner_radius",
              "sides": "$star_points",
              "rotation": "pi/2"
            }]],
            "options": {"depth": "$slab_thickness"}
          },
          "position": ["$offset_distance", 0, 0], 
          "rotation": ["-pi/2", 0, 0]
        },
        {
          "type": "extrude",
          "id": "glass_facade",
          "material": "glass_mat",
          "rotation": ["pi/2", 0, 0],
          "dimensions": {
            "outer": [{
              "kind": "polygon",
              "cx": "$offset_distance",
              "cy": 0,
              "r": "$star_radius",
              "sides": "$star_points",
              "rotation": "pi/2"
            }],
            "holes": [[{
              "kind": "polygon",
              "cx": "$offset_distance",
              "cy": 0,
              "r": "$star_inner_radius",
              "sides": "$star_points",
              "rotation": "pi/2"
            }]],
            "options": {"depth": "$glass_height"}
          },
          "position": ["$offset_distance + $wave_offset", "-$slab_thickness", 0]
        },
        {
          "type": "box",
          "id": "core",
          "material": "concrete_mat",
          "dimensions": ["$core_width", "$slab_thickness", "$core_depth"],
          "position": [0, 0, 0]
        }]
      }]
    }]
  }],
  "materials": {
    "concrete_mat": {"type": "standard", "color": "cccccc", "roughness": 0.7, "metalness": 0.1},
    "glass_mat": {"type": "standard", "color": "aaddff", "roughness": 0.1, "metalness": 0.3, "transparent": true, "opacity": 0.8}
  },
  "ui_controls": {
    "groups": {
      "tower": {"label": "🏢 Tower", "order": 1, "default_open": true},
      "form": {"label": "⭐ Form", "order": 2, "default_open": true},
      "rotation": {"label": "🌀 Rotation", "order": 3, "default_open": true},
      "facade": {"label": "🌊 Facade", "order": 4, "default_open": true},
      "core": {"label": "🟦 Core", "order": 5, "default_open": true}
    }
  }
}
    // Wait for DOM to be fully loaded
    document.addEventListener('DOMContentLoaded', async () => {
      const canvas = document.getElementById('canvas');
      let viewer = null;

      // Initialize the viewer
      async function initViewer() {
        try {
          viewer = await start(canvas, testSchema, false);
          console.log('Viewer initialized:', viewer);

          // Check if updateParameter is available
          if (viewer.updateParameter) {
            console.log('✅ updateParameter function is available');
          } else {
            console.error('❌ updateParameter function is NOT available');
          }
        } catch (error) {
          console.error('Error initializing viewer:', error);
        }
      }

      // Setup the single control
      function setupControl() {
        const heightInput = document.getElementById('cube_width');
        const heightDisplay = document.getElementById('width_display');

        // Check if elements exist
        if (!heightInput) {
          console.error('Height input element not found!');
          return;
        }
        if (!heightDisplay) {
          console.error('Height display element not found!');
          return;
        }

        console.log('✅ Control elements found, setting up event listener');

        heightInput.addEventListener('input', (e) => {
          const value = parseFloat(e.target.value);

          // Update the 3D model using selective regeneration
          if (viewer && viewer.updateParameter) {
            const success = viewer.updateParameter('cube_width', value);
            console.log(`Updated cube_width to ${value}: ${success ? 'Success' : 'Failed'}`);
          } else {
            console.error('updateParameter function not available');
          }

          // Update the display
          heightDisplay.textContent = value.toFixed(2) + 'm';
        });

        console.log('✅ Event listener attached successfully');
      }

      // Initialize everything in proper order
      await initViewer();
      setupControl();

      console.log('🚀 Ready! Drag the slider to test updateParameter function.');
    });
  </script>
</body>

</html>